<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking</title>
  <link rel="icon" href="cooking.png">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f9f9f9;
    color: #333;
  }

  #global-status {
    position: relative;
    margin: 12px auto 6px;
    text-align: center;
    width: fit-content;
    padding: 8px 16px;
    background: #fcfcfc;
    border-radius: 8px;
    border: 1px solid #bbb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    font-weight: bold;
    color: #222;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #pauseButton {
    padding: 6px 12px;
    font-size: 14px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #pauseButton:hover {
    background-color: #45a049;
  }

  #tabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background-color: #ffffff;
    padding: 8px;
    gap: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  #tabs button {
    background-color: #f5f5f5;
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 15px;
    cursor: pointer;
    color: #333;
    transition: background-color 0.2s, color 0.2s;
    flex: 1 0 auto;
    min-width: 90px;
    position: relative;
  }

  #tabs button:hover {
    background-color: #ebebeb;
  }

  #tabs button.active-tab {
    background-color: #e0f2e9;
    font-weight: bold;
    color: #2d7a4d;
    border: 1px solid #4CAF50;
  }

  #tabs button .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #f44336;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .tab-content {
    display: none;
    padding: 20px;
    max-width: 800px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .tab-content.active {
    display: block;
  }

  #achievements-subtabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background-color: #f8f8f8;
    padding: 8px;
    gap: 6px;
    margin-bottom: 20px;
    border-radius: 6px;
  }

  #achievements-subtabs button {
    background-color: #e8e8e8;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: #333;
    transition: background-color 0.2s, color 0.2s;
    flex: 1 0 auto;
    min-width: 80px;
  }

  #achievements-subtabs button:hover {
    background-color: #d8d8d8;
  }

  #achievements-subtabs button.active-subtab {
    background-color: #d0e8db;
    font-weight: bold;
    color: #2d7a4d;
    border: 1px solid #4CAF50;
  }

  h2 {
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
    margin-bottom: 15px;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }

  select,
  input[type="number"],
  input[type="checkbox"] {
    padding: 8px 12px;
    margin-bottom: 10px;
    font-size: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box;
  }

  button {
    padding: 10px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    margin: 5px 0;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background-color: #45a049;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .delete-button {
    background-color: #f44336;
  }

  .delete-button:hover {
    background-color: #d32f2f;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  ul li {
    padding: 8px 12px;
    background-color: #f4f4f4;
    border-radius: 6px;
    margin-bottom: 6px;
    border: 1px solid #ddd;
    font-size: 15px;
  }

  #achievementList li.achieved {
    background-color: #c8e6c9;
    border: 1px solid #4CAF50;
  }

  #achievementList li.unachieved {
    background-color: #e0e0e0;
    border: 1px solid #ccc;
    color: #666;
  }

  #ingredientInfo {
    background-color: #e8f5e9;
    padding: 10px 14px;
    border-left: 4px solid #4CAF50;
    margin: 10px 0;
    border-radius: 6px;
    font-size: 14px;
  }

  #saveStatus {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
    transition: opacity 0.3s ease;
  }

  #saveStatus.success {
    background-color: #e8f5e9;
    border-left: 4px solid #4CAF50;
    display: block;
  }

  #saveStatus.error {
    background-color: #ffebee;
    border-left: 4px solid #f44336;
    display: block;
  }

  .settings-group {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .settings-group p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #555;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #pauseModal, #deleteConfirmModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #pauseModal > div, #deleteConfirmModal > div {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  @media (min-width: 481px) {
    .button-group {
      flex-direction: row;
    }

    button {
      width: auto;
    }

    select,
    input[type="number"],
    input[type="checkbox"] {
      width: auto;
    }
  }

  @media (max-width: 480px) {
    #global-status {
      flex-direction: column;
      align-items: flex-start;
    }

    #tabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: auto;
      gap: 6px;
    }

    #achievements-subtabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
  }

  #shop-subtabs button.active-subtab {
  background-color: #4CAF50;
  color: white;
}
#shop-subtabs button {
  margin-right: 5px;
}
</style>
</head>
<body>
  <div id="global-status">
    所持金: <span id="money">100</span>G | 経験値: <span id="xp">0</span>XP | 評判: <span id="rp">5.00</span>RP | 電力: <span id="ep">0</span>EP
    <button id="pauseButton" onclick="togglePause(true)">⏸</button>
  </div>

  <div id="gameTime">
    日付: 0日 0時 0分
  </div>

  <div id="currentWeather">
    天候: 晴れ
  </div>

  <div id="tabs">
    <button id="tab-farm" onclick="showTab('farm')">🌱 農業</button>
    <button id="tab-cook" onclick="showTab('cook')">🍳 料理</button>
    <button id="tab-shop" onclick="showTab('shop')">🏪 販売</button>
    <button id="tab-quest" onclick="showTab('quest')">📜 クエスト</button>
    <button id="tab-market" onclick="showTab('market')">🛒 ショップ</button>
    <button id="tab-machines" onclick="showTab('machines')">🚜 農機</button>
    <button id="tab-power" onclick="showTab('power')">⚡️ 電力</button>
    <button id="tab-management" onclick="showTab('management')">💼 経営</button>
    <button id="tab-achievements" onclick="showTab('achievements')">🌟 進捗</button>
    <button id="tab-settings" onclick="showTab('settings')">⚙️ 設定</button>
  </div>

  <div id="farm" class="tab-content active">
    <h2>🌱 農業</h2>
    <label>作物を選ぶ:</label>
    <select id="cropSelect"></select>
    <button onclick="plantCrop()">種をまく（10G）</button>
    <p>土地の広さ: <span id="landSize">5</span> / 現在の作物数: <span id="cropCount">0</span></p>
    <ul id="crops"></ul>
    <h3>📦 収穫箱</h3>
    <ul id="harvestBox"></ul>
  </div>

  <div id="cook" class="tab-content">
    <h2>🍳 料理</h2>
    <label>レシピを選ぶ:</label>
    <select id="recipeSelect"></select>
    <button onclick="cook()">調理</button>
    <div id="ingredientInfo"></div>
    <h3>📦 収穫箱</h3>
    <ul id="harvestBoxCook"></ul>
    <h3>🍽️ 料理在庫</h3>
    <ul id="dishInventory"></ul>
  </div>

<div id="shop" class="tab-content">
  <h2>🏪 販売</h2>
  <div id="shop-subtabs"></div>
  <div id="shop-content"></div>
</div>

  <div id="quest" class="tab-content">
    <h2>📜 クエスト</h2>
    <ul id="questList"></ul>
    <ul id="quests"></ul>
  </div>

  <div id="market" class="tab-content">
    <h2>🛒 ショップ</h2>
    <button id="land" onclick="buyLand()">土地拡張（100G + α）</button>
    <button id="toolWateringCan" onclick="buyTool('ジョウロ')" disabled>ジョウロ購入（150G）- 100XP必要</button>
    <button id="toolAutoPlanterCabbage" onclick="buyTool('種まき機キャベツ号')" disabled>種まき機キャベツ号購入（3000G）- 700XP必要</button>
    <button id="toolAutoPlanterTomato" onclick="buyTool('種まき機トマト号')" disabled>種まき機トマト号購入（4000G）- 1200XP必要</button>
    <button id="toolAutoPlanterCarrot" onclick="buyTool('種まき機ニンジン号')" disabled>種まき機ニンジン号購入（5000G）- 1600XP必要</button>
    <button id="toolAutoPlanterPotato" onclick="buyTool('種まき機ポテト号')" disabled>種まき機ポテト号購入（7000G）- 2400XP必要</button>
    <button id="buyPower" onclick="buyPower()" disabled>電力購入（100EP / 200G）- 700XP必要</button>
    <button id="cropTomato" onclick="buyCrop('トマト')" disabled>トマトの種（100G）- 200XP必要</button>
    <button id="recipeSalad" onclick="buyRecipe('トマトサラダ')" disabled>レシピ本『トマトサラダ』（200G）- 200XP必要</button>
    <button id="cropCarrot" onclick="buyCrop('ニンジン')" disabled>ニンジンの種（150G）- 400XP必要</button>
    <button id="recipeCarrot" onclick="buyRecipe('焼きニンジン')" disabled>レシピ本『焼きニンジン』（200G）- 400XP必要</button>
    <button id="cropPotato" onclick="buyCrop('ポテト')" disabled>ポテトの種（300G）- 800XP必要</button>
  </div>

  <div id="machines" class="tab-content">
    <h2>🚜 農機</h2>
    <h3>種まき機の稼働設定</h3>
    <div id="planterControls"></div>
  </div>

  <div id="power" class="tab-content">
    <h2>⚡️ 電力</h2>
    <p>電力購入はショップタブから行えます。</p>
    <p>将来の発電機能はこちらで管理予定です。</p>
  </div>

<div id="management" class="tab-content">
  <h2>💼 経営</h2>
  <div id="managementDashboard">
    <p>総収益: <span id="totalRevenue">0</span>G</p>
    <p>総支出: <span id="totalCost">0</span>G</p>
    <p>土地サイズ: <span id="landSizeManagement">5</span></p>
    <p>店舗数: <span id="storeCount">1</span></p>
    <button id="land" onclick="buyLand()">土地拡張（<span id="landCost">100</span>G）</button>
    <button id="openStore" onclick="openStore()">新店舗開設（500000G）</button>
    <button id="installAutoSeller" onclick="installAutoSeller()">自動販売機設置（100000G）</button>
    <button id="startCampaign" onclick="startCampaign()">広告キャンペーン（500Gで販売/クエスト間隔20%短縮、5分間）</button>
  </div>
</div>

  <div id="achievements" class="tab-content">
    <h2>🌟 進捗</h2>
    <p>XPを貯めて報酬を獲得！特別なプレゼントで農場をパワーアップ！</p>
    <div id="achievements-subtabs">
      <button id="subtab-farming" onclick="showSubTab('farming')">農業</button>
      <button id="subtab-cooking" onclick="showSubTab('cooking')">料理</button>
      <button id="subtab-sales" onclick="showSubTab('sales')">販売</button>
      <button id="subtab-quests" onclick="showSubTab('quests')">クエスト</button>
      <button id="subtab-market" onclick="showSubTab('market')">ショップ</button>
      <button id="subtab-machines" onclick="showSubTab('machines')">農機</button>
      <button id="subtab-power" onclick="showSubTab('power')">電力</button>
      <button id="subtab-management" onclick="showSubTab('management')">経営</button>
    </div>
    <ul id="achievementList"></ul>
  </div>

  <div id="settings" class="tab-content">
    <h2>⚙️ 設定</h2>
    <div class="settings-group">
      <h3>保存と読み込み</h3>
      <div class="button-group">
        <button onclick="saveGame()">ゲームを保存</button>
        <button onclick="loadGame()">ゲームを読み込む</button>
        <button class="delete-button" onclick="showDeleteConfirm()">セーブデータを削除</button>
      </div>
    </div>
    <div class="settings-group">
      <h3>自動保存設定</h3>
      <p>ゲームの進行状況を定期的に自動保存します。</p>
      <label for="autoSaveEnabled">自動保存を有効にする:</label>
      <input type="checkbox" id="autoSaveEnabled" onchange="toggleAutoSave(); saveSettings()">
      <label for="autoSaveInterval">自動保存間隔（秒、5以上）:</label>
      <input type="number" id="autoSaveInterval" min="5" value="10" onchange="updateAutoSaveInterval(); saveSettings()">
    </div>
    <div class="settings-group">
      <h3>自動読み込み設定</h3>
      <p>ページを開いたときに保存データを自動的に読み込みます。</p>
      <label for="autoLoadEnabled">ページ読み込み時に自動復元:</label>
      <input type="checkbox" id="autoLoadEnabled" onchange="toggleAutoLoad()">
    </div>
    <div id="saveStatus"></div>
  </div>

  <div id="pauseModal" style="display: none;">
    <div>
      <h2>ゲームを一時停止中</h2>
      <p>すべての進行が停止しています。<br>ゆっくり休憩してください。</p>
      <p id="version">バージョン: 2.5.9</p>
      <div class="button-group">
        <button onclick="togglePause(true)">ゲームを再開</button>
        <button onclick="window.open('https://github.com/suzurainshade/cooking/', '_blank')">GitHubへ</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" style="display: none;">
    <div>
      <h2>セーブデータ削除の確認</h2>
      <p>セーブデータを削除しますか？<br>この操作は取り消せません。</p>
      <div class="button-group">
        <button onclick="deleteSaveData()">削除する</button>
        <button onclick="cancelDelete()">キャンセル</button>
      </div>
    </div>
  </div>

<script>
const version = '2.5.9';

// 4. 品質選択の拡張用空関数
function onQualitySelection(type, quality, context) {
  // 品質選択時のイベント（例：RP変動、お礼）はここに追加
  // context: 'shelf'（棚に並べる）または 'quest'（クエスト納品）
}

function rearrangeGlobalStatusForMobile() {
  const isMobile = window.innerWidth <= 480;
  const container = document.getElementById('global-status');

  if (!container.dataset.originalHtml) {
    container.dataset.originalHtml = container.innerHTML;
  }

  if (isMobile) {
    container.innerHTML = `
      <div style="display: flex; gap: 12px;">
        <span>所持金: <span id="money">100</span>G</span>
        <span>経験値: <span id="xp">0</span>XP</span>
      </div>
      <div style="display: flex; gap: 12px;">
        <span>評判: <span id="rp">5.00</span>RP</span>
        <span>電力: <span id="ep">0</span>EP</span>
      </div>
      <button id="pauseButton" onclick="togglePause(true)">⏸</button>
    `;
  } else {
    container.innerHTML = container.dataset.originalHtml;
  }
}

window.addEventListener('load', rearrangeGlobalStatusForMobile);
window.addEventListener('resize', rearrangeGlobalStatusForMobile);

let money = 100;
let xp = 0;
let rp = 5.0;
let ep = 0;
let landSize = 5;
let crops = [];
let harvestBox = {};
let dishInventory = {};
let shelf = [];
let shelves = {'0':[]};
let currentStoreId = '0';
let storeCount = 1;
let autoSellers = 0;
let autoSellerActive = true;
let sellIntervalReduction = 1;
let landExpansions= 0;
let quests = [];
let tools = { 'ジョウロ': 0, '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
let activePlanters = { '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
let unlockedCrops = ['キャベツ'];
let unlockedRecipes = ['焼きキャベツ'];
let growthBonus = 0;
let seasonings = {};
let advancedInventory = [];
let currentAdvancedRecipe = null;
let currentAdvancedSteps = [];
let autoSaveEnabled = true;
let autoSaveInterval = 10000;
let autoLoadEnabled = true;
let autoSaveTimer = null;
let purchasedItems = new Set();
let newQuestAvailable = false;
let lastPowerConsumption = Date.now();
let isPaused = false;
let questTimer = null;
let newAchievementAvailable = false;
let currentSubTab = 'farming';
let harvestCounts = { 'キャベツ': 0, 'トマト': 0, 'ニンジン': 0, 'ポテト': 0 };
let cookCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
let saleCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
let questCompleteCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
let totalQuestCompletes = 0;
let planterUses = { '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
let shopPurchaseCounts = { 'ジョウロ': 0, '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0, '電力購入': 0, 'トマト': 0, 'トマトサラダ': 0, 'ニンジン': 0, '焼きニンジン': 0, 'ポテト': 0 };
let totalPowerConsumed = 0;
let pauseStartTime = null;
let pauseDuration = 0;
let nextQuestTime = null;
let questtimerStart = null;
const MAX_QUESTS = 100; // クエスト数の上限
// 1. グローバル変数の追加（ゲーム内時間、天候、品質）
let gameTime = { days: 0, hours: 0, minutes: 0 }; // ゲーム内時間
let lastGameTimeUpdate = Date.now();
let currentWeather = '晴れ'; // 現在の天候
let previousWeather = null; // 前日の天候
let weatherHistory = []; // 天候履歴（前日まで）
let currentSeason = '春'; // 現在の季節
let lastWeatherUpdate = 0; // 最後の天候更新時刻
let pauseStartGameTimeUpdate = 0; // ポーズ開始時のゲーム時間基準
let activeTab = 'farming';
// グローバル変数に追加（既存の変数宣言のセクションに）
let selectedQualities = {}; // 例: { '0': '高品質', '1': '普通' }

let achievements = [
  // 農業（収穫関連）
  { id: 'harvestCabbage', name: 'キャベツマスター', category: 'farming', harvest: { crop: 'キャベツ', count: 20 }, reward: { gold: 100, items: { 'キャベツ': 10 } }, achieved: false, claimed: false },
  { id: 'harvestTomato', name: 'トマトマスター', category: 'farming', harvest: { crop: 'トマト', count: 15 }, reward: { gold: 150, items: { 'トマト': 5 } }, achieved: false, claimed: false },
  // 料理
  { id: 'cookCabbage', name: 'キャベツシェフ', category: 'cooking', cook: { recipe: '焼きキャベツ', count: 10 }, reward: { gold: 100, items: { 'キャベツ': 5 } }, achieved: false, claimed: false },
  { id: 'cookSalad', name: 'サラダ職人', category: 'cooking', cook: { recipe: 'トマトサラダ', count: 5 }, reward: { gold: 150, items: { 'トマト': 3, 'キャベツ': 3 } }, achieved: false, claimed: false },
  { id: 'cookCarrot', name: 'ニンジンシェフ', category: 'cooking', cook: { recipe: '焼きニンジン', count: 8 }, reward: { gold: 120, items: { 'ニンジン': 4 } }, achieved: false, claimed: false },
  // 販売
  { id: 'saleCabbage', name: 'キャベツ販売者', category: 'sales', sales: { recipe: '焼きキャベツ', count: 10 }, reward: { gold: 100, ep: 50 }, achieved: false, claimed: false },
  { id: 'saleSalad', name: 'サラダ販売王', category: 'sales', sales: { recipe: 'トマトサラダ', count: 5 }, reward: { gold: 150, ep: 50 }, achieved: false, claimed: false },
  { id: 'saleCarrot', name: 'ニンジン販売者', category: 'sales', sales: { recipe: '焼きニンジン', count: 8 }, reward: { gold: 120, ep: 50 }, achieved: false, claimed: false },
  // クエスト
  { id: 'questCabbage', name: 'キャベツクエストマスター', category: 'quests', quest: { recipe: '焼きキャベツ', count: 3 }, reward: { gold: 100, ep: 50 }, achieved: false, claimed: false },
  { id: 'questSalad', name: 'サラダクエストマスター', category: 'quests', quest: { recipe: 'トマトサラダ', count: 2 }, reward: { gold: 150, ep: 50 }, achieved: false, claimed: false },
  { id: 'questTotal', name: 'クエスト達成者', category: 'quests', totalQuests: 5, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  // ショップ
  { id: 'shopTools', name: '道具マニア', category: 'market', shopPurchase: { items: ['ジョウロ', '種まき機キャベツ号', '種まき機トマト号'], count: 1 }, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'shopCrops', name: '作物コレクター', category: 'market', shopPurchase: { items: ['トマト', 'ニンジン', 'ポテト'], count: 1 }, reward: { gold: 200, ep: 50 }, achieved: false, claimed: false },
  { id: 'shopPower', name: '電力購入者', category: 'market', shopPurchase: { items: ['電力購入'], count: 3 }, reward: { gold: 100, ep: 150 }, achieved: false, claimed: false },
  // 農機
  { id: 'planterCabbage', name: 'キャベツ号導入', category: 'machines', planter: '種まき機キャベツ号', reward: { ep: 100, items: { 'キャベツ': 10 } }, achieved: false, claimed: false },
  { id: 'planterTomato', name: 'トマト号導入', category: 'machines', planter: '種まき機トマト号', reward: { ep: 150, items: { 'トマト': 5 } }, achieved: false, claimed: false },
  { id: 'planterUseCabbage', name: 'キャベツ自動化の達人', category: 'machines', planterUse: { planter: '種まき機キャベツ号', count: 10 }, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'planterUseTomato', name: 'トマト自動化の達人', category: 'machines', planterUse: { planter: '種まき機トマト号', count: 5 }, reward: { gold: 200, ep: 100 }, achieved: false, claimed: false },
  // 電力
  { id: 'powerConsumer', name: '電力の達人', category: 'power', power: 50, reward: { gold: 100, ep: 200 }, achieved: false, claimed: false },
  { id: 'powerHeavy', name: '電力の巨匠', category: 'power', power: 100, reward: { gold: 200, ep: 300 }, achieved: false, claimed: false },
  // 経営（XP関連）
  { id: 'xp100', name: '初級農家', category: 'management', xp: 100, reward: { gold: 50, items: { 'キャベツ': 5 } }, achieved: false, claimed: false },
  { id: 'xp300', name: '電力初心者', category: 'management', xp: 300, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'xp400', name: 'ニンジン開拓者', category: 'management', xp: 400, reward: { gold: 200, crops: ['ニンジン'] }, achieved: false, claimed: false },
  { id: 'xp800', name: 'ポテト開拓者', category: 'management', xp: 800, reward: { gold: 400, crops: ['ポテト'] }, achieved: false, claimed: false }
];

const recipeData = {
  '焼きキャベツ': {
    ingredients: { 'キャベツ': 1 },
    rewardPerDish: 25,
    sellPrice: 20
  },
  'トマトサラダ': {
    ingredients: { 'キャベツ': 1, 'トマト': 1 },
    rewardPerDish: 55,
    sellPrice: 45
  },
  '焼きニンジン': {
    ingredients: { 'ニンジン': 1 },
    rewardPerDish: 30,
    sellPrice: 25
  }
};

const unlockThresholds = {
  'ジョウロ': 100,
  'トマト': 200,
  'トマトサラダ': 200,
  'ニンジン': 400,
  '焼きニンジン': 400,
  'ポテト': 800,
  '種まき機キャベツ号': 700,
  '電力購入': 700,
  '種まき機トマト号': 1200,
  '種まき機ニンジン号': 1600,
  '種まき機ポテト号': 2400
};

let totalRevenue = 0; //総収益
let totalCost = 0; //総支出
let sellProbabilityBonus = 1; //広告キャンペーン販売確率倍率
let campaignEndTime = 0; //キャンペーン終了時刻
let powerShortage = false; //農機タブのEP不足通知用

updateUI();
loadSettings();
updateSettingsUI();
startAutoSave();
if (autoLoadEnabled) loadGame();
updateUI();

// 2. 初期化（農業タブの初期選択）
function initializeGame() {
  // 既存の初期化処理（省略）
  initializeGameTime();
  activeTab = 'farming'; // 農業タブを初期選択
  switchTab('farming'); // タブを明示的に選択
  updateUI();
}

// 5. タブ切り替え（初期選択の保証）
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = content.id === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.toggle('active', button.getAttribute('onclick') === `switchTab('${tab}')`);
  });
  updateUI();
}

// 2. 初期化（ゲーム内時間の開始）
function initializeGameTime() {
  gameTime = { days: 0, hours: 0, minutes: 0 };
  updateSeason();
  setWeather();
}

// 3. ゲーム内時間の更新（ポーズ対応）
function updateGameTime() {
  if (!isPaused) {
    const now = Date.now();
    const elapsed = now - lastGameTimeUpdate; // 実際の経過時間（ms）
    const minutesToAdd = Math.floor(elapsed / 250); // 250ms = 1分
    if (minutesToAdd > 0) {
      gameTime.minutes += minutesToAdd;
      lastGameTimeUpdate += minutesToAdd * 250; // 更新時刻を進める
      while (gameTime.minutes >= 60) {
        gameTime.minutes -= 60;
        gameTime.hours += 1;
        if (gameTime.hours >= 24) {
          gameTime.hours = 0;
          gameTime.days += 1;
          setWeather(); // 毎日天候リセット
        }
      }
      updateSeason();
      updateUI();
    }
  }
}

// 4. 季節の更新
function updateSeason() {
  const month = Math.floor((gameTime.days % 360) / 30) + 1; // 360日で1年
  if (month >= 3 && month <= 5) currentSeason = '春';
  else if (month === 6) currentSeason = '6月';
  else if (month === 7 || month === 8) currentSeason = '夏';
  else if (month >= 9 && month <= 11) currentSeason = '秋';
  else currentSeason = '冬';
}

// 5. 天候の設定
function setWeather() {
  const rand = Math.random();
  let probabilities;
  if (previousWeather === '蒸し暑い') {
    probabilities = { 雨: 0.65, 大雨: 0.35 };
  } else if ((previousWeather === '雨' || previousWeather === '大雨') && (currentSeason === '6月' ? rand < 0.65 : rand < 0.4)) {
    probabilities = { 雨: 0.65, 大雨: 0.35 };
  } else {
    if (currentSeason === '春') {
      probabilities = { 快晴: 0.30, 晴れ: 0.35, 曇り: 0.20, 蒸し暑い: 0.15 };
    } else if (currentSeason === '6月') {
      probabilities = { 快晴: 0.10, 晴れ: 0.15, 曇り: 0.25, 蒸し暑い: 0.50 };
    } else if (currentSeason === '夏') {
      probabilities = { 快晴: 0.30, 晴れ: 0.35, 曇り: 0.10, 蒸し暑い: 0.15, 台風: 0.10 };
    } else if (currentSeason === '秋') {
      probabilities = { 快晴: 0.15, 晴れ: 0.40, 曇り: 0.25, 蒸し暑い: 0.05, 台風: 0.15 };
    } else {
      probabilities = { 快晴: 0.25, 晴れ: 0.50, 曇り: 0.15, 蒸し暑い: 0.10 };
    }
  }
  let cumulative = 0;
  for (const [weather, prob] of Object.entries(probabilities)) {
    cumulative += prob;
    if (rand < cumulative) {
      weatherHistory.push(currentWeather);
      if (weatherHistory.length > 1) weatherHistory.shift(); // 前日まで保持
      currentWeather = weather;
      previousWeather = currentWeather;
      break;
    }
  }
}

// 7. 品質点数の計算
function calculateQualityScore() {
  let score = 0;
  switch (currentWeather) {
    case '快晴': case '晴れ': score += 5; break;
    case '曇り': score += 3; break;
    case '雨': score += 4; break;
    case '大雨': score += 1; break;
    case '台風': score += 0; break;
  }
  if (weatherHistory.includes('雨') || weatherHistory.includes('大雨')) {
    score += 4;
  }
  score += Math.random() * 2;
  return Math.min(score, 11); // 最大11点
}

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('#tabs button').forEach(btn => btn.classList.remove('active-tab'));
  document.getElementById(`tab-${tabId}`).classList.add('active-tab');
  if (tabId === 'settings') {
    document.getElementById('saveStatus').style.display = 'none';
    updateSettingsUI();
  }
  if (tabId === 'quest') {
    newQuestAvailable = false;
    updateTabNotifications();
  }
  if (tabId === 'machines') {
    powerShortage = false;
    updatePlanterControls();
    updateTabNotifications();
  }
  if (tabId === 'achievements') {
    newAchievementAvailable = false;
    updateAchievementList();
    updateTabNotifications();
    showSubTab(currentSubTab);
  }
  if (tabId === 'management') {
    updateManagementDashboard();
  }
  if (tabId === 'shop') {
    updateShopSubTabs();
  }
}

function showSubTab(subTabId) {
  currentSubTab = subTabId;
  document.querySelectorAll('#achievements-subtabs button').forEach(btn => {
    btn.classList.remove('active-subtab');
  });
  document.getElementById(`subtab-${subTabId}`).classList.add('active-subtab');
  updateAchievementList();
}

function addXP(amount) {
  xp += amount;
  checkAchievements();
  updateUI();
}

function openStore() {
  if (money >= 500000) {
    money -= 500000;
    totalCost += 500000;
    storeCount += 1;
    const newStoreId = (storeCount - 1).toString();
    shelves[newStoreId] = [];
    showSaveStatus(`新店舗（販売店${String.fromCharCode(65 + storeCount - 1)}）を開設しました！`, true);
    updateShopSubTabs();
    updateUI();
    updateManagementDashboard();
  } else {
    showSaveStatus('新店舗開設に必要な500000Gが不足しています。', false);
  }
}

function installAutoSeller() {
  if (money >= 100000) {
    money -= 100000;
    totalCost += 100000;
    autoSellers += 1;
    showSaveStatus(`自動販売機${autoSellers}台目を設置しました！`, true);
    updateUI();
    updateManagementDashboard();
  } else {
    showSaveStatus('自動販売機設置に必要な100000Gが不足しています。', false);
  }
}

function updateShopSubTabs() {
  const subTabs = document.getElementById('shop-subtabs');
  subTabs.innerHTML = Object.keys(shelves).map(storeId => {
    const storeName = `販売店${String.fromCharCode(65 + parseInt(storeId))}`;
    return `<button id="shop-subtab-${storeId}" onclick="showShopSubTab('${storeId}')" class="${currentStoreId === storeId ? 'active-subtab' : ''}">${storeName}</button>`;
  }).join('');
  showShopSubTab(currentStoreId);
}

// ショップサブタブの表示（品質選択ドロップダウン追加）
function showShopSubTab(storeId) {
  currentStoreId = storeId;
  document.querySelectorAll('#shop-subtabs button').forEach(btn => btn.classList.remove('active-subtab'));
  document.getElementById(`shop-subtab-${storeId}`).classList.add('active-subtab');
  const content = document.getElementById('shop-content');
  content.innerHTML = `
    <select id="sellRecipeSelect-${storeId}">
      ${unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('')}
    </select>
    <select id="qualitySelect-${storeId}">
      <!-- 品質オプションはupdateUIで動的に生成 -->
    </select>
    <button onclick="putOnShelf('${storeId}')">陳列</button>
    <p>棚の数: <span id="shelfCount-${storeId}">0</span></p>
    <ul id="shelfList-${storeId}"></ul>
  `;
  updateUI();
}



function checkAchievements() {
  let newAchievements = false;
  achievements.forEach(a => {
    if (!a.achieved) {
      if (a.xp && xp >= a.xp) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.planter && tools[a.planter] > 0) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.harvest && harvestCounts[a.harvest.crop] >= a.harvest.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.cook && cookCounts[a.cook.recipe] >= a.cook.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.sales && saleCounts[a.sales.recipe] >= a.sales.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.quest && questCompleteCounts[a.quest.recipe] >= a.quest.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.totalQuests && totalQuestCompletes >= a.totalQuests) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.shopPurchase && a.shopPurchase.items.every(item => shopPurchaseCounts[item] >= a.shopPurchase.count)) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.planterUse && planterUses[a.planterUse.planter] >= a.planterUse.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      } else if (a.power && totalPowerConsumed >= a.power) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`進捗「${a.name}」を達成！報酬を受け取ってください！`, true);
      }
    }
  });
  if (newAchievements) {
    updateTabNotifications();
  }
  updateAchievementList();
}

function claimAchievement(id) {
  const achievement = achievements.find(a => a.id === id);
  if (achievement && achievement.achieved && !achievement.claimed) {
    achievement.claimed = true;
    if (achievement.reward.gold) money += achievement.reward.gold;
    if (achievement.reward.ep) ep += achievement.reward.ep;
    if (achievement.reward.items) {
      for (const [item, count] of Object.entries(achievement.reward.items)) {
        harvestBox[item] = (harvestBox[item] || 0) + count;
      }
    }
    if (achievement.reward.crops) {
      achievement.reward.crops.forEach(crop => {
        if (!unlockedCrops.includes(crop) && !purchasedItems.has(crop)) {
          unlockedCrops.push(crop);
          purchasedItems.add(crop);
        }
      });
    }
    newAchievementAvailable = achievements.some(a => a.achieved && !a.claimed);
    showSaveStatus(`進捗「${achievement.name}」の報酬を受け取りました！`, true);
    updateAchievementList();
    updateTabNotifications();
    updateUI();
  }
}

function updateAchievementList() {
  const list = document.getElementById('achievementList');
  list.innerHTML = achievements
    .filter(a => a.category === currentSubTab)
    .map(a => {
      const conditionText = a.xp ? `${a.xp}XP` :
                           a.planter ? `${a.planter}所持` :
                           a.harvest ? `${a.harvest.crop}収穫${a.harvest.count}個` :
                           a.cook ? `${a.cook.recipe}調理${a.cook.count}回` :
                           a.sales ? `${a.sales.recipe}販売${a.sales.count}個` :
                           a.quest ? `${a.quest.recipe}クエスト${a.quest.count}回` :
                           a.totalQuests ? `クエスト${a.totalQuests}回` :
                           a.shopPurchase ? `${a.shopPurchase.items.join('、')}購入${a.shopPurchase.count}回` :
                           a.planterUse ? `${a.planterUse.planter}使用${a.planterUse.count}回` :
                           a.power ? `電力消費${a.power}EP` : '';
      const rewardText = [
        a.reward.gold ? `${a.reward.gold}G` : '',
        a.reward.ep ? `${a.reward.ep}EP` : '',
        a.reward.items ? Object.entries(a.reward.items).map(([k, v]) => `${k} x${v}`).join(', ') : '',
        a.reward.crops ? a.reward.crops.map(c => `${c}の種`).join(', ') : ''
      ].filter(t => t).join(', ');
      return `
        <li class="${a.achieved ? 'achieved' : 'unachieved'}">
          ${a.name}（${conditionText}）: ${rewardText}
          ${a.achieved && !a.claimed ? `<button onclick="claimAchievement('${a.id}')">報酬を受け取る</button>` : a.claimed ? '（受取済）' : ''}
        </li>
      `;
    }).join('');
}

function updateManagementDashboard() {
  document.getElementById('totalRevenue').textContent = totalRevenue;
  document.getElementById('totalCost').textContent = totalCost;
  document.getElementById('landSizeManagement').textContent = landSize;
  document.getElementById('storeCount').textContent = storeCount;
  document.getElementById('landCost').textContent = 100 + landSize * 10;
  const campaignButton = document.getElementById('startCampaign');
  campaignButton.disabled = money < 500 || campaignEndTime > Date.now();
  campaignButton.textContent = campaignEndTime > Date.now()
    ? `広告キャンペーン（残り${Math.ceil((campaignEndTime - Date.now()) / 1000)}秒）`
    : `広告キャンペーン（500Gで販売/クエスト間隔20%短縮、5分間）`;
}

function startCampaign() {
  if (money >= 500 && campaignEndTime <= Date.now()) {
    money -= 500;
    totalCost += 500;
    sellIntervalReduction = 0.8; // 販売/クエスト間隔20%短縮
    campaignEndTime = Date.now() + 300000; // 5分
    showSaveStatus('広告キャンペーンを開始しました！販売/クエスト間隔が5分間20%短縮されます。', true);
    updateManagementDashboard();
    updateUI();
  }
}

function togglePause(toggle) {
  if (toggle){
  isPaused = !isPaused;
  document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
  document.getElementById('pauseButton').textContent = isPaused ? '▶' : '⏸';
  }

  if (isPaused) {
    // ポーズ開始: 時刻を記録し、タイマーをクリア
    pauseStartTime = Date.now();
    pauseStartGameTimeUpdate = lastGameTimeUpdate;
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
  } else {
    // ポーズ解除: ポーズ期間を計算し、クエストのdeadlineを調整
    const pauseEndTime = Date.now();
    if (pauseStartTime) {
      pauseDuration += pauseEndTime - pauseStartTime;
      // 既存クエストのdeadlineを延長
      quests.forEach(q => {
        q.id += pauseDuration;
      });
      if (nextQuestTime) {
        nextQuestTime += pauseDuration;
        const remainingTime = Math.max(0, nextQuestTime - Date.now());
        questTimer = setTimeout(scheduleQuest, remainingTime);
        questTimerStart = Date.now();
      } else {
        scheduleQuest();
      }
      lastWeatherUpdate += pauseDuration; // ゲーム内時間もポーズ調整
      //lastGameTimeUpdate += pauseDuration; //時間更新の基準を調整
      lastGameTimeUpdate = pauseStartGameTimeUpdate;
      pauseStartTime = null;
      console.log(pauseDuration);
    }
    // タイマーを再スケジュール
    if (nextQuestTime) {
      const remainingTime = Math.max(0, nextQuestTime - Date.now());
      console.log(`Next quest in ${remainingTime / 1000} seconds`);
      questTimer = setTimeout(scheduleQuest, remainingTime);
      questTimerStart = Date.now();
    } else {
      // 初回スケジュールまたはnextQuestTimeがない場合
      scheduleQuest();
    }
    lastPowerConsumption = Date.now();
  }
}

document.onkeydown = function(e) {
  if (e.key === 'Escape') {
    togglePause(true);
  }
};

function showDeleteConfirm() {
  isPaused = true;
  document.getElementById('deleteConfirmModal').style.display = 'flex';
  document.getElementById('pauseButton').textContent = '⏸';
}

function cancelDelete() {
  isPaused = false;
  document.getElementById('deleteConfirmModal').style.display = 'none';
  document.getElementById('pauseButton').textContent = '⏸';
  const pauseEndTime = Date.now();
  if (pauseStartTime) {
    pauseDuration += pauseEndTime - pauseStartTime;
    quests.forEach(q => {
      q.deadline += pauseDuration;
    });
    pauseStartTime = null;
  }
  lastPowerConsumption = Date.now();
  if (questTimer) {
    clearTimeout(questTimer);
    questTimer = null;
  }
  if (nextQuestTime) {
    const remainingTime = Math.max(0, nextQuestTime - Date.now());
    console.log(`Next quest in ${remainingTime / 1000} seconds`);
    questTimer = setTimeout(scheduleQuest, remainingTime);
    questTimerStart = Date.now();
  } else {
    scheduleQuest();
  }
}

function deleteSaveData() {
  try {
    localStorage.removeItem('farmingGameSave');
    localStorage.removeItem('farmingGameSettings');
    money = 100;
    xp = 0;
    rp = 5.0;
    ep = 0;
    landSize = 5;
    crops = [];
    harvestBox = {};
    dishInventory = {};
    shelf = [];
    shelves = { '0': [] };
    storeCount = 1;
    currentStoreId = '0';
    autoSellers = 0;
    autoSellerActive = true;
    quests = [];
    tools = { 'ジョウロ': 0, '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
    activePlanters = { '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
    unlockedCrops = ['キャベツ'];
    unlockedRecipes = ['焼きキャベツ'];
    growthBonus = 0;
    seasonings = {};
    advancedInventory = [];
    currentAdvancedRecipe = null;
    currentAdvancedSteps = [];
    autoSaveEnabled = true;
    autoSaveInterval = 10000;
    autoLoadEnabled = true;
    purchasedItems = new Set();
    newQuestAvailable = false;
    newAchievementAvailable = false;
    currentSubTab = 'farming';
    harvestCounts = { 'キャベツ': 0, 'トマト': 0, 'ニンジン': 0, 'ポテト': 0 };
    cookCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
    saleCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
    questCompleteCounts = { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
    totalQuestCompletes = 0;
    planterUses = { '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
    shopPurchaseCounts = { 'ジョウロ': 0, '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0, '電力購入': 0, 'トマト': 0, 'トマトサラダ': 0, 'ニンジン': 0, '焼きニンジン': 0, 'ポテト': 0 };
    totalPowerConsumed = 0;
    totalRevenue = 0;
    totalCost = 0;
    landExpansions = 0;
    sellIntervalReduction = 1;
    campaignEndTime = 0;
    powerShortage = false;
    achievements = achievements.map(a => ({ ...a, achieved: false, claimed: false }));
    pauseStartTime = null;
    pauseDuration = 0;
    nextQuestTime = null;
    questTimerStart = null;
    document.getElementById('deleteConfirmModal').style.display = 'none';
    isPaused = false;
    document.getElementById('pauseButton').textContent = '⏸';
    lastPowerConsumption = Date.now();
    gameTime = {days:0,hours:0,minutes:0};
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
    if (!isPaused) {
      scheduleQuest(); // タイマー開始
    }
    updateSettingsUI();
    updateAchievementList();
    updateUI();
    updateQuests();
    updatePlanterControls();
    startAutoSave();
    showSaveStatus('セーブデータを削除しました', true);
  } catch (error) {
    showSaveStatus('セーブデータの削除に失敗しました', false);
  }
}

function updateRP(amount) {
  rp = Math.max(0, Math.min(10, rp + amount));
  updateUI();
}

function getQuestInterval() {
  const minInterval = (30000 + (60000 - 30000) * ((rp - 1) / 9)) * sellIntervalReduction;
  const maxInterval = (70000 + (135000 - 70000) * ((rp - 1) / 9)) * sellIntervalReduction;
  return Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
}

// 10. 販売確率の天候影響
function getSellProbability() {
  let baseProb = 0.04 - (0.04 - 0.0167) * ((rp - 1) / 9);
  switch (currentWeather) {
    case '快晴': baseProb *= 1.1; break;
    case '晴れ': baseProb *= 1.05; break;
    case '蒸し暑い': baseProb *= 0.95; break;
    case '雨': case '大雨': baseProb *= 0.9; break;
    case '台風': baseProb *= 0.8; break;
  }
  return baseProb * sellProbabilityBonus;
}

function checkUnlocks() {
  const items = [
    { id: 'toolWateringCan', name: 'ジョウロ', cost: 150, type: 'tool' },
    { id: 'toolAutoPlanterCabbage', name: '種まき機キャベツ号', cost: 3000, type: 'tool' },
    { id: 'toolAutoPlanterTomato', name: '種まき機トマト号', cost: 4000, type: 'tool' },
    { id: 'toolAutoPlanterCarrot', name: '種まき機ニンジン号', cost: 5000, type: 'tool' },
    { id: 'toolAutoPlanterPotato', name: '種まき機ポテト号', cost: 7000, type: 'tool' },
    { id: 'buyPower', name: '電力購入', cost: 200, type: 'power' },
    { id: 'cropTomato', name: 'トマト', cost: 100, type: 'crop' },
    { id: 'recipeSalad', name: 'トマトサラダ', cost: 200, type: 'recipe' },
    { id: 'cropCarrot', name: 'ニンジン', cost: 150, type: 'crop' },
    { id: 'recipeCarrot', name: '焼きニンジン', cost: 200, type: 'recipe' },
    { id: 'cropPotato', name: 'ポテト', cost: 300, type: 'crop' }
  ];

  items.forEach(item => {
    const button = document.getElementById(item.id);
    if (button) {
      if (item.type === 'tool' && item.name.startsWith('種まき機')) {
        button.style.display = tools[item.name] >= landSize ? 'none' : 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `${item.name}購入（${item.cost}G）`
          : `${item.name}購入（${item.cost}G）- ${unlockThresholds[item.name]}XP必要`;
      } else if (item.type === 'power') {
        button.style.display = 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `電力購入（100EP / ${item.cost}G）`
          : `電力購入（100EP / ${item.cost}G）- ${unlockThresholds[item.name]}XP必要`;
      } else {
        button.style.display = purchasedItems.has(item.name) ? 'none' : 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `${item.name}${item.type === 'tool' ? '購入' : item.type === 'crop' ? 'の種' : 'レシピ本『' + item.name + '』'}（${item.cost}G）`
          : `${item.name}${item.type === 'tool' ? '購入' : item.type === 'crop' ? 'の種' : 'レシピ本『' + item.name + '』'}（${item.cost}G）- ${unlockThresholds[item.name]}XP必要`;
      }
    }
  });
}

function checkGameOver() {
  const hasNoItems =
    Object.keys(harvestBox).length === 0 &&
    Object.keys(dishInventory).length === 0 &&
    shelf.length === 0 &&
    crops.length === 0;
  if (money < 10 && hasNoItems) {
    money += 10;
    showSaveStatus('所持金が不足しています。救済として10Gを付与しました。', true);
    updateUI();
  }
}

function checkQuestDeadlines() {
  if (isPaused) {
    console.log('Quest deadlines paused');
    return;
  }
  const now = Date.now();
  quests.forEach(q => {
    const elapsed = (now - q.id) / 1000;
    if (elapsed > 10 && elapsed <= 30) {
      updateRP(0.05);
      if (elapsed >= 30) {
        showSaveStatus(`クエスト「${q.recipeName} ${q.dishNeed}個」が期限切れで評判が下がりました。`, false);
      }
    }
  });
  updateQuests();
}

function consumePower() {
  const now = Date.now();
  if (now - lastPowerConsumption >= 10000) {
    const totalActive = Object.values(activePlanters).reduce((sum, count) => sum + count, 0) + (autoSellers * 0.1); // 自動販売機は10秒で0.1EP消費
    if (totalActive > 0) {
      if (ep >= totalActive) {
        ep -= totalActive;
        totalPowerConsumed += totalActive;
        lastPowerConsumption = now;
        autoSellerActive = true;
        checkAchievements();
      } else {
        Object.keys(activePlanters).forEach(name => activePlanters[name] = 0);
        autoSellerActive = false;
        powerShortage = true;
        showSaveStatus('電力不足で種まき機と自動販売機が停止しました。', false);
        updatePlanterControls();
        updateTabNotifications();
      }
      updateUI();
    }
  }
}

function autoPlant() {
  const planters = [
    { name: '種まき機キャベツ号', crop: 'キャベツ' },
    { name: '種まき機トマト号', crop: 'トマト' },
    { name: '種まき機ニンジン号', crop: 'ニンジン' },
    { name: '種まき機ポテト号', crop: 'ポテト' }
  ];
  let plantCount = 0;
  planters.forEach(planter => {
    const activeCount = activePlanters[planter.name] || 0;
    for (let i = 0; i < activeCount && money >= 10 && crops.length < landSize && plantCount < landSize; i++) {
      if (unlockedCrops.includes(planter.crop)) {
        money -= 10;
        const qualityScore = calculateQualityScore();
        crops.push({ type: planter.crop, growth: 0, maxGrowth: 15, qualityScore });
        planterUses[planter.name] = (planterUses[planter.name] || 0) + 1;
        addXP(1);
        plantCount++;
        checkAchievements();
      }
    }
  });
  updateUI();
}

// 6. 作物への品質追加（plantCrop, autoPlantの変更）
function plantCrop() {
  const select = document.getElementById('cropSelect');
  const type = select.value;
  if (!unlockedCrops.includes(type)) return;
  if (money >= 10 && crops.length < landSize) {
    money -= 10;
    const qualityScore = calculateQualityScore();
    crops.push({ type, growth: 0, maxGrowth: 15, qualityScore });
    addXP(1);
    updateUI();
  }
}

// 8. 収穫時の品質決定
function growCrops() {
  crops.forEach(c => {
    let growthRate = 1 + growthBonus;
    switch (currentWeather) {
      case '曇り': growthRate -= 0.2; break;
      case '蒸し暑い': growthRate -= 0.1; break;
      case '雨': growthRate += 0.3; break;
      case '大雨': growthRate += 0.5; break;
      case '台風': growthRate -= 0.5; break;
    }
    if (c.growth < c.maxGrowth) {
      c.growth = Math.min(10*(c.growth) + 10*(growthRate), 10*(c.maxGrowth));
      console.log(c.growth);
      c.growth *= 0.1;
      console.log(c.growth);
    }
  });
  const ready = crops.filter(c => c.growth >= c.maxGrowth);
  for (const c of ready) {
    const quality = c.qualityScore < 6.7 ? '普通' : c.qualityScore < 9.1 ? '高品質' : 'プレミアム';
    harvestBox[c.type] = harvestBox[c.type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
    harvestBox[c.type][quality] = (harvestBox[c.type][quality] || 0) + 1;
    harvestCounts[c.type] = (harvestCounts[c.type] || 0) + 1;
    checkAchievements();
  }
  crops = crops.filter(c => c.growth < c.maxGrowth);
}

// 11. 料理時の品質処理
function cook() {
  const type = document.getElementById('recipeSelect').value;
  const recipe = recipeData[type];
  if (!recipe || !unlockedRecipes.includes(type)) return;

  let canCook = Object.entries(recipe.ingredients).every(([crop, count]) =>
    Object.values(harvestBox[crop] || { 普通: 0, 高品質: 0, プレミアム: 0 }).reduce((sum, v) => sum + v, 0) >= count
  );

  if (canCook) {
    let minQualityScore = Infinity;
    for (const [crop, count] of Object.entries(recipe.ingredients)) {
      let remaining = count;
      for (const quality of ['プレミアム', '高品質', '普通']) {
        const available = harvestBox[crop]?.[quality] || 0;
        if (remaining > 0 && available > 0) {
          const used = Math.min(remaining, available);
          harvestBox[crop][quality] -= used;
          const score = quality === '普通' ? 4 : quality === '高品質' ? 7 : 9;
          minQualityScore = Math.min(minQualityScore, score);
          remaining -= used;
        }
      }
    }
    const quality = minQualityScore < 5 ? '普通' : minQualityScore < 8 ? '高品質' : 'プレミアム';
    dishInventory[type] = dishInventory[type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
    dishInventory[type][quality] = (dishInventory[type][quality] || 0) + 1;
    cookCounts[type] = (cookCounts[type] || 0) + 1;
    addXP(1);
    checkAchievements();
    updateUI();
  }
}

function putOnShelf(storeId) {
  const type = document.getElementById(`sellRecipeSelect-${storeId}`).value;
  const quality = document.getElementById(`qualitySelect-${storeId}`).value;
  const qualities = dishInventory[type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
  if (qualities[quality] > 0) {
    qualities[quality]--;
    shelves[storeId].push({ type, quality });
    addXP(1);
    onQualitySelection(type, quality, 'shelf'); // 拡張用関数呼び出し
    updateUI();
  }
}

// 9. 売価への影響（sellFromShelf, autoSellの変更）
// 1. 商品棚のランダム取り出し（sellFromShelfの変更）
function sellFromShelf() {
  Object.entries(shelves).forEach(([storeId, shelf]) => {
    if (shelf.length > 0 && Math.random() < getSellProbability()) {
      const index = Math.floor(Math.random() * shelf.length); // ランダムインデックス
      const sold = shelf.splice(index, 1)[0]; // ランダムに取り出し
      let price = recipeData[sold.type]?.sellPrice || 20;
      if (sold.quality === '高品質') price *= 1.5;
      if (sold.quality === 'プレミアム') price *= 2;
      money += price;
      totalRevenue += price;
      saleCounts[sold.type] = (saleCounts[sold.type] || 0) + 1;
      addXP(1);
      updateRP(-0.04);
      checkAchievements();
    }
  });
  updateUI();
}

function autoSell() {
  if (autoSellers > 0 && autoSellerActive && !isPaused) {
    if (ep >= autoSellers) {
      ep -= autoSellers;
      totalPowerConsumed += autoSellers;
      Object.entries(dishInventory).forEach(([type, qualities]) => {
        Object.entries(qualities).forEach(([quality, count]) => {
          if (count > 0 && Math.random() < (1 / (Math.random() * (90 - 60) + 60))) {
            qualities[quality]--;
            let price = recipeData[type]?.sellPrice || 20;
            if (quality === '高品質') price *= 1.5;
            if (quality === 'プレミアム') price *= 2;
            money += price;
            totalRevenue += price;
            saleCounts[type] = (saleCounts[type] || 0) + 1;
            addXP(1);
            checkAchievements();
          }
        });
      });
    } else {
      autoSellerActive = false;
      powerShortage = true;
      showSaveStatus('電力不足で自動販売機が停止しました。', false);
      updateTabNotifications();
    }
    updateUI();
  }
}

function updateQuests() {
  const questListElement = document.getElementById('questList');
  if (questListElement) {
    console.log(`Rendering questList, quests: ${JSON.stringify(quests)}`);
    const questList = quests
      .filter(quest => 
        quest.requirements && 
        Object.keys(quest.requirements).length > 0 && 
        Object.keys(quest.requirements).every(type => recipeData[type])
      )
      .map(quest => {
        const requirements = Object.entries(quest.requirements)
          .map(([type, count]) => `${type || '不明'} x${count || 0}`)
          .join(', ');
        const firstType = Object.keys(quest.requirements)[0];
        const qualities = dishInventory[firstType] || { 普通: 0, 高品質: 0, プレミアム: 0 };
        const totalAvailable = (qualities.普通 || 0) + (qualities.高品質 || 0) + (qualities.プレミアム || 0);
        const canComplete = firstType && totalAvailable >= quest.requirements[firstType];
        const remainingSeconds = Math.max(0, Math.floor((quest.deadline - Date.now()) / 1000));
        return `
          <li>
            ${requirements} (${remainingSeconds}秒)
            ${canComplete ? '' : '<span>在庫不足</span>'}
            <button onclick="completeQuest(${quest.id})" ${canComplete ? '' : 'disabled'}>納品</button>
          </li>
        `;
      }).join('');
    questListElement.innerHTML = questList || '<li>クエストなし</li>';
  }
}

// クエストスケジュール
function scheduleQuest() {
  if (!isPaused) {
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
    // 不正なクエストをクリーニング
    quests = quests.filter(quest => quest.requirements && Object.keys(quest.requirements).length > 0);
    console.log(`Cleaned quests: ${JSON.stringify(quests)}`);
    if (quests.length < MAX_QUESTS) {
      const quest = generateQuest();
      if (quest) {
        quests.push(quest);
        newQuestAvailable = true;
        console.log(`Quest added, current quests: ${JSON.stringify(quests)}`);
      } else {
        console.warn('Failed to generate quest');
      }
    }
    const interval = getQuestInterval();
    nextQuestTime = Date.now() + interval;
    questTimer = setTimeout(scheduleQuest, interval);
    questTimerStart = Date.now();
    console.log(`Next quest scheduled in ${interval / 1000} seconds`);
  }
  updateUI();
}

function generateQuest() {
  console.log(`generateQuest called, unlockedRecipes: ${JSON.stringify(unlockedRecipes)}, recipeData: ${JSON.stringify(recipeData)}`);
  if (!unlockedRecipes || unlockedRecipes.length === 0 || !recipeData) {
    console.warn('Cannot generate quest: unlockedRecipes or recipeData is empty');
    return null;
  }
  const types = Object.keys(recipeData).filter(type => unlockedRecipes.includes(type) && recipeData[type]);
  if (types.length === 0) {
    console.warn('No valid recipe types available for quest');
    return null;
  }
  const type = types[Math.floor(Math.random() * types.length)];
  const count = Math.floor(Math.random() * 3) + 1;
  const requirements = { [type]: count };
  const quest = {
    id: Date.now(),
    requirements,
    reward: count * (recipeData[type]?.rewardPerDish || 25),
    deadline: Date.now() + 10000
  };
  console.log(`Generated quest: ${JSON.stringify(quest)}`);
  return quest;
}

// 3. クエスト納品時の品質選択（completeQuestの追加/変更）
// 1. クエスト納品（エラーハンドリング追加）
// クエスト納品（自動品質選択）
// クエスト納品（デバッグログとエラーチェック強化）
// クエスト納品
function completeQuest(questId) {
  console.log(`completeQuest called with questId: ${questId}`);
  console.log(`Current quests: ${JSON.stringify(quests)}`);
  console.log(`Current dishInventory: ${JSON.stringify(dishInventory)}`);

  const quest = quests.find(q => q.id === questId);
  if (!quest) {
    console.error(`Quest not found for ID: ${questId}`);
    showSaveStatus('クエストが見つかりません', false);
    return;
  }

  // 古い形式のクエストを変換
  let requirements = quest.requirements;
  if (!requirements && quest.recipeName && quest.dishNeed) {
    console.warn(`Converting legacy quest: ${JSON.stringify(quest)}`);
    requirements = { [quest.recipeName]: quest.dishNeed };
    quest.requirements = requirements;
  }

  if (!requirements || Object.keys(requirements).length === 0) {
    console.error(`Invalid quest requirements: ${JSON.stringify(requirements)}`);
    showSaveStatus('無効なクエストです', false);
    quests = quests.filter(q => q.id !== questId);
    updateUI();
    return;
  }

  // 在庫チェック
  const canComplete = Object.entries(requirements).every(([type, count]) => {
    const qualities = dishInventory[type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
    const totalAvailable = (qualities.普通 || 0) + (qualities.高品質 || 0) + (qualities.プレミアム || 0);
    console.log(`Checking type: ${type}, required: ${count}, available: ${totalAvailable}`);
    return totalAvailable >= count;
  });

  if (!canComplete) {
    console.warn(`Cannot complete quest due to insufficient inventory`);
    showSaveStatus('納品できません：在庫が不足しています', false);
    return;
  }

  // 品質を優先順位で消費
  Object.entries(requirements).forEach(([type, count]) => {
    const qualities = dishInventory[type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
    let remaining = count;
    
    console.log(`Consuming ${type}: required ${count}, before: ${JSON.stringify(qualities)}`);
    if (remaining > 0 && qualities.普通 > 0) {
      const used = Math.min(qualities.普通, remaining);
      qualities.普通 -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, '普通', 'quest');
    }
    if (remaining > 0 && qualities.高品質 > 0) {
      const used = Math.min(qualities.高品質, remaining);
      qualities.高品質 -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, '高品質', 'quest');
    }
    if (remaining > 0 && qualities.プレミアム > 0) {
      const used = Math.min(qualities.プレミアム, remaining);
      qualities.プレミアム -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, 'プレミアム', 'quest');
    }
    console.log(`After consuming ${type}: ${JSON.stringify(qualities)}`);
  });

  money += quest.reward;
  addXP(10);
  questCompleteCounts[Object.keys(requirements)[0]] = (questCompleteCounts[Object.keys(requirements)[0]] || 0) + 1;
  totalQuestCompletes += 1;
  quests = quests.filter(q => q.id !== questId);
  console.log(`Quest ${questId} completed, new quests: ${JSON.stringify(quests)}`);
  updateUI();
  checkAchievements();
}

function buyLand() {
  const cost = 100 + landSize * 10;
  if (money >= cost) {
    money -= cost;
    totalCost += cost; // 総支出を更新
    landSize += 5;
    landExpansions += 1; // 拡張回数を増加
    checkAchievements();
    updateUI();
    updateManagementDashboard();
  }
}

function buyTool(name) {
  if (xp < unlockThresholds[name]) return;
  const cost = name === '種まき機キャベツ号' ? 3000 :
               name === '種まき機トマト号' ? 4000 :
               name === '種まき機ニンジン号' ? 5000 :
               name === '種まき機ポテト号' ? 7000 : 150;
  if (name.startsWith('種まき機') && tools[name] >= landSize) return;
  if (money >= cost) {
    money -= cost;
    totalCost += cost; // 総支出を更新
    tools[name] = (tools[name] || 0) + 1;
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    if (!name.startsWith('種まき機')) purchasedItems.add(name);
    if (name === 'ジョウロ') growthBonus = 1;
    checkAchievements();
    updatePlanterControls();
    updateUI();
  }
}

function buyPower() {
  if (xp < unlockThresholds['電力購入']) return;
  if (money >= 200) {
    money -= 200;
    totalCost += 200; // 総支出を更新
    ep += 100;
    shopPurchaseCounts['電力購入'] = (shopPurchaseCounts['電力購入'] || 0) + 1;
    checkAchievements();
    updateUI();
  }
}

function buyCrop(name) {
  if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
  const cost = name === 'ニンジン' ? 150 : name === 'ポテト' ? 300 : 100;
  if (money >= cost && !unlockedCrops.includes(name)) {
    money -= cost;
    totalCost += cost; // 総支出を更新
    unlockedCrops.push(name);
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    purchasedItems.add(name);
    checkAchievements();
    updateUI();
  }
}

function buyRecipe(name) {
  if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
  if (money >= 200 && !unlockedRecipes.includes(name)) {
    money -= 200;
    totalCost += 200; // 総支出を更新
    unlockedRecipes.push(name);
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    purchasedItems.add(name);
    checkAchievements();
    updateUI();
  }
}

function updatePlanterControls() {
  const controls = document.getElementById('planterControls');
  const planters = [
    '種まき機キャベツ号',
    '種まき機トマト号',
    '種まき機ニンジン号',
    '種まき機ポテト号'
  ];
  controls.innerHTML = planters.map(name => {
    const owned = tools[name] || 0;
    if (owned === 0) return '';
    const options = Array.from({ length: owned + 1 }, (_, i) => i);
    return `
      <div style="margin-bottom: 10px;">
        <label>${name} 稼働台数（所持: ${owned}台）:</label>
        <select id="planter-${name}" onchange="updateActivePlanter('${name}')">
          ${options.map(i => `<option value="${i}" ${activePlanters[name] === i ? 'selected' : ''}>${i}台</option>`).join('')}
        </select>
      </div>
    `;
  }).join('');
}

function updateActivePlanter(name) {
  const select = document.getElementById(`planter-${name}`);
  activePlanters[name] = parseInt(select.value);
  updateUI();
}

function updateTabNotifications() {
  const shopTab = document.getElementById('tab-shop');
  const questTab = document.getElementById('tab-quest');

  // 全店舗の棚に商品が1つ以上あるかチェック
  const allShelvesHaveItems = Object.values(shelves).every(shelf => shelf.length > 0);
  shopTab.innerHTML = allShelvesHaveItems ? '🏪 販売' : '🏪 販売<span class="badge">⚠️</span>';
  
  if (newQuestAvailable && quests.length > 0) {
    questTab.innerHTML = '📜 クエスト<span class="badge">🔔</span>';
  } else {
    questTab.innerHTML = '📜 クエスト';
  }
  console.log('Shelves status:', Object.fromEntries(Object.entries(shelves).map(([id, shelf]) => [id, shelf.length])), 'Notification:', !allShelvesHaveItems);
}

function updateUI() {
  document.getElementById('land').innerText = `土地拡張（${100 + landSize * 10}G）`;
  document.getElementById('money').textContent = money;
  document.getElementById('xp').textContent = xp;
  document.getElementById('rp').textContent = rp.toFixed(2);
  document.getElementById('ep').textContent = ep;
  document.getElementById('landSize').textContent = landSize;
  document.getElementById('cropCount').textContent = crops.length;

  document.getElementById('crops').innerHTML = crops.map(c => `<li>${c.type} - 成長: ${Number(c.growth).toFixed(1)}/15</li>`).join('');

  const harvestList = Object.entries(harvestBox).map(([crop, qualities]) =>
    `<li>${crop}: 普通 x${qualities.普通 || 0}, 高品質 x${qualities.高品質 || 0}, プレミアム x${qualities.プレミアム || 0}</li>`
  ).join('');
  document.getElementById('harvestBox').innerHTML = harvestList;
  document.getElementById('harvestBoxCook').innerHTML = harvestList;

  const cropSelect = document.getElementById('cropSelect');
  const selectedCrop = cropSelect.value;
  cropSelect.innerHTML = unlockedCrops.map(c => `<option value="${c}">${c}</option>`).join('');
  cropSelect.value = unlockedCrops.includes(selectedCrop) ? selectedCrop : unlockedCrops[0] || '';

  const recipeSelect = document.getElementById('recipeSelect');
  const selectedRecipe = recipeSelect.value;
  recipeSelect.innerHTML = unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('');
  recipeSelect.value = selectedRecipe;

  const recipe = recipeData[selectedRecipe] || {ingredients: {}};
  const ingredients = Object.entries(recipe.ingredients).map(([k,v]) => `${k} x${v}`).join(', ');
  document.getElementById('ingredientInfo').innerText = `必要材料: ${ingredients}`;

  const dishList = Object.entries(dishInventory).map(([dish, qualities]) =>
    `<li>${dish}: 普通 x${qualities.普通 || 0}, 高品質 x${qualities.高品質 || 0}, プレミアム x${qualities.プレミアム || 0}</li>`
  ).join('');
  document.getElementById('dishInventory').innerHTML = dishList;

  // エラーハンドリング
  const shelfCountElement = document.getElementById(`shelfCount-${currentStoreId}`);
  const shelfListElement = document.getElementById(`shelfList-${currentStoreId}`);
  if (shelfListElement && shelves[currentStoreId]) {
    shelfListElement.innerHTML = shelves[currentStoreId].map(item => 
      `<li>${item.type} (${item.quality}, ${recipeData[item.type]?.sellPrice * (item.quality === '高品質' ? 1.5 : item.quality === 'プレミアム' ? 2 : 1)}G)</li>`
    ).join('');
  }

  // 既存の harvestList, dishList, shelfListElement は変更なし
  document.getElementById('gameTime').textContent = `日付: ${gameTime.days}日 ${gameTime.hours}時 ${gameTime.minutes}分`;
  document.getElementById('currentWeather').textContent = `天候: ${currentWeather}`;
  // 既存の harvestList, dishList, shelfListElement の処理はそのまま

  // 棚の品質選択
// 棚の品質選択（選択状態を保持）
  Object.keys(shelves).forEach(storeId => {
    const qualitySelect = document.getElementById(`qualitySelect-${storeId}`);
    if (qualitySelect) {
      const type = document.getElementById(`sellRecipeSelect-${storeId}`).value;
      const qualities = dishInventory[type] || { 普通: 0, 高品質: 0, プレミアム: 0 };
      const currentQuality = selectedQualities[storeId] || qualitySelect.value || '普通';
      
      // 在庫がある品質のみ表示
      const qualityOptions = Object.keys(qualities)
        .filter(q => qualities[q] > 0)
        .map(q => `<option value="${q}" ${q === currentQuality ? 'selected' : ''}>${q}</option>`)
        .join('') || '<option value="">選択不可</option>';
      
      // ドロップダウンの内容を更新（必要時のみ）
      if (qualitySelect.innerHTML !== qualityOptions) {
        qualitySelect.innerHTML = qualityOptions;
      }
      
      // 選択値を保持
      if (qualitySelect.value) {
        selectedQualities[storeId] = qualitySelect.value;
      }
      
      // onchange イベントを追加（初回のみ）
      if (!qualitySelect.dataset.listenerAdded) {
        qualitySelect.addEventListener('change', () => {
          selectedQualities[storeId] = qualitySelect.value;
          console.log(`Quality selected for store ${storeId}: ${qualitySelect.value}`);
        });
        qualitySelect.dataset.listenerAdded = 'true';
      }
    }
  });
  
  // クエスト表示（品質選択を削除）
  // クエスト表示
  const questListElement = document.getElementById('questList');
  if (questListElement) {
    console.log(`Rendering questList, quests:`, JSON.stringify(quests));
    const questList = quests
      .filter(quest => quest.requirements && Object.keys(quest.requirements).length > 0)
      .map(quest => {
        const requirements = Object.entries(quest.requirements)
          .map(([type, count]) => `${type} x${count}`)
          .join(', ');
        const firstType = Object.keys(quest.requirements)[0];
        const qualities = dishInventory[firstType] || { 普通: 0, 高品質: 0, プレミアム: 0 };
        const totalAvailable = (qualities.普通 || 0) + (qualities.高品質 || 0) + (qualities.プレミアム || 0);
        const canComplete = totalAvailable >= quest.requirements[firstType];
        return `
          <li>
            ${requirements} (${Math.max(0, Math.floor((quest.deadline - Date.now()) / 1000))}秒)
            ${canComplete ? '' : '<span>在庫不足</span>'}
            <button onclick="completeQuest(${quest.id})" ${canComplete ? '' : 'disabled'}>納品</button>
          </li>
        `;
      }).join('');
    questListElement.innerHTML = questList || '<li>クエストなし</li>';
  }
  
  // 棚の表示
  if (shelfListElement && shelves[currentStoreId]) {
    shelfListElement.innerHTML = shelves[currentStoreId].map(item => 
      `<li>${item.type} (${item.quality}, ${recipeData[item.type]?.sellPrice * (item.quality === '高品質' ? 1.5 : item.quality === 'プレミアム' ? 2 : 1)}G)</li>`
    ).join('');
  }

  checkUnlocks();
  checkGameOver();
  updateTabNotifications();
  updateManagementDashboard();
}


function showSaveStatus(message, isSuccess) {
  const statusDiv = document.getElementById('saveStatus');
  statusDiv.textContent = message;
  statusDiv.className = isSuccess ? 'success' : 'error';
  statusDiv.style.display = 'block';
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 3000);
}

function saveGame() {
  try {
    const data = {
      version: version,
      money,
      xp,
      rp,
      ep,
      landSize,
      crops: crops.filter(c => unlockedCrops.includes(c.type)),
      harvestBox: Object.fromEntries(
        Object.entries(harvestBox || {}).filter(([k]) => unlockedCrops.includes(k))
      ),
      dishInventory,
      shelves,
      quests,
      tools,
      activePlanters,
      unlockedCrops,
      unlockedRecipes,
      seasonings,
      advancedInventory,
      growthBonus,
      currentAdvancedRecipe,
      currentAdvancedSteps,
      autoSaveEnabled,
      autoSaveInterval,
      autoLoadEnabled,
      purchasedItems: Array.from(purchasedItems),
      lastPowerConsumption,
      pauseDuration, // 追加
      nextQuestTime, // 追加
      achievements,
      isPaused,
      currentSubTab,
      currentStoreId,
      storeCount,
      autoSellers,
      autoSellerActive,
      harvestCounts,
      cookCounts,
      saleCounts,
      questCompleteCounts,
      totalQuestCompletes,
      planterUses,
      shopPurchaseCounts,
      totalPowerConsumed,
      totalRevenue,
      totalCost,
      landExpansions,
      sellIntervalReduction,
      campaignEndTime,
      powerShortage,
      gameTime,
      currentWeather,
      previousWeather,
      weatherHistory,
      currentSeason,
      lastWeatherUpdate,
      selectedQualities // 新しく追加
    };
    localStorage.setItem('farmingGameSave', JSON.stringify(data));
    showSaveStatus('ゲームを保存しました', true);
  } catch (error) {
    showSaveStatus('保存に失敗しました', false);
  }
}

function loadGame() {
  try {
    const save = localStorage.getItem('farmingGameSave');
    if (save) {
      const data = JSON.parse(save);
      if (data.version !== version) {
        console.warn(`Version mismatch: saved ${data.version}, current ${version}`);
      }
      money = data.money || 100;
      xp = data.xp || 0;
      rp = data.rp !== undefined ? data.rp : 5.0;
      ep = data.ep || 0;
      landSize = data.landSize || 5;
      crops = (data.crops || []).filter(c => ['キャベツ', 'トマト', 'ニンジン', 'ポテト'].includes(c.type));
      harvestBox = Object.fromEntries(
        Object.entries(data.harvestBox || {}).filter(([k]) => ['キャベツ', 'トマト', 'ニンジン', 'ポテト'].includes(k))
      );
      unlockedCrops = (data.unlockedCrops || ['キャベツ']).filter(c => ['キャベツ', 'トマト', 'ニンジン', 'ポテト'].includes(c));
      dishInventory = Object.fromEntries(
        Object.entries(data.dishInventory || {}).map(([k, v]) => [
          k === '焼き野菜' ? '焼きキャベツ' : k === 'サラダ' ? 'トマトサラダ' : k === 'スープ' ? '焼きニンジン' : k,
          v
        ])
      );
      shelves = data.shelves || { '0': [] };
      storeCount = data.storeCount || 1;
      currentStoreId = (data.currentStoreId && shelves[data.currentStoreId]) ? data.currentStoreId : '0';
      autoSellers = data.autoSellers || 0;
      autoSellerActive = data.autoSellerActive !== undefined ? data.autoSellerActive : true;
      // クエストを新しい形式に変換
      quests = (data.quests || []).map(q => {
        const requirements = q.requirements || (q.recipeName && q.dishNeed ? { 
          [q.recipeName === '焼き野菜' ? '焼きキャベツ' : 
           q.recipeName === 'サラダ' ? 'トマトサラダ' : 
           q.recipeName === 'スープ' ? '焼きニンジン' : q.recipeName]: q.dishNeed 
        } : null);
        if (!requirements || Object.keys(requirements).length === 0) {
          console.warn(`Invalid quest in save data: ${JSON.stringify(q)}`);
          return null;
        }
        return {
          id: q.id,
          requirements,
          reward: q.reward || Object.values(requirements)[0] * (recipeData[Object.keys(requirements)[0]]?.rewardPerDish || 25),
          deadline: q.deadline + (data.pauseDuration || 0)
        };
      }).filter(q => q !== null);
      tools = {
        'ジョウロ': data.tools?.['ジョウロ'] || 0,
        '種まき機キャベツ号': data.tools?.['種まき機キャベツ号'] || data.tools?.['自動播種機'] || 0,
        '種まき機トマト号': data.tools?.['種まき機トマト号'] || 0,
        '種まき機ニンジン号': data.tools?.['種まき機ニンジン号'] || 0,
        '種まき機ポテト号': data.tools?.['種まき機ポテト号'] || 0
      };
      activePlanters = {
        '種まき機キャベツ号': data.activePlanters?.['種まき機キャベツ号'] || data.activePlanters?.['自動播種機'] || 0,
        '種まき機トマト号': data.activePlanters?.['種まき機トマト号'] || 0,
        '種まき機ニンジン号': data.activePlanters?.['種まき機ニンジン号'] || 0,
        '種まき機ポテト号': data.activePlanters?.['種まき機ポテト号'] || 0
      };
      unlockedRecipes = (data.unlockedRecipes || ['焼きキャベツ']).map(r =>
        r === '焼き野菜' ? '焼きキャベツ' : r === 'サラダ' ? 'トマトサラダ' : r === 'スープ' ? '焼きニンジン' : r
      );
      seasonings = data.seasonings || {};
      advancedInventory = data.advancedInventory || [];
      growthBonus = data.growthBonus || 0;
      currentAdvancedRecipe = data.currentAdvancedRecipe || null;
      currentAdvancedSteps = data.currentAdvancedSteps || [];
      autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
      autoSaveInterval = data.autoSaveInterval || 10000;
      autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : true;
      purchasedItems = new Set(
        (data.purchasedItems || []).map(item =>
          item === '自動播種機' ? '種まき機キャベツ号' : item
        )
      );
      lastPowerConsumption = data.lastPowerConsumption || Date.now();
      pauseDuration = data.pauseDuration || 0;
      nextQuestTime = data.nextQuestTime || null;
      currentSubTab = data.currentSubTab || 'farming';
      harvestCounts = data.harvestCounts || { 'キャベツ': 0, 'トマト': 0, 'ニンジン': 0, 'ポテト': 0 };
      cookCounts = data.cookCounts || { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
      saleCounts = data.saleCounts || { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
      questCompleteCounts = data.questCompleteCounts || { '焼きキャベツ': 0, 'トマトサラダ': 0, '焼きニンジン': 0 };
      totalQuestCompletes = data.totalQuestCompletes || 0;
      planterUses = data.planterUses || { '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0 };
      shopPurchaseCounts = data.shopPurchaseCounts || { 'ジョウロ': 0, '種まき機キャベツ号': 0, '種まき機トマト号': 0, '種まき機ニンジン号': 0, '種まき機ポテト号': 0, '電力購入': 0, 'トマト': 0, 'トマトサラダ': 0, 'ニンジン': 0, '焼きニンジン': 0, 'ポテト': 0 };
      totalPowerConsumed = data.totalPowerConsumed || 0;
      totalRevenue = data.totalRevenue || 0;
      totalCost = data.totalCost || 0;
      landExpansions = data.landExpansions || 0;
      sellIntervalReduction = data.sellIntervalReduction || 1;
      campaignEndTime = data.campaignEndTime || 0;
      powerShortage = data.powerShortage || false;
      achievements = data.achievements || achievements.map(a => ({ ...a, achieved: false, claimed: false }));
      newAchievementAvailable = achievements.some(a => a.achieved && !a.claimed);
      isPaused = data.isPaused || false;
      document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
      document.getElementById('pauseButton').textContent = isPaused ? '▶' : '⏸';
      gameTime = data.gameTime || { days: 0, hours: 0, minutes: 0 };
      currentWeather = data.currentWeather || '晴れ';
      previousWeather = data.previousWeather || null;
      weatherHistory = data.weatherHistory || [];
      currentSeason = data.currentSeason || '春';
      lastWeatherUpdate = data.lastWeatherUpdate || Date.now();
      if (questTimer) {
        clearTimeout(questTimer);
        questTimer = null;
      }
      if (!isPaused && nextQuestTime) {
        const remainingTime = Math.max(0, nextQuestTime - Date.now());
        console.log(`Next quest in ${remainingTime / 1000} seconds`);
        questTimer = setTimeout(scheduleQuest, remainingTime);
        questTimerStart = Date.now();
      } else if (!isPaused) {
        scheduleQuest();
      }
      updateSettingsUI();
      updateAchievementList();
      updateUI();
      updateQuests();
      updatePlanterControls();
      updateShopSubTabs();
      showSaveStatus('ゲームを読み込みました', true);
    } else {
      showSaveStatus('保存データが見つかりません', false);
      if (!isPaused) {
        scheduleQuest();
      }
    }
  } catch (error) {
    console.error(`loadGame error: ${error}`);
    showSaveStatus('読み込みに失敗しました: ' + error.message, false);
  }
}

function updateSettingsUI() {
  document.getElementById('autoSaveEnabled').checked = autoSaveEnabled;
  document.getElementById('autoSaveInterval').value = autoSaveInterval / 1000;
  document.getElementById('autoLoadEnabled').checked = autoLoadEnabled;
}

function toggleAutoSave() {
  autoSaveEnabled = document.getElementById('autoSaveEnabled').checked;
  startAutoSave();
  saveSettings();
}

function updateAutoSaveInterval() {
  const input = document.getElementById('autoSaveInterval');
  let value = parseInt(input.value) * 1000;
  if (value < 5000) {
    value = 5000;
    input.value = 5;
  }
  autoSaveInterval = value;
  startAutoSave();
  saveSettings();
}

function saveSettings() {
  try {
    const data = {
      autoSaveEnabled,
      autoSaveInterval,
      autoLoadEnabled
    };
    localStorage.setItem('farmingGameSettings', JSON.stringify(data));
    showSaveStatus('設定を保存しました', true);
  } catch (error) {
    showSaveStatus('設定の保存に失敗しました', false);
  }
}

function loadSettings() {
  try {
    const settings = localStorage.getItem('farmingGameSettings');
    if (settings) {
      const data = JSON.parse(settings);
      autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
      autoSaveInterval = data.autoSaveInterval || 10000;
      autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : true;
    }
  } catch (error) {
    console.error('設定の読み込みに失敗しました', error);
  }
}

function startAutoSave() {
  if (autoSaveTimer) {
    clearInterval(autoSaveTimer);
    autoSaveTimer = null;
  }
  if (autoSaveEnabled) {
    autoSaveTimer = setInterval(saveGame, autoSaveInterval);
  }
}

loadSettings();
updateSettingsUI();
startAutoSave();
if (autoLoadEnabled) {
  loadGame();
}

updateUI();

setInterval(() => {
  if (!isPaused) {
    growCrops();
    checkQuestDeadlines();
    checkGameOver();
    consumePower();
Object.entries(shelves).forEach(([storeId, shelf]) => {
  if (shelf.length === 0) {
    updateRP(0.1);
  }
});
    autoPlant();
    if (campaignEndTime <= Date.now() && sellIntervalReduction < 1) {
      sellIntervalReduction = 1;
      showSaveStatus('広告キャンペーンが終了しました。', true);
    }
  }
}, 1000);

setInterval(() => {
  updateGameTime();
  updateUI();
}, 250);

setInterval(() => {
    if (!isPaused) {
      sellFromShelf();
      autoSell();
    }
}, 1000 * sellIntervalReduction); // 広告による間隔短縮を反映
</script>
</body>
</html>
