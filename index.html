<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking</title>
  <link rel="icon" href="cooking.png">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f9f9f9;
    color: #333;
  }

  #global-status {
    position: relative;
    margin: 12px auto 6px;
    text-align: center;
    width: fit-content;
    padding: 8px 16px;
    background: #fcfcfc;
    border-radius: 8px;
    border: 1px solid #bbb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    font-weight: bold;
    color: #222;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #pauseButton {
    padding: 6px 12px;
    font-size: 14px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #pauseButton:hover {
    background-color: #45a049;
  }

  #tabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background-color: #ffffff;
    padding: 8px;
    gap: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  #tabs button {
    background-color: #f5f5f5;
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 15px;
    cursor: pointer;
    color: #333;
    transition: background-color 0.2s, color 0.2s;
    flex: 1 0 auto;
    min-width: 90px;
    position: relative;
  }

  #tabs button:hover {
    background-color: #ebebeb;
  }

  #tabs button.active-tab {
    background-color: #e0f2e9;
    font-weight: bold;
    color: #2d7a4d;
    border: 1px solid #4CAF50;
  }

  #tabs button .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #f44336;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .tab-content {
    display: none;
    padding: 20px;
    max-width: 800px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .tab-content.active {
    display: block;
  }

  h2 {
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
    margin-bottom: 15px;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }

  select,
  input[type="number"],
  input[type="checkbox"] {
    padding: 8px 12px;
    margin-bottom: 10px;
    font-size: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box;
  }

  button {
    padding: 10px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    margin: 5px 0;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background-color: #45a049;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  ul li {
    padding: 8px 12px;
    background-color: #f4f4f4;
    border-radius: 6px;
    margin-bottom: 6px;
    border: 1px solid #ddd;
    font-size: 15px;
  }

  #achievementList li.achieved {
    background-color: #c8e6c9;
    border: 1px solid #4CAF50;
  }

  #achievementList li.unachieved {
    background-color: #e0e0e0;
    border: 1px solid #ccc;
    color: #666;
  }

  #ingredientInfo {
    background-color: #e8f5e9;
    padding: 10px 14px;
    border-left: 4px solid #4CAF50;
    margin: 10px 0;
    border-radius: 6px;
    font-size: 14px;
  }

  #saveStatus {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
    transition: opacity 0.3s ease;
  }

  #saveStatus.success {
    background-color: #e8f5e9;
    border-left: 4px solid #4CAF50;
    display: block;
  }

  #saveStatus.error {
    background-color: #ffebee;
    border-left: 4px solid #f44336;
    display: block;
  }

  .settings-group {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .settings-group p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #555;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #pauseModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #pauseModal > div {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  @media (min-width: 481px) {

    .button-group {
      flex-direction: row;
    }

    button {
      width: auto;
    }

    select,
    input[type="number"],
    input[type="checkbox"] {
      width: auto;
    }
  }

  @media (max-width: 480px) {
  #global-status {
    flex-direction: column;
    align-items: flex-start;
  }

  #tabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: auto;
      gap: 6px;
    }
  }
</style>
</head>
<body>
  <div id="global-status">
    æ‰€æŒé‡‘: <span id="money">100</span>G | çµŒé¨“å€¤: <span id="xp">0</span>XP | è©•åˆ¤: <span id="rp">5.00</span>RP | é›»åŠ›: <span id="ep">0</span>EP
    <button id="pauseButton" onclick="togglePause()">â¸</button>
  </div>

  <div id="tabs">
    <button id="tab-farm" onclick="showTab('farm')">ğŸŒ± è¾²æ¥­</button>
    <button id="tab-cook" onclick="showTab('cook')">ğŸ³ æ–™ç†</button>
    <button id="tab-shop" onclick="showTab('shop')">ğŸª è²©å£²</button>
    <button id="tab-quest" onclick="showTab('quest')">ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ</button>
    <button id="tab-market" onclick="showTab('market')">ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</button>
    <button id="tab-machines" onclick="showTab('machines')">ğŸšœ è¾²æ©Ÿ</button>
    <button id="tab-power" onclick="showTab('power')">âš¡ï¸ é›»åŠ›</button>
    <button id="tab-achievements" onclick="showTab('achievements')">ğŸŒŸ é€²æ—</button>
    <button id="tab-settings" onclick="showTab('settings')">âš™ï¸ è¨­å®š</button>
  </div>

  <div id="farm" class="tab-content active">
    <h2>ğŸŒ± è¾²æ¥­</h2>
    <label>ä½œç‰©ã‚’é¸ã¶:</label>
    <select id="cropSelect"></select>
    <button onclick="plantCrop()">ç¨®ã‚’ã¾ãï¼ˆ10Gï¼‰</button>
    <p>åœŸåœ°ã®åºƒã•: <span id="landSize">5</span> / ç¾åœ¨ã®ä½œç‰©æ•°: <span id="cropCount">0</span></p>
    <ul id="crops"></ul>
    <h3>ğŸ“¦ åç©«ç®±</h3>
    <ul id="harvestBox"></ul>
  </div>

  <div id="cook" class="tab-content">
    <h2>ğŸ³ æ–™ç†</h2>
    <label>ãƒ¬ã‚·ãƒ”ã‚’é¸ã¶:</label>
    <select id="recipeSelect"></select>
    <button onclick="cook()">èª¿ç†</button>
    <div id="ingredientInfo"></div>
    <h3>ğŸ“¦ åç©«ç®±</h3>
    <ul id="harvestBoxCook"></ul>
    <h3>ğŸ½ï¸ æ–™ç†åœ¨åº«</h3>
    <ul id="dishInventory"></ul>
  </div>

  <div id="shop" class="tab-content">
    <h2>ğŸª è²©å£²</h2>
    <label>å£²ã‚‹æ–™ç†ã‚’é¸ã¶:</label>
    <select id="sellRecipeSelect"></select>
    <button onclick="putOnShelf()">å•†å“æ£šã«ç½®ã</button>
    <p>å•†å“æ£š: <span id="shelfCount">0</span></p>
    <ul id="shelfList"></ul>
  </div>

  <div id="quest" class="tab-content">
    <h2>ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
    <ul id="quests"></ul>
  </div>

  <div id="market" class="tab-content">
    <h2>ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</h2>
    <button id="land" onclick="buyLand()">åœŸåœ°æ‹¡å¼µï¼ˆ100G + Î±ï¼‰</button>
    <button id="toolWateringCan" onclick="buyTool('ã‚¸ãƒ§ã‚¦ãƒ­')" disabled>ã‚¸ãƒ§ã‚¦ãƒ­è³¼å…¥ï¼ˆ150Gï¼‰- 100XPå¿…è¦</button>
    <button id="toolAutoPlanterCabbage" onclick="buyTool('ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·')" disabled>ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·è³¼å…¥ï¼ˆ3000Gï¼‰- 700XPå¿…è¦</button>
    <button id="toolAutoPlanterTomato" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·')" disabled>ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·è³¼å…¥ï¼ˆ4000Gï¼‰- 1200XPå¿…è¦</button>
    <button id="toolAutoPlanterCarrot" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·')" disabled>ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·è³¼å…¥ï¼ˆ5000Gï¼‰- 1600XPå¿…è¦</button>
    <button id="toolAutoPlanterPotato" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·')" disabled>ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·è³¼å…¥ï¼ˆ7000Gï¼‰- 2400XPå¿…è¦</button>
    <button id="buyPower" onclick="buyPower()" disabled>é›»åŠ›è³¼å…¥ï¼ˆ100EP / 200Gï¼‰- 700XPå¿…è¦</button>
    <button id="cropTomato" onclick="buyCrop('ãƒˆãƒãƒˆ')" disabled>ãƒˆãƒãƒˆã®ç¨®ï¼ˆ100Gï¼‰- 200XPå¿…è¦</button>
    <button id="recipeSalad" onclick="buyRecipe('ãƒˆãƒãƒˆã‚µãƒ©ãƒ€')" disabled>ãƒ¬ã‚·ãƒ”æœ¬ã€ãƒˆãƒãƒˆã‚µãƒ©ãƒ€ã€ï¼ˆ200Gï¼‰- 200XPå¿…è¦</button>
    <button id="cropCarrot" onclick="buyCrop('ãƒ‹ãƒ³ã‚¸ãƒ³')" disabled>ãƒ‹ãƒ³ã‚¸ãƒ³ã®ç¨®ï¼ˆ150Gï¼‰- 400XPå¿…è¦</button>
    <button id="recipeCarrot" onclick="buyRecipe('ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³')" disabled>ãƒ¬ã‚·ãƒ”æœ¬ã€ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³ã€ï¼ˆ200Gï¼‰- 400XPå¿…è¦</button>
    <button id="cropPotato" onclick="buyCrop('ãƒãƒ†ãƒˆ')" disabled>ãƒãƒ†ãƒˆã®ç¨®ï¼ˆ300Gï¼‰- 800XPå¿…è¦</button>
  </div>

  <div id="machines" class="tab-content">
    <h2>ğŸšœ è¾²æ©Ÿ</h2>
    <h3>ç¨®ã¾ãæ©Ÿã®ç¨¼åƒè¨­å®š</h3>
    <div id="planterControls"></div>
  </div>

  <div id="power" class="tab-content">
    <h2>âš¡ï¸ é›»åŠ›</h2>
    <p>é›»åŠ›è³¼å…¥ã¯ã‚·ãƒ§ãƒƒãƒ—ã‚¿ãƒ–ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
    <p>å°†æ¥ã®ç™ºé›»æ©Ÿèƒ½ã¯ã“ã¡ã‚‰ã§ç®¡ç†äºˆå®šã§ã™ã€‚</p>
  </div>

  <div id="achievements" class="tab-content">
    <h2>ğŸŒŸ é€²æ—</h2>
    <p>XPã‚’è²¯ã‚ã¦å ±é…¬ã‚’ç²å¾—ï¼ç‰¹åˆ¥ãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã§è¾²å ´ã‚’ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼</p>
    <ul id="achievementList"></ul>
  </div>

  <div id="settings" class="tab-content">
    <h2>âš™ï¸ è¨­å®š</h2>
    <div class="settings-group">
      <h3>ä¿å­˜ã¨èª­ã¿è¾¼ã¿</h3>
      <div class="button-group">
        <button onclick="saveGame()">ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜</button>
        <button onclick="loadGame()">ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€</button>
      </div>
    </div>
    <div class="settings-group">
      <h3>è‡ªå‹•ä¿å­˜è¨­å®š</h3>
      <p>ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’å®šæœŸçš„ã«è‡ªå‹•ä¿å­˜ã—ã¾ã™ã€‚</p>
      <label for="autoSaveEnabled">è‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹ã«ã™ã‚‹:</label>
      <input type="checkbox" id="autoSaveEnabled" onchange="toggleAutoSave(); saveSettings()">
      <label for="autoSaveInterval">è‡ªå‹•ä¿å­˜é–“éš”ï¼ˆç§’ã€5ä»¥ä¸Šï¼‰:</label>
      <input type="number" id="autoSaveInterval" min="5" value="10" onchange="updateAutoSaveInterval(); saveSettings()">
    </div>
    <div class="settings-group">
      <h3>è‡ªå‹•èª­ã¿è¾¼ã¿è¨­å®š</h3>
      <p>ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
      <label for="autoLoadEnabled">ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å¾©å…ƒ:</label>
      <input type="checkbox" id="autoLoadEnabled" onchange="toggleAutoLoad()">
    </div>
    <div id="saveStatus"></div>
  </div>

 <div id="pauseModal" style="display: none;">
    <div>
      <h2>ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ä¸­</h2>
      <p>ã™ã¹ã¦ã®é€²è¡ŒãŒåœæ­¢ã—ã¦ã„ã¾ã™ã€‚<br>ã‚†ã£ãã‚Šä¼‘æ†©ã—ã¦ãã ã•ã„ã€‚</p>
      <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.1.7</p>
      <div class="button-group">
        <button onclick="togglePause()">ã‚²ãƒ¼ãƒ ã‚’å†é–‹</button>
        <button onclick="window.open('https://github.com/suzurainshade/cooking/', '_blank')">GitHubã¸</button>
      </div>
    </div>
  </div>

<script>
  function rearrangeGlobalStatusForMobile() {
    const isMobile = window.innerWidth <= 480;
    const container = document.getElementById('global-status');

    if (!container.dataset.originalHtml) {
      container.dataset.originalHtml = container.innerHTML;
    }

    if (isMobile) {
      container.innerHTML = `
        <div style="display: flex; gap: 12px;">
          <span>æ‰€æŒé‡‘: <span id="money">100</span>G</span>
          <span>çµŒé¨“å€¤: <span id="xp">0</span>XP</span>
        </div>
        <div style="display: flex; gap: 12px;">
          <span>è©•åˆ¤: <span id="rp">5.00</span>RP</span>
          <span>é›»åŠ›: <span id="ep">0</span>EP</span>
        </div>
        <button id="pauseButton" onclick="togglePause()">â¸</button>
      `;
    } else {
      container.innerHTML = container.dataset.originalHtml;
    }
  }

  // å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
  window.addEventListener('load', rearrangeGlobalStatusForMobile);
  window.addEventListener('resize', rearrangeGlobalStatusForMobile);


  let money = 100;
  let xp = 0;
  let rp = 5.0;
  let ep = 0;
  let landSize = 5;
  let crops = [];
  let harvestBox = {};
  let dishInventory = {};
  let shelf = [];
  let quests = [];
  let tools = { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
  let activePlanters = { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
  let unlockedCrops = ['ã‚­ãƒ£ãƒ™ãƒ„'];
  let unlockedRecipes = ['ç„¼ãã‚­ãƒ£ãƒ™ãƒ„'];
  let growthBonus = 0;
  let seasonings = {};
  let advancedInventory = [];
  let currentAdvancedRecipe = null;
  let currentAdvancedSteps = [];
  let autoSaveEnabled = true;
  let autoSaveInterval = 10000;
  let autoLoadEnabled = false;
  let autoSaveTimer = null;
  let purchasedItems = new Set();
  let newQuestAvailable = false;
  let lastPowerConsumption = Date.now();
  let isPaused = false;
  let questTimer = null;
  let achievements = [
    { id: 'xp100', name: 'åˆç´šè¾²å®¶', xp: 100, reward: { gold: 50, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 5 } }, achieved: false, claimed: false },
    { id: 'xp200', name: 'ãƒˆãƒãƒˆé–‹æ‹“è€…', xp: 200, reward: { gold: 100, crops: ['ãƒˆãƒãƒˆ'] }, achieved: false, claimed: false },
    { id: 'xp300', name: 'é›»åŠ›åˆå¿ƒè€…', xp: 300, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
    { id: 'xp400', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³è¾²å®¶', xp: 400, reward: { gold: 200, crops: ['ãƒ‹ãƒ³ã‚¸ãƒ³'] }, achieved: false, claimed: false },
    { id: 'xp500', name: 'ä¸­ç´šè¾²å®¶', xp: 500, reward: { gold: 250, ep: 50 }, achieved: false, claimed: false },
    { id: 'planterCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„å·å°å…¥', planter: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', reward: { ep: 100, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 10 } }, achieved: false, claimed: false },
    { id: 'planterTomato', name: 'ãƒˆãƒãƒˆå·å°å…¥', planter: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', reward: { ep: 150, items: { 'ãƒˆãƒãƒˆ': 5 } }, achieved: false, claimed: false },
    { id: 'planterCarrot', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³å·å°å…¥', planter: 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·', reward: { ep: 200, items: { 'ãƒ‹ãƒ³ã‚¸ãƒ³': 5 } }, achieved: false, claimed: false },
    { id: 'planterPotato', name: 'ãƒãƒ†ãƒˆå·å°å…¥', planter: 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·', reward: { ep: 300, items: { 'ãƒãƒ†ãƒˆ': 5 } }, achieved: false, claimed: false }
  ];

  const recipeData = {
    'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': {
      ingredients: { 'ã‚­ãƒ£ãƒ™ãƒ„': 1 },
      rewardPerDish: 25,
      sellPrice: 20
    },
    'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': {
      ingredients: { 'ã‚­ãƒ£ãƒ™ãƒ„': 1, 'ãƒˆãƒãƒˆ': 1 },
      rewardPerDish: 55,
      sellPrice: 45
    },
    'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': {
      ingredients: { 'ãƒ‹ãƒ³ã‚¸ãƒ³': 1 },
      rewardPerDish: 30,
      sellPrice: 25
    }
  };

  const unlockThresholds = {
    'ã‚¸ãƒ§ã‚¦ãƒ­': 100,
    'ãƒˆãƒãƒˆ': 200,
    'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 200,
    'ãƒ‹ãƒ³ã‚¸ãƒ³': 400,
    'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 400,
    'ãƒãƒ†ãƒˆ': 800,
    'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 700,
    'é›»åŠ›è³¼å…¥': 700,
    'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 1200,
    'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 1600,
    'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 2400
  };

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if (tabId === 'settings') {
      document.getElementById('saveStatus').style.display = 'none';
      updateSettingsUI();
    }
    if (tabId === 'quest') {
      newQuestAvailable = false;
      updateTabNotifications();
    }
    if (tabId === 'machines') {
      updatePlanterControls();
    }
    if (tabId === 'achievements') {
      updateAchievementList();
    }
  }

  function addXP(amount) {
    xp += amount;
    checkAchievements();
    updateUI();
  }

  function checkAchievements() {
    achievements.forEach(a => {
      if (!a.achieved) {
        if (a.xp && xp >= a.xp) {
          a.achieved = true;
          showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
        } else if (a.planter && tools[a.planter] > 0) {
          a.achieved = true;
          showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
        }
      }
    });
    updateAchievementList();
  }

  function claimAchievement(id) {
    const achievement = achievements.find(a => a.id === id);
    if (achievement && achievement.achieved && !achievement.claimed) {
      achievement.claimed = true;
      if (achievement.reward.gold) money += achievement.reward.gold;
      if (achievement.reward.ep) ep += achievement.reward.ep;
      if (achievement.reward.items) {
        for (const [item, count] of Object.entries(achievement.reward.items)) {
          harvestBox[item] = (harvestBox[item] || 0) + count;
        }
      }
      if (achievement.reward.crops) {
        achievement.reward.crops.forEach(crop => {
          if (!unlockedCrops.includes(crop) && !purchasedItems.has(crop)) {
            unlockedCrops.push(crop);
            purchasedItems.add(crop);
          }
        });
      }
      showSaveStatus(`é€²æ—ã€Œ${achievement.name}ã€ã®å ±é…¬ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼`, true);
      updateAchievementList();
      updateUI();
    }
  }

  function updateAchievementList() {
    const list = document.getElementById('achievementList');
    list.innerHTML = achievements.map(a => {
      const rewardText = [
        a.reward.gold ? `${a.reward.gold}G` : '',
        a.reward.ep ? `${a.reward.ep}EP` : '',
        a.reward.items ? Object.entries(a.reward.items).map(([k, v]) => `${k} x${v}`).join(', ') : '',
        a.reward.crops ? a.reward.crops.map(c => `${c}ã®ç¨®`).join(', ') : ''
      ].filter(t => t).join(', ');
      return `
        <li class="${a.achieved ? 'achieved' : 'unachieved'}">
          ${a.name}ï¼ˆ${a.xp ? `${a.xp}XP` : a.planter}ï¼‰: ${rewardText}
          ${a.achieved && !a.claimed ? `<button onclick="claimAchievement('${a.id}')">å ±é…¬ã‚’å—ã‘å–ã‚‹</button>` : a.claimed ? 'ï¼ˆå—å–æ¸ˆï¼‰' : ''}
        </li>
      `;
    }).join('');
  }

  function togglePause() {
    isPaused = !isPaused;
    document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
    document.getElementById('pauseButton').textContent = isPaused ? 'â–¶ï¸ å†é–‹' : 'â¸ï¸ ä¸€æ™‚åœæ­¢';
    if (!isPaused) {
      lastPowerConsumption = Date.now();
      if (questTimer) clearTimeout(questTimer);
      scheduleQuest();
    }
  }

  document.onkeydown = function(e) {
    if (e.key === 'Escape') {
      togglePause();
    }
  };

  function updateRP(amount) {
    rp = Math.max(0, Math.min(10, rp + amount));
    updateUI();
  }

  function getQuestInterval() {
    const minInterval = 30000 + (60000 - 30000) * ((rp - 1) / 9);
    const maxInterval = 70000 + (135000 - 70000) * ((rp - 1) / 9);
    return Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
  }

  function getSellProbability() {
    return 0.04 - (0.04 - 0.0167) * ((rp - 1) / 9);
  }

  function checkUnlocks() {
    const items = [
      { id: 'toolWateringCan', name: 'ã‚¸ãƒ§ã‚¦ãƒ­', cost: 150, type: 'tool' },
      { id: 'toolAutoPlanterCabbage', name: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', cost: 3000, type: 'tool' },
      { id: 'toolAutoPlanterTomato', name: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', cost: 4000, type: 'tool' },
      { id: 'toolAutoPlanterCarrot', name: 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·', cost: 5000, type: 'tool' },
      { id: 'toolAutoPlanterPotato', name: 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·', cost: 7000, type: 'tool' },
      { id: 'buyPower', name: 'é›»åŠ›è³¼å…¥', cost: 200, type: 'power' },
      { id: 'cropTomato', name: 'ãƒˆãƒãƒˆ', cost: 100, type: 'crop' },
      { id: 'recipeSalad', name: 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€', cost: 200, type: 'recipe' },
      { id: 'cropCarrot', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³', cost: 150, type: 'crop' },
      { id: 'recipeCarrot', name: 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³', cost: 200, type: 'recipe' },
      { id: 'cropPotato', name: 'ãƒãƒ†ãƒˆ', cost: 300, type: 'crop' }
    ];

    items.forEach(item => {
      const button = document.getElementById(item.id);
      if (button) {
        if (item.type === 'tool' && item.name.startsWith('ç¨®ã¾ãæ©Ÿ')) {
          button.style.display = tools[item.name] >= landSize ? 'none' : 'block';
          button.disabled = xp < unlockThresholds[item.name];
          button.textContent = xp >= unlockThresholds[item.name]
            ? `${item.name}è³¼å…¥ï¼ˆ${item.cost}Gï¼‰`
            : `${item.name}è³¼å…¥ï¼ˆ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
        } else if (item.type === 'power') {
          button.style.display = 'block';
          button.disabled = xp < unlockThresholds[item.name];
          button.textContent = xp >= unlockThresholds[item.name]
            ? `é›»åŠ›è³¼å…¥ï¼ˆ100EP / ${item.cost}Gï¼‰`
            : `é›»åŠ›è³¼å…¥ï¼ˆ100EP / ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
        } else {
          button.style.display = purchasedItems.has(item.name) ? 'none' : 'block';
          button.disabled = xp < unlockThresholds[item.name];
          button.textContent = xp >= unlockThresholds[item.name]
            ? `${item.name}${item.type === 'tool' ? 'è³¼å…¥' : item.type === 'crop' ? 'ã®ç¨®' : 'ãƒ¬ã‚·ãƒ”æœ¬ã€' + item.name + 'ã€'}ï¼ˆ${item.cost}Gï¼‰`
            : `${item.name}${item.type === 'tool' ? 'è³¼å…¥' : item.type === 'crop' ? 'ã®ç¨®' : 'ãƒ¬ã‚·ãƒ”æœ¬ã€' + item.name + 'ã€'}ï¼ˆ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
        }
      }
    });
  }

  function checkGameOver() {
    const hasNoItems =
      Object.keys(harvestBox).length === 0 &&
      Object.keys(dishInventory).length === 0 &&
      shelf.length === 0 &&
      crops.length === 0;
    if (money < 10 && hasNoItems) {
      money += 10;
      showSaveStatus('æ‰€æŒé‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æ•‘æ¸ˆã¨ã—ã¦10Gã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚', true);
      updateUI();
    }
  }

  function checkQuestDeadlines() {
    const now = Date.now();
    quests.forEach(q => {
      const elapsed = (now - q.id) / 1000;
      if (elapsed > 10 && elapsed <= 30) {
        updateRP(0.05);
        if (elapsed >= 30) {
          showSaveStatus(`ã‚¯ã‚¨ã‚¹ãƒˆã€Œ${q.recipeName} ${q.dishNeed}å€‹ã€ãŒæœŸé™åˆ‡ã‚Œã§è©•åˆ¤ãŒä¸‹ãŒã‚Šã¾ã—ãŸã€‚`, false);
        }
      }
    });
    updateQuests();
  }

  function consumePower() {
    const now = Date.now();
    if (now - lastPowerConsumption >= 10000) {
      const totalActive = Object.values(activePlanters).reduce((sum, count) => sum + count, 0);
      if (totalActive > 0) {
        if (ep >= totalActive) {
          ep -= totalActive;
          lastPowerConsumption = now;
        } else {
          Object.keys(activePlanters).forEach(name => activePlanters[name] = 0);
          showSaveStatus('é›»åŠ›ä¸è¶³ã§ç¨®ã¾ãæ©ŸãŒåœæ­¢ã—ã¾ã—ãŸã€‚', false);
          updatePlanterControls();
        }
        updateUI();
      }
    }
  }

  function autoPlant() {
    const planters = [
      { name: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', crop: 'ã‚­ãƒ£ãƒ™ãƒ„' },
      { name: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', crop: 'ãƒˆãƒãƒˆ' },
      { name: 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·', crop: 'ãƒ‹ãƒ³ã‚¸ãƒ³' },
      { name: 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·', crop: 'ãƒãƒ†ãƒˆ' }
    ];
    let plantCount = 0;
    planters.forEach(planter => {
      const activeCount = activePlanters[planter.name] || 0;
      for (let i = 0; i < activeCount && money >= 10 && crops.length < landSize && plantCount < landSize; i++) {
        if (unlockedCrops.includes(planter.crop)) {
          money -= 10;
          crops.push({ type: planter.crop, growth: 0, maxGrowth: 5 });
          addXP(1);
          plantCount++;
        }
      }
    });
    updateUI();
  }

  function plantCrop() {
    const select = document.getElementById('cropSelect');
    const type = select.value;
    if (!unlockedCrops.includes(type)) return;
    if (money >= 10 && crops.length < landSize) {
      money -= 10;
      crops.push({ type, growth: 0, maxGrowth: 5 });
      addXP(1);
      updateUI();
    }
  }

  function growCrops() {
    crops.forEach(c => {
      if (c.growth < c.maxGrowth) {
        c.growth = Math.min(c.growth + 1 + growthBonus, c.maxGrowth);
      }
    });
    const ready = crops.filter(c => c.growth >= c.maxGrowth);
    for (const c of ready) {
      harvestBox[c.type] = (harvestBox[c.type] || 0) + 1;
    }
    crops = crops.filter(c => c.growth < c.maxGrowth);
  }

  function cook() {
    const type = document.getElementById('recipeSelect').value;
    const recipe = recipeData[type];
    if (!recipe || !unlockedRecipes.includes(type)) return;

    let canCook = Object.entries(recipe.ingredients).every(([crop, count]) =>
      (harvestBox[crop] || 0) >= count
    );

    if (canCook) {
      for (const [crop, count] of Object.entries(recipe.ingredients)) {
        harvestBox[crop] -= count;
      }
      dishInventory[type] = (dishInventory[type] || 0) + 1;
      addXP(1);
      updateUI();
    }
  }

  function putOnShelf() {
    const type = document.getElementById('sellRecipeSelect').value;
    if ((dishInventory[type] || 0) > 0) {
      dishInventory[type]--;
      shelf.push(type);
      addXP(1);
      updateUI();
    }
  }

  function sellFromShelf() {
    if (shelf.length > 0 && Math.random() < getSellProbability()) {
      const sold = shelf.shift();
      const price = recipeData[sold]?.sellPrice || 20;
      money += price;
      addXP(1);
      updateRP(-0.04);
      updateUI();
    }
  }

  function updateQuests() {
    const now = Date.now();
    const list = document.getElementById('quests');
    list.innerHTML = quests.map(q => {
      const elapsed = Math.floor((now - q.id) / 1000);
      return `<li>${q.recipeName} ${q.dishNeed}å€‹ â†’ ${q.reward}Gï¼ˆçµŒéæ™‚é–“: ${elapsed}ç§’ï¼‰ <button onclick="completeQuest(${q.id})">ç´å“</button></li>`;
    }).join('');
    updateTabNotifications();
  }

  function scheduleQuest() {
    if (!isPaused) {
      generateQuest();
      questTimer = setTimeout(scheduleQuest, getQuestInterval());
    }
  }

  function generateQuest() {
    const recipeName = unlockedRecipes[Math.floor(Math.random() * unlockedRecipes.length)];
    const recipe = recipeData[recipeName];
    const dishNeed = Math.floor(Math.random() * 3) + 1;
    const reward = dishNeed * recipe.rewardPerDish;
    const id = Date.now();
    const deadline = id + 10000;
    quests.push({ id, dishNeed, reward, recipeName, deadline });
    newQuestAvailable = true;
    updateQuests();
  }

  function completeQuest(id) {
    const q = quests.find(q => q.id === id);
    if ((dishInventory[q.recipeName] || 0) >= q.dishNeed) {
      dishInventory[q.recipeName] -= q.dishNeed;
      money += q.reward;
      const elapsed = (Date.now() - q.id) / 1000;
      if (elapsed <= 10) {
        updateRP(-0.05);
      }
      quests = quests.filter(q0 => q0.id !== id);
      addXP(1);
      updateUI();
      updateQuests();
    }
  }

  function buyLand() {
    const cost = 100 + landSize * 10;
    if (money >= cost) {
      money -= cost;
      landSize += 5;
      updateUI();
    }
  }

  function buyTool(name) {
    if (xp < unlockThresholds[name]) return;
    const cost = name === 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·' ? 3000 :
                 name === 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·' ? 4000 :
                 name === 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·' ? 5000 :
                 name === 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·' ? 7000 : 150;
    if (name.startsWith('ç¨®ã¾ãæ©Ÿ') && tools[name] >= landSize) return;
    if (money >= cost) {
      money -= cost;
      tools[name] = (tools[name] || 0) + 1;
      if (!name.startsWith('ç¨®ã¾ãæ©Ÿ')) purchasedItems.add(name);
      if (name === 'ã‚¸ãƒ§ã‚¦ãƒ­') growthBonus = 1;
      checkAchievements();
      updatePlanterControls();
      updateUI();
    }
  }

  function buyPower() {
    if (xp < unlockThresholds['é›»åŠ›è³¼å…¥']) return;
    if (money >= 200) {
      money -= 200;
      ep += 100;
      updateUI();
    }
  }

  function buyCrop(name) {
    if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
    const cost = name === 'ãƒ‹ãƒ³ã‚¸ãƒ³' ? 150 : name === 'ãƒãƒ†ãƒˆ' ? 300 : 100;
    if (money >= cost && !unlockedCrops.includes(name)) {
      money -= cost;
      unlockedCrops.push(name);
      purchasedItems.add(name);
      updateUI();
    }
  }

  function buyRecipe(name) {
    if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
    if (money >= 200 && !unlockedRecipes.includes(name)) {
      money -= 200;
      unlockedRecipes.push(name);
      purchasedItems.add(name);
      updateUI();
    }
  }

  function updatePlanterControls() {
    const controls = document.getElementById('planterControls');
    const planters = [
      'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·',
      'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·',
      'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·',
      'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'
    ];
    controls.innerHTML = planters.map(name => {
      const owned = tools[name] || 0;
      if (owned === 0) return '';
      const options = Array.from({ length: owned + 1 }, (_, i) => i);
      return `
        <div style="margin-bottom: 10px;">
          <label>${name} ç¨¼åƒå°æ•°ï¼ˆæ‰€æŒ: ${owned}å°ï¼‰:</label>
          <select id="planter-${name}" onchange="updateĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€Ñ‹('${name}')">
            ${options.map(i => `<option value="${i}" ${activePlanters[name] === i ? 'selected' : ''}>${i}å°</option>`).join('')}
          </select>
        </div>
      `;
    }).join('');
  }

  function updateActivePlanter(name) {
    const select = document.getElementById(`planter-${name}`);
    activePlanters[name] = parseInt(select.value);
    updateUI();
  }

  function updateTabNotifications() {
    const shopTab = document.getElementById('tab-shop');
    const questTab = document.getElementById('tab-quest');

    if (shelf.length === 0) {
      shopTab.innerHTML = 'ğŸª è²©å£²<span class="badge">âš ï¸</span>';
    } else {
      shopTab.innerHTML = 'ğŸª è²©å£²';
    }

    if (newQuestAvailable && quests.length > 0) {
      questTab.innerHTML = 'ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ<span class="badge">ğŸ””</span>';
    } else {
      questTab.innerHTML = 'ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ';
    }
  }

  function updateUI() {
    document.getElementById('land').innerText = `åœŸåœ°æ‹¡å¼µï¼ˆ${100 + landSize * 10}Gï¼‰`;
    document.getElementById('money').textContent = money;
    document.getElementById('xp').textContent = xp;
    document.getElementById('rp').textContent = rp.toFixed(2);
    document.getElementById('ep').textContent = ep;
    document.getElementById('landSize').textContent = landSize;
    document.getElementById('cropCount').textContent = crops.length;

    document.getElementById('crops').innerHTML = crops.map(c => `<li>${c.type} - æˆé•·: ${c.growth}/5</li>`).join('');

    const harvestList = Object.entries(harvestBox).map(([k,v]) => `<li>${k} x ${v}</li>`).join('');
    document.getElementById('harvestBox').innerHTML = harvestList;
    document.getElementById('harvestBoxCook').innerHTML = harvestList;

    const cropSelect = document.getElementById('cropSelect');
    const selectedCrop = cropSelect.value;
    cropSelect.innerHTML = unlockedCrops.map(c => `<option value="${c}">${c}</option>`).join('');
    cropSelect.value = unlockedCrops.includes(selectedCrop) ? selectedCrop : unlockedCrops[0] || '';

    const recipeSelect = document.getElementById('recipeSelect');
    const selectedRecipe = recipeSelect.value;
    recipeSelect.innerHTML = unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('');
    recipeSelect.value = selectedRecipe;

    const sellRecipeSelect = document.getElementById('sellRecipeSelect');
    const selectedSell = sellRecipeSelect.value;
    sellRecipeSelect.innerHTML = unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('');
    sellRecipeSelect.value = selectedSell;

    const recipe = recipeData[selectedRecipe] || {ingredients: {}};
    const ingredients = Object.entries(recipe.ingredients).map(([k,v]) => `${k} x${v}`).join(', ');
    document.getElementById('ingredientInfo').innerText = `å¿…è¦ææ–™: ${ingredients}`;

    const dishList = Object.entries(dishInventory).map(([k,v]) => `<li>${k} x ${v}</li>`).join('');
    document.getElementById('dishInventory').innerHTML = dishList;

    document.getElementById('shelfCount').textContent = shelf.length;
    document.getElementById('shelfList').innerHTML = shelf.map(name => `<li>${name} (${recipeData[name]?.sellPrice || 20}G)</li>`).join('');

    checkUnlocks();
    updateTabNotifications();
  }

  function showSaveStatus(message, isSuccess) {
    const statusDiv = document.getElementById('saveStatus');
    statusDiv.textContent = message;
    statusDiv.className = isSuccess ? 'success' : 'error';
    statusDiv.style.display = 'block';
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }

  function saveGame() {
    try {
      const data = {
        version: '2.1.7',
        money,
        xp,
        rp,
        ep,
        landSize,
        crops: crops.filter(c => unlockedCrops.includes(c.type)),
        harvestBox: Object.fromEntries(
          Object.entries(harvestBox).filter(([k]) => unlockedCrops.includes(k))
        ),
        dishInventory,
        shelf,
        quests,
        tools,
        activePlanters,
        unlockedCrops,
        unlockedRecipes,
        seasonings,
        advancedInventory,
        growthBonus,
        currentAdvancedRecipe,
        currentAdvancedSteps,
        autoSaveEnabled,
        autoSaveInterval,
        autoLoadEnabled,
        purchasedItems: Array.from(purchasedItems),
        lastPowerConsumption,
        achievements,
        isPaused
      };
      localStorage.setItem('farmingGameSave', JSON.stringify(data));
      showSaveStatus('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
    } catch (error) {
      showSaveStatus('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
    }
  }

  function loadGame() {
    try {
      const save = localStorage.getItem('farmingGameSave');
      if (save) {
        const data = JSON.parse(save);
        money = data.money || 100;
        xp = data.xp || 0;
        rp = data.rp !== undefined ? data.rp : 5.0;
        ep = data.ep || 0;
        landSize = data.landSize || 5;

        if (data.version !== '2.1.7') {
          crops = (data.crops || []).map(c => ({
            ...c,
            type: c.type === 'é‡èœ' || c.type === 'ãƒãƒ†ãƒˆ' ? 'ã‚­ãƒ£ãƒ™ãƒ„' : c.type === 'ã‚­ãƒ£ãƒ™ãƒ„' ? 'ãƒ‹ãƒ³ã‚¸ãƒ³' : c.type
          })).filter(c => unlockedCrops.includes(c.type));
          harvestBox = Object.fromEntries(
            Object.entries(data.harvestBox || {}).map(([k, v]) => [
              k === 'é‡èœ' || k === 'ãƒãƒ†ãƒˆ' ? 'ã‚­ãƒ£ãƒ™ãƒ„' : k === 'ã‚­ãƒ£ãƒ™ãƒ„' ? 'ãƒ‹ãƒ³ã‚¸ãƒ³' : k,
              v
            ]).filter(([k]) => unlockedCrops.includes(k))
          );
          unlockedCrops = (data.unlockedCrops || ['ã‚­ãƒ£ãƒ™ãƒ„']).map(c =>
            c === 'é‡èœ' || c === 'ãƒãƒ†ãƒˆ' ? 'ã‚­ãƒ£ãƒ™ãƒ„' : c === 'ã‚­ãƒ£ãƒ™ãƒ„' ? 'ãƒ‹ãƒ³ã‚¸ãƒ³' : c
          );
        } else {
          crops = (data.crops || []).filter(c => unlockedCrops.includes(c.type));
          harvestBox = Object.fromEntries(
            Object.entries(data.harvestBox || {}).filter(([k]) => unlockedCrops.includes(k))
          );
          unlockedCrops = data.unlockedCrops || ['ã‚­ãƒ£ãƒ™ãƒ„'];
        }

        dishInventory = Object.fromEntries(
          Object.entries(data.dishInventory || {}).map(([k, v]) => [
            k === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : k === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : k === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : k,
            v
          ])
        );
        shelf = (data.shelf || []).map(s =>
          s === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : s === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : s === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : s
        );
        quests = (data.quests || []).map(q => ({
          ...q,
          recipeName: q.recipeName === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : q.recipeName === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : q.recipeName === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : q.recipeName
        }));

        tools = {
          'ã‚¸ãƒ§ã‚¦ãƒ­': data.tools?.['ã‚¸ãƒ§ã‚¦ãƒ­'] || 0,
          'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': data.tools?.['ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·'] || data.tools?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || data.tools?.['è‡ªå‹•æ’­ç¨®æ©Ÿ'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || 0
        };
        activePlanters = {
          'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·'] || data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || data.activePlanters?.['è‡ªå‹•æ’­ç¨®æ©Ÿ'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·'] || 0,
          'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || 0
        };

        unlockedRecipes = (data.unlockedRecipes || ['ç„¼ãã‚­ãƒ£ãƒ™ãƒ„']).map(r =>
          r === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : r === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : r === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : r
        );
        seasonings = data.seasonings || {};
        advancedInventory = data.advancedInventory || [];
        growthBonus = data.growthBonus || 0;
        currentAdvancedRecipe = data.currentAdvancedRecipe || null;
        currentAdvancedSteps = data.currentAdvancedSteps || [];
        autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
        autoSaveInterval = data.autoSaveInterval || 10000;
        autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : false;
        purchasedItems = new Set(
          (data.purchasedItems || []).map(item =>
            item === 'è‡ªå‹•æ’­ç¨®æ©Ÿ' || item === 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·' ? 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·' : item === 'ã‚­ãƒ£ãƒ™ãƒ„' ? 'ãƒ‹ãƒ³ã‚¸ãƒ³' : item
          )
        );
        lastPowerConsumption = data.lastPowerConsumption || Date.now();
        achievements = data.achievements || achievements.map(a => ({ ...a, achieved: false, claimed: false }));
        isPaused = data.isPaused || false;
        document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
        document.getElementById('pauseButton').textContent = isPaused ? 'â¸ï¸ åœæ­¢ä¸­' : ' â¸ï¸';
        updateSettingsUI();
        updateAchievementList();
        updateUI();
        updateQuests();
        updatePlanterControls();
        startAutoSave();
        showSaveStatus('ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', true);
      } else {
        showSaveStatus('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', false);
      }
    } catch (error) {
      showSaveStatus('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, false);
    }
  }

  function updateSettingsUI() {
    document.getElementById('autoSaveEnabled').checked = autoSaveEnabled;
    document.getElementById('autoSaveInterval').value = autoSaveInterval / 1000;
    document.getElementById('autoLoadEnabled').checked = autoLoadEnabled;
  }

  function toggleAutoSave() {
    autoSaveEnabled = document.getElementById('autoSaveEnabled').checked;
    startAutoSave();
    saveSettings();
  }

  function toggleAutoLoad() {
    autoLoadEnabled = document.getElementById('autoLoadEnabled').checked;
    saveSettings();
  }

  function updateAutoSaveInterval() {
    const input = document.getElementById('autoSaveInterval');
    let value = parseInt(input.value) * 1000;
    if (value < 5000) {
      value = 5000;
      input.value = 5;
    }
    autoSaveInterval = value;
    startAutoSave();
    saveSettings();
  }

  function saveSettings() {
    try {
      const data = {
        autoSaveEnabled,
        autoSaveInterval,
        autoLoadEnabled
      };
      localStorage.setItem('farmingGameSettings', JSON.stringify(data));
      showSaveStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
    } catch (error) {
      showSaveStatus('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
    }
  }

  function loadSettings() {
    try {
      const settings = localStorage.getItem('farmingGameSettings');
      if (settings) {
        const data = JSON.parse(settings);
        autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
        autoSaveInterval = data.autoSaveInterval || 10000;
        autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : false;
      }
    } catch (error) {
      console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
    }
  }

  function startAutoSave() {
    if (autoSaveTimer) {
      clearInterval(autoSaveTimer);
      autoSaveTimer = null;
    }
    if (autoSaveEnabled) {
      autoSaveTimer = setInterval(saveGame, autoSaveInterval);
    }
  }

  loadSettings();
  updateSettingsUI();
  startAutoSave();
  if (autoLoadEnabled) {
    loadGame();
  }

  scheduleQuest();

  setInterval(() => {
    if (!isPaused) {
      growCrops();
      sellFromShelf();
      checkGameOver();
      checkQuestDeadlines();
      consumePower();
      if (shelf.length === 0) {
        updateRP(0.1);
      }
      autoPlant();
      updateUI();
    }
  }, 1000);
</script>
</body>
</html>
