<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking</title>
  <link rel="icon" href="cooking.png">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f9f9f9;
    color: #333;
  }

  #global-status {
    position: relative;
    margin: 12px auto 6px;
    text-align: center;
    width: fit-content;
    padding: 8px 16px;
    background: #fcfcfc;
    border-radius: 8px;
    border: 1px solid #bbb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    font-weight: bold;
    color: #222;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #pauseButton {
    padding: 6px 12px;
    font-size: 14px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #pauseButton:hover {
    background-color: #45a049;
  }

  #tabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background-color: #ffffff;
    padding: 8px;
    gap: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  #tabs button {
    background-color: #f5f5f5;
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 15px;
    cursor: pointer;
    color: #333;
    transition: background-color 0.2s, color 0.2s;
    flex: 1 0 auto;
    min-width: 90px;
    position: relative;
  }

  #tabs button:hover {
    background-color: #ebebeb;
  }

  #tabs button.active-tab {
    background-color: #e0f2e9;
    font-weight: bold;
    color: #2d7a4d;
    border: 1px solid #4CAF50;
  }

  #tabs button .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #f44336;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .tab-content {
    display: none;
    padding: 20px;
    max-width: 800px;
    margin: 20px auto;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .tab-content.active {
    display: block;
  }

  #achievements-subtabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background-color: #f8f8f8;
    padding: 8px;
    gap: 6px;
    margin-bottom: 20px;
    border-radius: 6px;
  }

  #achievements-subtabs button {
    background-color: #e8e8e8;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: #333;
    transition: background-color 0.2s, color 0.2s;
    flex: 1 0 auto;
    min-width: 80px;
  }

  #achievements-subtabs button:hover {
    background-color: #d8d8d8;
  }

  #achievements-subtabs button.active-subtab {
    background-color: #d0e8db;
    font-weight: bold;
    color: #2d7a4d;
    border: 1px solid #4CAF50;
  }

  h2 {
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
    margin-bottom: 15px;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }

  select,
  input[type="number"],
  input[type="checkbox"] {
    padding: 8px 12px;
    margin-bottom: 10px;
    font-size: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box;
  }

  button {
    padding: 10px 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    margin: 5px 0;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background-color: #45a049;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .delete-button {
    background-color: #f44336;
  }

  .delete-button:hover {
    background-color: #d32f2f;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  ul li {
    padding: 8px 12px;
    background-color: #f4f4f4;
    border-radius: 6px;
    margin-bottom: 6px;
    border: 1px solid #ddd;
    font-size: 15px;
  }

  #achievementList li.achieved {
    background-color: #c8e6c9;
    border: 1px solid #4CAF50;
  }

  #achievementList li.unachieved {
    background-color: #e0e0e0;
    border: 1px solid #ccc;
    color: #666;
  }

  #ingredientInfo {
    background-color: #e8f5e9;
    padding: 10px 14px;
    border-left: 4px solid #4CAF50;
    margin: 10px 0;
    border-radius: 6px;
    font-size: 14px;
  }

  #saveStatus {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
    transition: opacity 0.3s ease;
  }

  #saveStatus.success {
    background-color: #e8f5e9;
    border-left: 4px solid #4CAF50;
    display: block;
  }

  #saveStatus.error {
    background-color: #ffebee;
    border-left: 4px solid #f44336;
    display: block;
  }

  .settings-group {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .settings-group p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #555;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #pauseModal, #deleteConfirmModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #pauseModal > div, #deleteConfirmModal > div {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  @media (min-width: 481px) {
    .button-group {
      flex-direction: row;
    }

    button {
      width: auto;
    }

    select,
    input[type="number"],
    input[type="checkbox"] {
      width: auto;
    }
  }

  @media (max-width: 480px) {
    #global-status {
      flex-direction: column;
      align-items: flex-start;
    }

    #tabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: auto;
      gap: 6px;
    }

    #achievements-subtabs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
  }

  #shop-subtabs button.active-subtab {
  background-color: #4CAF50;
  color: white;
}
#shop-subtabs button {
  margin-right: 5px;
}
</style>
</head>
<body>
  <div id="global-status">
    æ‰€æŒé‡‘: <span id="money">100</span>G | çµŒé¨“å€¤: <span id="xp">0</span>XP | è©•åˆ¤: <span id="rp">5.00</span>RP | é›»åŠ›: <span id="ep">0</span>EP
    <button id="pauseButton" onclick="togglePause(true)">â¸</button>
  </div>

  <div id="gameTime">
    æ—¥ä»˜: 0æ—¥ 0æ™‚ 0åˆ†
  </div>

  <div id="currentWeather">
    å¤©å€™: æ™´ã‚Œ
  </div>

  <div id="tabs">
    <button id="tab-farm" onclick="showTab('farm')">ğŸŒ± è¾²æ¥­</button>
    <button id="tab-cook" onclick="showTab('cook')">ğŸ³ æ–™ç†</button>
    <button id="tab-shop" onclick="showTab('shop')">ğŸª è²©å£²</button>
    <button id="tab-quest" onclick="showTab('quest')">ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ</button>
    <button id="tab-market" onclick="showTab('market')">ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</button>
    <button id="tab-machines" onclick="showTab('machines')">ğŸšœ è¾²æ©Ÿ</button>
    <button id="tab-power" onclick="showTab('power')">âš¡ï¸ é›»åŠ›</button>
    <button id="tab-management" onclick="showTab('management')">ğŸ’¼ çµŒå–¶</button>
    <button id="tab-achievements" onclick="showTab('achievements')">ğŸŒŸ é€²æ—</button>
    <button id="tab-settings" onclick="showTab('settings')">âš™ï¸ è¨­å®š</button>
  </div>

  <div id="farm" class="tab-content active">
    <h2>ğŸŒ± è¾²æ¥­</h2>
    <label>ä½œç‰©ã‚’é¸ã¶:</label>
    <select id="cropSelect"></select>
    <button onclick="plantCrop()">ç¨®ã‚’ã¾ãï¼ˆ10Gï¼‰</button>
    <p>åœŸåœ°ã®åºƒã•: <span id="landSize">5</span> / ç¾åœ¨ã®ä½œç‰©æ•°: <span id="cropCount">0</span></p>
    <ul id="crops"></ul>
    <h3>ğŸ“¦ åç©«ç®±</h3>
    <ul id="harvestBox"></ul>
  </div>

  <div id="cook" class="tab-content">
    <h2>ğŸ³ æ–™ç†</h2>
    <label>ãƒ¬ã‚·ãƒ”ã‚’é¸ã¶:</label>
    <select id="recipeSelect"></select>
    <button onclick="cook()">èª¿ç†</button>
    <div id="ingredientInfo"></div>
    <h3>ğŸ“¦ åç©«ç®±</h3>
    <ul id="harvestBoxCook"></ul>
    <h3>ğŸ½ï¸ æ–™ç†åœ¨åº«</h3>
    <ul id="dishInventory"></ul>
  </div>

<div id="shop" class="tab-content">
  <h2>ğŸª è²©å£²</h2>
  <div id="shop-subtabs"></div>
  <div id="shop-content"></div>
</div>

  <div id="quest" class="tab-content">
    <h2>ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
    <ul id="questList"></ul>
    <ul id="quests"></ul>
  </div>

  <div id="market" class="tab-content">
    <h2>ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</h2>
    <button id="land" onclick="buyLand()">åœŸåœ°æ‹¡å¼µï¼ˆ100G + Î±ï¼‰</button>
    <button id="toolWateringCan" onclick="buyTool('ã‚¸ãƒ§ã‚¦ãƒ­')" disabled>ã‚¸ãƒ§ã‚¦ãƒ­è³¼å…¥ï¼ˆ150Gï¼‰- 100XPå¿…è¦</button>
    <button id="toolAutoPlanterCabbage" onclick="buyTool('ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·')" disabled>ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·è³¼å…¥ï¼ˆ3000Gï¼‰- 700XPå¿…è¦</button>
    <button id="toolAutoPlanterTomato" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·')" disabled>ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·è³¼å…¥ï¼ˆ4000Gï¼‰- 1200XPå¿…è¦</button>
    <button id="toolAutoPlanterCarrot" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·')" disabled>ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·è³¼å…¥ï¼ˆ5000Gï¼‰- 1600XPå¿…è¦</button>
    <button id="toolAutoPlanterPotato" onclick="buyTool('ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·')" disabled>ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·è³¼å…¥ï¼ˆ7000Gï¼‰- 2400XPå¿…è¦</button>
    <button id="buyPower" onclick="buyPower()" disabled>é›»åŠ›è³¼å…¥ï¼ˆ100EP / 200Gï¼‰- 700XPå¿…è¦</button>
    <button id="cropTomato" onclick="buyCrop('ãƒˆãƒãƒˆ')" disabled>ãƒˆãƒãƒˆã®ç¨®ï¼ˆ100Gï¼‰- 200XPå¿…è¦</button>
    <button id="recipeSalad" onclick="buyRecipe('ãƒˆãƒãƒˆã‚µãƒ©ãƒ€')" disabled>ãƒ¬ã‚·ãƒ”æœ¬ã€ãƒˆãƒãƒˆã‚µãƒ©ãƒ€ã€ï¼ˆ200Gï¼‰- 200XPå¿…è¦</button>
    <button id="cropCarrot" onclick="buyCrop('ãƒ‹ãƒ³ã‚¸ãƒ³')" disabled>ãƒ‹ãƒ³ã‚¸ãƒ³ã®ç¨®ï¼ˆ150Gï¼‰- 400XPå¿…è¦</button>
    <button id="recipeCarrot" onclick="buyRecipe('ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³')" disabled>ãƒ¬ã‚·ãƒ”æœ¬ã€ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³ã€ï¼ˆ200Gï¼‰- 400XPå¿…è¦</button>
    <button id="cropPotato" onclick="buyCrop('ãƒãƒ†ãƒˆ')" disabled>ãƒãƒ†ãƒˆã®ç¨®ï¼ˆ300Gï¼‰- 800XPå¿…è¦</button>
  </div>

  <div id="machines" class="tab-content">
    <h2>ğŸšœ è¾²æ©Ÿ</h2>
    <h3>ç¨®ã¾ãæ©Ÿã®ç¨¼åƒè¨­å®š</h3>
    <div id="planterControls"></div>
  </div>

  <div id="power" class="tab-content">
    <h2>âš¡ï¸ é›»åŠ›</h2>
    <p>é›»åŠ›è³¼å…¥ã¯ã‚·ãƒ§ãƒƒãƒ—ã‚¿ãƒ–ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
    <p>å°†æ¥ã®ç™ºé›»æ©Ÿèƒ½ã¯ã“ã¡ã‚‰ã§ç®¡ç†äºˆå®šã§ã™ã€‚</p>
  </div>

<div id="management" class="tab-content">
  <h2>ğŸ’¼ çµŒå–¶</h2>
  <div id="managementDashboard">
    <p>ç·åç›Š: <span id="totalRevenue">0</span>G</p>
    <p>ç·æ”¯å‡º: <span id="totalCost">0</span>G</p>
    <p>åœŸåœ°ã‚µã‚¤ã‚º: <span id="landSizeManagement">5</span></p>
    <p>åº—èˆ—æ•°: <span id="storeCount">1</span></p>
    <button id="land" onclick="buyLand()">åœŸåœ°æ‹¡å¼µï¼ˆ<span id="landCost">100</span>Gï¼‰</button>
    <button id="openStore" onclick="openStore()">æ–°åº—èˆ—é–‹è¨­ï¼ˆ500000Gï¼‰</button>
    <button id="installAutoSeller" onclick="installAutoSeller()">è‡ªå‹•è²©å£²æ©Ÿè¨­ç½®ï¼ˆ100000Gï¼‰</button>
    <button id="startCampaign" onclick="startCampaign()">åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼ˆ500Gã§è²©å£²/ã‚¯ã‚¨ã‚¹ãƒˆé–“éš”20%çŸ­ç¸®ã€5åˆ†é–“ï¼‰</button>
  </div>
</div>

  <div id="achievements" class="tab-content">
    <h2>ğŸŒŸ é€²æ—</h2>
    <p>XPã‚’è²¯ã‚ã¦å ±é…¬ã‚’ç²å¾—ï¼ç‰¹åˆ¥ãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã§è¾²å ´ã‚’ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼</p>
    <div id="achievements-subtabs">
      <button id="subtab-farming" onclick="showSubTab('farming')">è¾²æ¥­</button>
      <button id="subtab-cooking" onclick="showSubTab('cooking')">æ–™ç†</button>
      <button id="subtab-sales" onclick="showSubTab('sales')">è²©å£²</button>
      <button id="subtab-quests" onclick="showSubTab('quests')">ã‚¯ã‚¨ã‚¹ãƒˆ</button>
      <button id="subtab-market" onclick="showSubTab('market')">ã‚·ãƒ§ãƒƒãƒ—</button>
      <button id="subtab-machines" onclick="showSubTab('machines')">è¾²æ©Ÿ</button>
      <button id="subtab-power" onclick="showSubTab('power')">é›»åŠ›</button>
      <button id="subtab-management" onclick="showSubTab('management')">çµŒå–¶</button>
    </div>
    <ul id="achievementList"></ul>
  </div>

  <div id="settings" class="tab-content">
    <h2>âš™ï¸ è¨­å®š</h2>
    <div class="settings-group">
      <h3>ä¿å­˜ã¨èª­ã¿è¾¼ã¿</h3>
      <div class="button-group">
        <button onclick="saveGame()">ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜</button>
        <button onclick="loadGame()">ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€</button>
        <button class="delete-button" onclick="showDeleteConfirm()">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
      </div>
    </div>
    <div class="settings-group">
      <h3>è‡ªå‹•ä¿å­˜è¨­å®š</h3>
      <p>ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’å®šæœŸçš„ã«è‡ªå‹•ä¿å­˜ã—ã¾ã™ã€‚</p>
      <label for="autoSaveEnabled">è‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹ã«ã™ã‚‹:</label>
      <input type="checkbox" id="autoSaveEnabled" onchange="toggleAutoSave(); saveSettings()">
      <label for="autoSaveInterval">è‡ªå‹•ä¿å­˜é–“éš”ï¼ˆç§’ã€5ä»¥ä¸Šï¼‰:</label>
      <input type="number" id="autoSaveInterval" min="5" value="10" onchange="updateAutoSaveInterval(); saveSettings()">
    </div>
    <div class="settings-group">
      <h3>è‡ªå‹•èª­ã¿è¾¼ã¿è¨­å®š</h3>
      <p>ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
      <label for="autoLoadEnabled">ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å¾©å…ƒ:</label>
      <input type="checkbox" id="autoLoadEnabled" onchange="toggleAutoLoad()">
    </div>
    <div id="saveStatus"></div>
  </div>

  <div id="pauseModal" style="display: none;">
    <div>
      <h2>ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ä¸­</h2>
      <p>ã™ã¹ã¦ã®é€²è¡ŒãŒåœæ­¢ã—ã¦ã„ã¾ã™ã€‚<br>ã‚†ã£ãã‚Šä¼‘æ†©ã—ã¦ãã ã•ã„ã€‚</p>
      <p id="version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.5.9</p>
      <div class="button-group">
        <button onclick="togglePause(true)">ã‚²ãƒ¼ãƒ ã‚’å†é–‹</button>
        <button onclick="window.open('https://github.com/suzurainshade/cooking/', '_blank')">GitHubã¸</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" style="display: none;">
    <div>
      <h2>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®ç¢ºèª</h2>
      <p>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <div class="button-group">
        <button onclick="deleteSaveData()">å‰Šé™¤ã™ã‚‹</button>
        <button onclick="cancelDelete()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

<script>
const version = '2.5.9';

// 4. å“è³ªé¸æŠã®æ‹¡å¼µç”¨ç©ºé–¢æ•°
function onQualitySelection(type, quality, context) {
  // å“è³ªé¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¾‹ï¼šRPå¤‰å‹•ã€ãŠç¤¼ï¼‰ã¯ã“ã“ã«è¿½åŠ 
  // context: 'shelf'ï¼ˆæ£šã«ä¸¦ã¹ã‚‹ï¼‰ã¾ãŸã¯ 'quest'ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆç´å“ï¼‰
}

function rearrangeGlobalStatusForMobile() {
  const isMobile = window.innerWidth <= 480;
  const container = document.getElementById('global-status');

  if (!container.dataset.originalHtml) {
    container.dataset.originalHtml = container.innerHTML;
  }

  if (isMobile) {
    container.innerHTML = `
      <div style="display: flex; gap: 12px;">
        <span>æ‰€æŒé‡‘: <span id="money">100</span>G</span>
        <span>çµŒé¨“å€¤: <span id="xp">0</span>XP</span>
      </div>
      <div style="display: flex; gap: 12px;">
        <span>è©•åˆ¤: <span id="rp">5.00</span>RP</span>
        <span>é›»åŠ›: <span id="ep">0</span>EP</span>
      </div>
      <button id="pauseButton" onclick="togglePause(true)">â¸</button>
    `;
  } else {
    container.innerHTML = container.dataset.originalHtml;
  }
}

window.addEventListener('load', rearrangeGlobalStatusForMobile);
window.addEventListener('resize', rearrangeGlobalStatusForMobile);

let money = 100;
let xp = 0;
let rp = 5.0;
let ep = 0;
let landSize = 5;
let crops = [];
let harvestBox = {};
let dishInventory = {};
let shelf = [];
let shelves = {'0':[]};
let currentStoreId = '0';
let storeCount = 1;
let autoSellers = 0;
let autoSellerActive = true;
let sellIntervalReduction = 1;
let landExpansions= 0;
let quests = [];
let tools = { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
let activePlanters = { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
let unlockedCrops = ['ã‚­ãƒ£ãƒ™ãƒ„'];
let unlockedRecipes = ['ç„¼ãã‚­ãƒ£ãƒ™ãƒ„'];
let growthBonus = 0;
let seasonings = {};
let advancedInventory = [];
let currentAdvancedRecipe = null;
let currentAdvancedSteps = [];
let autoSaveEnabled = true;
let autoSaveInterval = 10000;
let autoLoadEnabled = true;
let autoSaveTimer = null;
let purchasedItems = new Set();
let newQuestAvailable = false;
let lastPowerConsumption = Date.now();
let isPaused = false;
let questTimer = null;
let newAchievementAvailable = false;
let currentSubTab = 'farming';
let harvestCounts = { 'ã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
let cookCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
let saleCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
let questCompleteCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
let totalQuestCompletes = 0;
let planterUses = { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
let shopPurchaseCounts = { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0, 'é›»åŠ›è³¼å…¥': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
let totalPowerConsumed = 0;
let pauseStartTime = null;
let pauseDuration = 0;
let nextQuestTime = null;
let questtimerStart = null;
const MAX_QUESTS = 100; // ã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®ä¸Šé™
// 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®è¿½åŠ ï¼ˆã‚²ãƒ¼ãƒ å†…æ™‚é–“ã€å¤©å€™ã€å“è³ªï¼‰
let gameTime = { days: 0, hours: 0, minutes: 0 }; // ã‚²ãƒ¼ãƒ å†…æ™‚é–“
let lastGameTimeUpdate = Date.now();
let currentWeather = 'æ™´ã‚Œ'; // ç¾åœ¨ã®å¤©å€™
let previousWeather = null; // å‰æ—¥ã®å¤©å€™
let weatherHistory = []; // å¤©å€™å±¥æ­´ï¼ˆå‰æ—¥ã¾ã§ï¼‰
let currentSeason = 'æ˜¥'; // ç¾åœ¨ã®å­£ç¯€
let lastWeatherUpdate = 0; // æœ€å¾Œã®å¤©å€™æ›´æ–°æ™‚åˆ»
let pauseStartGameTimeUpdate = 0; // ãƒãƒ¼ã‚ºé–‹å§‹æ™‚ã®ã‚²ãƒ¼ãƒ æ™‚é–“åŸºæº–
let activeTab = 'farming';
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¿½åŠ ï¼ˆæ—¢å­˜ã®å¤‰æ•°å®£è¨€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ï¼‰
let selectedQualities = {}; // ä¾‹: { '0': 'é«˜å“è³ª', '1': 'æ™®é€š' }

let achievements = [
  // è¾²æ¥­ï¼ˆåç©«é–¢é€£ï¼‰
  { id: 'harvestCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„ãƒã‚¹ã‚¿ãƒ¼', category: 'farming', harvest: { crop: 'ã‚­ãƒ£ãƒ™ãƒ„', count: 20 }, reward: { gold: 100, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 10 } }, achieved: false, claimed: false },
  { id: 'harvestTomato', name: 'ãƒˆãƒãƒˆãƒã‚¹ã‚¿ãƒ¼', category: 'farming', harvest: { crop: 'ãƒˆãƒãƒˆ', count: 15 }, reward: { gold: 150, items: { 'ãƒˆãƒãƒˆ': 5 } }, achieved: false, claimed: false },
  // æ–™ç†
  { id: 'cookCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„ã‚·ã‚§ãƒ•', category: 'cooking', cook: { recipe: 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„', count: 10 }, reward: { gold: 100, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 5 } }, achieved: false, claimed: false },
  { id: 'cookSalad', name: 'ã‚µãƒ©ãƒ€è·äºº', category: 'cooking', cook: { recipe: 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€', count: 5 }, reward: { gold: 150, items: { 'ãƒˆãƒãƒˆ': 3, 'ã‚­ãƒ£ãƒ™ãƒ„': 3 } }, achieved: false, claimed: false },
  { id: 'cookCarrot', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³ã‚·ã‚§ãƒ•', category: 'cooking', cook: { recipe: 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³', count: 8 }, reward: { gold: 120, items: { 'ãƒ‹ãƒ³ã‚¸ãƒ³': 4 } }, achieved: false, claimed: false },
  // è²©å£²
  { id: 'saleCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„è²©å£²è€…', category: 'sales', sales: { recipe: 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„', count: 10 }, reward: { gold: 100, ep: 50 }, achieved: false, claimed: false },
  { id: 'saleSalad', name: 'ã‚µãƒ©ãƒ€è²©å£²ç‹', category: 'sales', sales: { recipe: 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€', count: 5 }, reward: { gold: 150, ep: 50 }, achieved: false, claimed: false },
  { id: 'saleCarrot', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³è²©å£²è€…', category: 'sales', sales: { recipe: 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³', count: 8 }, reward: { gold: 120, ep: 50 }, achieved: false, claimed: false },
  // ã‚¯ã‚¨ã‚¹ãƒˆ
  { id: 'questCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„ã‚¯ã‚¨ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼', category: 'quests', quest: { recipe: 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„', count: 3 }, reward: { gold: 100, ep: 50 }, achieved: false, claimed: false },
  { id: 'questSalad', name: 'ã‚µãƒ©ãƒ€ã‚¯ã‚¨ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼', category: 'quests', quest: { recipe: 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€', count: 2 }, reward: { gold: 150, ep: 50 }, achieved: false, claimed: false },
  { id: 'questTotal', name: 'ã‚¯ã‚¨ã‚¹ãƒˆé”æˆè€…', category: 'quests', totalQuests: 5, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  // ã‚·ãƒ§ãƒƒãƒ—
  { id: 'shopTools', name: 'é“å…·ãƒãƒ‹ã‚¢', category: 'market', shopPurchase: { items: ['ã‚¸ãƒ§ã‚¦ãƒ­', 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·'], count: 1 }, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'shopCrops', name: 'ä½œç‰©ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', category: 'market', shopPurchase: { items: ['ãƒˆãƒãƒˆ', 'ãƒ‹ãƒ³ã‚¸ãƒ³', 'ãƒãƒ†ãƒˆ'], count: 1 }, reward: { gold: 200, ep: 50 }, achieved: false, claimed: false },
  { id: 'shopPower', name: 'é›»åŠ›è³¼å…¥è€…', category: 'market', shopPurchase: { items: ['é›»åŠ›è³¼å…¥'], count: 3 }, reward: { gold: 100, ep: 150 }, achieved: false, claimed: false },
  // è¾²æ©Ÿ
  { id: 'planterCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„å·å°å…¥', category: 'machines', planter: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', reward: { ep: 100, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 10 } }, achieved: false, claimed: false },
  { id: 'planterTomato', name: 'ãƒˆãƒãƒˆå·å°å…¥', category: 'machines', planter: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', reward: { ep: 150, items: { 'ãƒˆãƒãƒˆ': 5 } }, achieved: false, claimed: false },
  { id: 'planterUseCabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„è‡ªå‹•åŒ–ã®é”äºº', category: 'machines', planterUse: { planter: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', count: 10 }, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'planterUseTomato', name: 'ãƒˆãƒãƒˆè‡ªå‹•åŒ–ã®é”äºº', category: 'machines', planterUse: { planter: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', count: 5 }, reward: { gold: 200, ep: 100 }, achieved: false, claimed: false },
  // é›»åŠ›
  { id: 'powerConsumer', name: 'é›»åŠ›ã®é”äºº', category: 'power', power: 50, reward: { gold: 100, ep: 200 }, achieved: false, claimed: false },
  { id: 'powerHeavy', name: 'é›»åŠ›ã®å·¨åŒ ', category: 'power', power: 100, reward: { gold: 200, ep: 300 }, achieved: false, claimed: false },
  // çµŒå–¶ï¼ˆXPé–¢é€£ï¼‰
  { id: 'xp100', name: 'åˆç´šè¾²å®¶', category: 'management', xp: 100, reward: { gold: 50, items: { 'ã‚­ãƒ£ãƒ™ãƒ„': 5 } }, achieved: false, claimed: false },
  { id: 'xp300', name: 'é›»åŠ›åˆå¿ƒè€…', category: 'management', xp: 300, reward: { gold: 150, ep: 100 }, achieved: false, claimed: false },
  { id: 'xp400', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³é–‹æ‹“è€…', category: 'management', xp: 400, reward: { gold: 200, crops: ['ãƒ‹ãƒ³ã‚¸ãƒ³'] }, achieved: false, claimed: false },
  { id: 'xp800', name: 'ãƒãƒ†ãƒˆé–‹æ‹“è€…', category: 'management', xp: 800, reward: { gold: 400, crops: ['ãƒãƒ†ãƒˆ'] }, achieved: false, claimed: false }
];

const recipeData = {
  'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': {
    ingredients: { 'ã‚­ãƒ£ãƒ™ãƒ„': 1 },
    rewardPerDish: 25,
    sellPrice: 20
  },
  'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': {
    ingredients: { 'ã‚­ãƒ£ãƒ™ãƒ„': 1, 'ãƒˆãƒãƒˆ': 1 },
    rewardPerDish: 55,
    sellPrice: 45
  },
  'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': {
    ingredients: { 'ãƒ‹ãƒ³ã‚¸ãƒ³': 1 },
    rewardPerDish: 30,
    sellPrice: 25
  }
};

const unlockThresholds = {
  'ã‚¸ãƒ§ã‚¦ãƒ­': 100,
  'ãƒˆãƒãƒˆ': 200,
  'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 200,
  'ãƒ‹ãƒ³ã‚¸ãƒ³': 400,
  'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 400,
  'ãƒãƒ†ãƒˆ': 800,
  'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 700,
  'é›»åŠ›è³¼å…¥': 700,
  'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 1200,
  'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 1600,
  'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 2400
};

let totalRevenue = 0; //ç·åç›Š
let totalCost = 0; //ç·æ”¯å‡º
let sellProbabilityBonus = 1; //åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è²©å£²ç¢ºç‡å€ç‡
let campaignEndTime = 0; //ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³çµ‚äº†æ™‚åˆ»
let powerShortage = false; //è¾²æ©Ÿã‚¿ãƒ–ã®EPä¸è¶³é€šçŸ¥ç”¨

updateUI();
loadSettings();
updateSettingsUI();
startAutoSave();
if (autoLoadEnabled) loadGame();
updateUI();

// 2. åˆæœŸåŒ–ï¼ˆè¾²æ¥­ã‚¿ãƒ–ã®åˆæœŸé¸æŠï¼‰
function initializeGame() {
  // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†ï¼ˆçœç•¥ï¼‰
  initializeGameTime();
  activeTab = 'farming'; // è¾²æ¥­ã‚¿ãƒ–ã‚’åˆæœŸé¸æŠ
  switchTab('farming'); // ã‚¿ãƒ–ã‚’æ˜ç¤ºçš„ã«é¸æŠ
  updateUI();
}

// 5. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆåˆæœŸé¸æŠã®ä¿è¨¼ï¼‰
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = content.id === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.toggle('active', button.getAttribute('onclick') === `switchTab('${tab}')`);
  });
  updateUI();
}

// 2. åˆæœŸåŒ–ï¼ˆã‚²ãƒ¼ãƒ å†…æ™‚é–“ã®é–‹å§‹ï¼‰
function initializeGameTime() {
  gameTime = { days: 0, hours: 0, minutes: 0 };
  updateSeason();
  setWeather();
}

// 3. ã‚²ãƒ¼ãƒ å†…æ™‚é–“ã®æ›´æ–°ï¼ˆãƒãƒ¼ã‚ºå¯¾å¿œï¼‰
function updateGameTime() {
  if (!isPaused) {
    const now = Date.now();
    const elapsed = now - lastGameTimeUpdate; // å®Ÿéš›ã®çµŒéæ™‚é–“ï¼ˆmsï¼‰
    const minutesToAdd = Math.floor(elapsed / 250); // 250ms = 1åˆ†
    if (minutesToAdd > 0) {
      gameTime.minutes += minutesToAdd;
      lastGameTimeUpdate += minutesToAdd * 250; // æ›´æ–°æ™‚åˆ»ã‚’é€²ã‚ã‚‹
      while (gameTime.minutes >= 60) {
        gameTime.minutes -= 60;
        gameTime.hours += 1;
        if (gameTime.hours >= 24) {
          gameTime.hours = 0;
          gameTime.days += 1;
          setWeather(); // æ¯æ—¥å¤©å€™ãƒªã‚»ãƒƒãƒˆ
        }
      }
      updateSeason();
      updateUI();
    }
  }
}

// 4. å­£ç¯€ã®æ›´æ–°
function updateSeason() {
  const month = Math.floor((gameTime.days % 360) / 30) + 1; // 360æ—¥ã§1å¹´
  if (month >= 3 && month <= 5) currentSeason = 'æ˜¥';
  else if (month === 6) currentSeason = '6æœˆ';
  else if (month === 7 || month === 8) currentSeason = 'å¤';
  else if (month >= 9 && month <= 11) currentSeason = 'ç§‹';
  else currentSeason = 'å†¬';
}

// 5. å¤©å€™ã®è¨­å®š
function setWeather() {
  const rand = Math.random();
  let probabilities;
  if (previousWeather === 'è’¸ã—æš‘ã„') {
    probabilities = { é›¨: 0.65, å¤§é›¨: 0.35 };
  } else if ((previousWeather === 'é›¨' || previousWeather === 'å¤§é›¨') && (currentSeason === '6æœˆ' ? rand < 0.65 : rand < 0.4)) {
    probabilities = { é›¨: 0.65, å¤§é›¨: 0.35 };
  } else {
    if (currentSeason === 'æ˜¥') {
      probabilities = { å¿«æ™´: 0.30, æ™´ã‚Œ: 0.35, æ›‡ã‚Š: 0.20, è’¸ã—æš‘ã„: 0.15 };
    } else if (currentSeason === '6æœˆ') {
      probabilities = { å¿«æ™´: 0.10, æ™´ã‚Œ: 0.15, æ›‡ã‚Š: 0.25, è’¸ã—æš‘ã„: 0.50 };
    } else if (currentSeason === 'å¤') {
      probabilities = { å¿«æ™´: 0.30, æ™´ã‚Œ: 0.35, æ›‡ã‚Š: 0.10, è’¸ã—æš‘ã„: 0.15, å°é¢¨: 0.10 };
    } else if (currentSeason === 'ç§‹') {
      probabilities = { å¿«æ™´: 0.15, æ™´ã‚Œ: 0.40, æ›‡ã‚Š: 0.25, è’¸ã—æš‘ã„: 0.05, å°é¢¨: 0.15 };
    } else {
      probabilities = { å¿«æ™´: 0.25, æ™´ã‚Œ: 0.50, æ›‡ã‚Š: 0.15, è’¸ã—æš‘ã„: 0.10 };
    }
  }
  let cumulative = 0;
  for (const [weather, prob] of Object.entries(probabilities)) {
    cumulative += prob;
    if (rand < cumulative) {
      weatherHistory.push(currentWeather);
      if (weatherHistory.length > 1) weatherHistory.shift(); // å‰æ—¥ã¾ã§ä¿æŒ
      currentWeather = weather;
      previousWeather = currentWeather;
      break;
    }
  }
}

// 7. å“è³ªç‚¹æ•°ã®è¨ˆç®—
function calculateQualityScore() {
  let score = 0;
  switch (currentWeather) {
    case 'å¿«æ™´': case 'æ™´ã‚Œ': score += 5; break;
    case 'æ›‡ã‚Š': score += 3; break;
    case 'é›¨': score += 4; break;
    case 'å¤§é›¨': score += 1; break;
    case 'å°é¢¨': score += 0; break;
  }
  if (weatherHistory.includes('é›¨') || weatherHistory.includes('å¤§é›¨')) {
    score += 4;
  }
  score += Math.random() * 2;
  return Math.min(score, 11); // æœ€å¤§11ç‚¹
}

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('#tabs button').forEach(btn => btn.classList.remove('active-tab'));
  document.getElementById(`tab-${tabId}`).classList.add('active-tab');
  if (tabId === 'settings') {
    document.getElementById('saveStatus').style.display = 'none';
    updateSettingsUI();
  }
  if (tabId === 'quest') {
    newQuestAvailable = false;
    updateTabNotifications();
  }
  if (tabId === 'machines') {
    powerShortage = false;
    updatePlanterControls();
    updateTabNotifications();
  }
  if (tabId === 'achievements') {
    newAchievementAvailable = false;
    updateAchievementList();
    updateTabNotifications();
    showSubTab(currentSubTab);
  }
  if (tabId === 'management') {
    updateManagementDashboard();
  }
  if (tabId === 'shop') {
    updateShopSubTabs();
  }
}

function showSubTab(subTabId) {
  currentSubTab = subTabId;
  document.querySelectorAll('#achievements-subtabs button').forEach(btn => {
    btn.classList.remove('active-subtab');
  });
  document.getElementById(`subtab-${subTabId}`).classList.add('active-subtab');
  updateAchievementList();
}

function addXP(amount) {
  xp += amount;
  checkAchievements();
  updateUI();
}

function openStore() {
  if (money >= 500000) {
    money -= 500000;
    totalCost += 500000;
    storeCount += 1;
    const newStoreId = (storeCount - 1).toString();
    shelves[newStoreId] = [];
    showSaveStatus(`æ–°åº—èˆ—ï¼ˆè²©å£²åº—${String.fromCharCode(65 + storeCount - 1)}ï¼‰ã‚’é–‹è¨­ã—ã¾ã—ãŸï¼`, true);
    updateShopSubTabs();
    updateUI();
    updateManagementDashboard();
  } else {
    showSaveStatus('æ–°åº—èˆ—é–‹è¨­ã«å¿…è¦ãª500000GãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', false);
  }
}

function installAutoSeller() {
  if (money >= 100000) {
    money -= 100000;
    totalCost += 100000;
    autoSellers += 1;
    showSaveStatus(`è‡ªå‹•è²©å£²æ©Ÿ${autoSellers}å°ç›®ã‚’è¨­ç½®ã—ã¾ã—ãŸï¼`, true);
    updateUI();
    updateManagementDashboard();
  } else {
    showSaveStatus('è‡ªå‹•è²©å£²æ©Ÿè¨­ç½®ã«å¿…è¦ãª100000GãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', false);
  }
}

function updateShopSubTabs() {
  const subTabs = document.getElementById('shop-subtabs');
  subTabs.innerHTML = Object.keys(shelves).map(storeId => {
    const storeName = `è²©å£²åº—${String.fromCharCode(65 + parseInt(storeId))}`;
    return `<button id="shop-subtab-${storeId}" onclick="showShopSubTab('${storeId}')" class="${currentStoreId === storeId ? 'active-subtab' : ''}">${storeName}</button>`;
  }).join('');
  showShopSubTab(currentStoreId);
}

// ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ–ã‚¿ãƒ–ã®è¡¨ç¤ºï¼ˆå“è³ªé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¿½åŠ ï¼‰
function showShopSubTab(storeId) {
  currentStoreId = storeId;
  document.querySelectorAll('#shop-subtabs button').forEach(btn => btn.classList.remove('active-subtab'));
  document.getElementById(`shop-subtab-${storeId}`).classList.add('active-subtab');
  const content = document.getElementById('shop-content');
  content.innerHTML = `
    <select id="sellRecipeSelect-${storeId}">
      ${unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('')}
    </select>
    <select id="qualitySelect-${storeId}">
      <!-- å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯updateUIã§å‹•çš„ã«ç”Ÿæˆ -->
    </select>
    <button onclick="putOnShelf('${storeId}')">é™³åˆ—</button>
    <p>æ£šã®æ•°: <span id="shelfCount-${storeId}">0</span></p>
    <ul id="shelfList-${storeId}"></ul>
  `;
  updateUI();
}



function checkAchievements() {
  let newAchievements = false;
  achievements.forEach(a => {
    if (!a.achieved) {
      if (a.xp && xp >= a.xp) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.planter && tools[a.planter] > 0) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.harvest && harvestCounts[a.harvest.crop] >= a.harvest.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.cook && cookCounts[a.cook.recipe] >= a.cook.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.sales && saleCounts[a.sales.recipe] >= a.sales.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.quest && questCompleteCounts[a.quest.recipe] >= a.quest.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.totalQuests && totalQuestCompletes >= a.totalQuests) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.shopPurchase && a.shopPurchase.items.every(item => shopPurchaseCounts[item] >= a.shopPurchase.count)) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.planterUse && planterUses[a.planterUse.planter] >= a.planterUse.count) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      } else if (a.power && totalPowerConsumed >= a.power) {
        a.achieved = true;
        newAchievementAvailable = true;
        newAchievements = true;
        showSaveStatus(`é€²æ—ã€Œ${a.name}ã€ã‚’é”æˆï¼å ±é…¬ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ï¼`, true);
      }
    }
  });
  if (newAchievements) {
    updateTabNotifications();
  }
  updateAchievementList();
}

function claimAchievement(id) {
  const achievement = achievements.find(a => a.id === id);
  if (achievement && achievement.achieved && !achievement.claimed) {
    achievement.claimed = true;
    if (achievement.reward.gold) money += achievement.reward.gold;
    if (achievement.reward.ep) ep += achievement.reward.ep;
    if (achievement.reward.items) {
      for (const [item, count] of Object.entries(achievement.reward.items)) {
        harvestBox[item] = (harvestBox[item] || 0) + count;
      }
    }
    if (achievement.reward.crops) {
      achievement.reward.crops.forEach(crop => {
        if (!unlockedCrops.includes(crop) && !purchasedItems.has(crop)) {
          unlockedCrops.push(crop);
          purchasedItems.add(crop);
        }
      });
    }
    newAchievementAvailable = achievements.some(a => a.achieved && !a.claimed);
    showSaveStatus(`é€²æ—ã€Œ${achievement.name}ã€ã®å ±é…¬ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼`, true);
    updateAchievementList();
    updateTabNotifications();
    updateUI();
  }
}

function updateAchievementList() {
  const list = document.getElementById('achievementList');
  list.innerHTML = achievements
    .filter(a => a.category === currentSubTab)
    .map(a => {
      const conditionText = a.xp ? `${a.xp}XP` :
                           a.planter ? `${a.planter}æ‰€æŒ` :
                           a.harvest ? `${a.harvest.crop}åç©«${a.harvest.count}å€‹` :
                           a.cook ? `${a.cook.recipe}èª¿ç†${a.cook.count}å›` :
                           a.sales ? `${a.sales.recipe}è²©å£²${a.sales.count}å€‹` :
                           a.quest ? `${a.quest.recipe}ã‚¯ã‚¨ã‚¹ãƒˆ${a.quest.count}å›` :
                           a.totalQuests ? `ã‚¯ã‚¨ã‚¹ãƒˆ${a.totalQuests}å›` :
                           a.shopPurchase ? `${a.shopPurchase.items.join('ã€')}è³¼å…¥${a.shopPurchase.count}å›` :
                           a.planterUse ? `${a.planterUse.planter}ä½¿ç”¨${a.planterUse.count}å›` :
                           a.power ? `é›»åŠ›æ¶ˆè²»${a.power}EP` : '';
      const rewardText = [
        a.reward.gold ? `${a.reward.gold}G` : '',
        a.reward.ep ? `${a.reward.ep}EP` : '',
        a.reward.items ? Object.entries(a.reward.items).map(([k, v]) => `${k} x${v}`).join(', ') : '',
        a.reward.crops ? a.reward.crops.map(c => `${c}ã®ç¨®`).join(', ') : ''
      ].filter(t => t).join(', ');
      return `
        <li class="${a.achieved ? 'achieved' : 'unachieved'}">
          ${a.name}ï¼ˆ${conditionText}ï¼‰: ${rewardText}
          ${a.achieved && !a.claimed ? `<button onclick="claimAchievement('${a.id}')">å ±é…¬ã‚’å—ã‘å–ã‚‹</button>` : a.claimed ? 'ï¼ˆå—å–æ¸ˆï¼‰' : ''}
        </li>
      `;
    }).join('');
}

function updateManagementDashboard() {
  document.getElementById('totalRevenue').textContent = totalRevenue;
  document.getElementById('totalCost').textContent = totalCost;
  document.getElementById('landSizeManagement').textContent = landSize;
  document.getElementById('storeCount').textContent = storeCount;
  document.getElementById('landCost').textContent = 100 + landSize * 10;
  const campaignButton = document.getElementById('startCampaign');
  campaignButton.disabled = money < 500 || campaignEndTime > Date.now();
  campaignButton.textContent = campaignEndTime > Date.now()
    ? `åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼ˆæ®‹ã‚Š${Math.ceil((campaignEndTime - Date.now()) / 1000)}ç§’ï¼‰`
    : `åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼ˆ500Gã§è²©å£²/ã‚¯ã‚¨ã‚¹ãƒˆé–“éš”20%çŸ­ç¸®ã€5åˆ†é–“ï¼‰`;
}

function startCampaign() {
  if (money >= 500 && campaignEndTime <= Date.now()) {
    money -= 500;
    totalCost += 500;
    sellIntervalReduction = 0.8; // è²©å£²/ã‚¯ã‚¨ã‚¹ãƒˆé–“éš”20%çŸ­ç¸®
    campaignEndTime = Date.now() + 300000; // 5åˆ†
    showSaveStatus('åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼è²©å£²/ã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ãŒ5åˆ†é–“20%çŸ­ç¸®ã•ã‚Œã¾ã™ã€‚', true);
    updateManagementDashboard();
    updateUI();
  }
}

function togglePause(toggle) {
  if (toggle){
  isPaused = !isPaused;
  document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
  document.getElementById('pauseButton').textContent = isPaused ? 'â–¶' : 'â¸';
  }

  if (isPaused) {
    // ãƒãƒ¼ã‚ºé–‹å§‹: æ™‚åˆ»ã‚’è¨˜éŒ²ã—ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    pauseStartTime = Date.now();
    pauseStartGameTimeUpdate = lastGameTimeUpdate;
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
  } else {
    // ãƒãƒ¼ã‚ºè§£é™¤: ãƒãƒ¼ã‚ºæœŸé–“ã‚’è¨ˆç®—ã—ã€ã‚¯ã‚¨ã‚¹ãƒˆã®deadlineã‚’èª¿æ•´
    const pauseEndTime = Date.now();
    if (pauseStartTime) {
      pauseDuration += pauseEndTime - pauseStartTime;
      // æ—¢å­˜ã‚¯ã‚¨ã‚¹ãƒˆã®deadlineã‚’å»¶é•·
      quests.forEach(q => {
        q.id += pauseDuration;
      });
      if (nextQuestTime) {
        nextQuestTime += pauseDuration;
        const remainingTime = Math.max(0, nextQuestTime - Date.now());
        questTimer = setTimeout(scheduleQuest, remainingTime);
        questTimerStart = Date.now();
      } else {
        scheduleQuest();
      }
      lastWeatherUpdate += pauseDuration; // ã‚²ãƒ¼ãƒ å†…æ™‚é–“ã‚‚ãƒãƒ¼ã‚ºèª¿æ•´
      //lastGameTimeUpdate += pauseDuration; //æ™‚é–“æ›´æ–°ã®åŸºæº–ã‚’èª¿æ•´
      lastGameTimeUpdate = pauseStartGameTimeUpdate;
      pauseStartTime = null;
      console.log(pauseDuration);
    }
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    if (nextQuestTime) {
      const remainingTime = Math.max(0, nextQuestTime - Date.now());
      console.log(`Next quest in ${remainingTime / 1000} seconds`);
      questTimer = setTimeout(scheduleQuest, remainingTime);
      questTimerStart = Date.now();
    } else {
      // åˆå›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ãŸã¯nextQuestTimeãŒãªã„å ´åˆ
      scheduleQuest();
    }
    lastPowerConsumption = Date.now();
  }
}

document.onkeydown = function(e) {
  if (e.key === 'Escape') {
    togglePause(true);
  }
};

function showDeleteConfirm() {
  isPaused = true;
  document.getElementById('deleteConfirmModal').style.display = 'flex';
  document.getElementById('pauseButton').textContent = 'â¸';
}

function cancelDelete() {
  isPaused = false;
  document.getElementById('deleteConfirmModal').style.display = 'none';
  document.getElementById('pauseButton').textContent = 'â¸';
  const pauseEndTime = Date.now();
  if (pauseStartTime) {
    pauseDuration += pauseEndTime - pauseStartTime;
    quests.forEach(q => {
      q.deadline += pauseDuration;
    });
    pauseStartTime = null;
  }
  lastPowerConsumption = Date.now();
  if (questTimer) {
    clearTimeout(questTimer);
    questTimer = null;
  }
  if (nextQuestTime) {
    const remainingTime = Math.max(0, nextQuestTime - Date.now());
    console.log(`Next quest in ${remainingTime / 1000} seconds`);
    questTimer = setTimeout(scheduleQuest, remainingTime);
    questTimerStart = Date.now();
  } else {
    scheduleQuest();
  }
}

function deleteSaveData() {
  try {
    localStorage.removeItem('farmingGameSave');
    localStorage.removeItem('farmingGameSettings');
    money = 100;
    xp = 0;
    rp = 5.0;
    ep = 0;
    landSize = 5;
    crops = [];
    harvestBox = {};
    dishInventory = {};
    shelf = [];
    shelves = { '0': [] };
    storeCount = 1;
    currentStoreId = '0';
    autoSellers = 0;
    autoSellerActive = true;
    quests = [];
    tools = { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
    activePlanters = { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
    unlockedCrops = ['ã‚­ãƒ£ãƒ™ãƒ„'];
    unlockedRecipes = ['ç„¼ãã‚­ãƒ£ãƒ™ãƒ„'];
    growthBonus = 0;
    seasonings = {};
    advancedInventory = [];
    currentAdvancedRecipe = null;
    currentAdvancedSteps = [];
    autoSaveEnabled = true;
    autoSaveInterval = 10000;
    autoLoadEnabled = true;
    purchasedItems = new Set();
    newQuestAvailable = false;
    newAchievementAvailable = false;
    currentSubTab = 'farming';
    harvestCounts = { 'ã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
    cookCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
    saleCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
    questCompleteCounts = { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
    totalQuestCompletes = 0;
    planterUses = { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
    shopPurchaseCounts = { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0, 'é›»åŠ›è³¼å…¥': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
    totalPowerConsumed = 0;
    totalRevenue = 0;
    totalCost = 0;
    landExpansions = 0;
    sellIntervalReduction = 1;
    campaignEndTime = 0;
    powerShortage = false;
    achievements = achievements.map(a => ({ ...a, achieved: false, claimed: false }));
    pauseStartTime = null;
    pauseDuration = 0;
    nextQuestTime = null;
    questTimerStart = null;
    document.getElementById('deleteConfirmModal').style.display = 'none';
    isPaused = false;
    document.getElementById('pauseButton').textContent = 'â¸';
    lastPowerConsumption = Date.now();
    gameTime = {days:0,hours:0,minutes:0};
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
    if (!isPaused) {
      scheduleQuest(); // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    }
    updateSettingsUI();
    updateAchievementList();
    updateUI();
    updateQuests();
    updatePlanterControls();
    startAutoSave();
    showSaveStatus('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', true);
  } catch (error) {
    showSaveStatus('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
  }
}

function updateRP(amount) {
  rp = Math.max(0, Math.min(10, rp + amount));
  updateUI();
}

function getQuestInterval() {
  const minInterval = (30000 + (60000 - 30000) * ((rp - 1) / 9)) * sellIntervalReduction;
  const maxInterval = (70000 + (135000 - 70000) * ((rp - 1) / 9)) * sellIntervalReduction;
  return Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
}

// 10. è²©å£²ç¢ºç‡ã®å¤©å€™å½±éŸ¿
function getSellProbability() {
  let baseProb = 0.04 - (0.04 - 0.0167) * ((rp - 1) / 9);
  switch (currentWeather) {
    case 'å¿«æ™´': baseProb *= 1.1; break;
    case 'æ™´ã‚Œ': baseProb *= 1.05; break;
    case 'è’¸ã—æš‘ã„': baseProb *= 0.95; break;
    case 'é›¨': case 'å¤§é›¨': baseProb *= 0.9; break;
    case 'å°é¢¨': baseProb *= 0.8; break;
  }
  return baseProb * sellProbabilityBonus;
}

function checkUnlocks() {
  const items = [
    { id: 'toolWateringCan', name: 'ã‚¸ãƒ§ã‚¦ãƒ­', cost: 150, type: 'tool' },
    { id: 'toolAutoPlanterCabbage', name: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', cost: 3000, type: 'tool' },
    { id: 'toolAutoPlanterTomato', name: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', cost: 4000, type: 'tool' },
    { id: 'toolAutoPlanterCarrot', name: 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·', cost: 5000, type: 'tool' },
    { id: 'toolAutoPlanterPotato', name: 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·', cost: 7000, type: 'tool' },
    { id: 'buyPower', name: 'é›»åŠ›è³¼å…¥', cost: 200, type: 'power' },
    { id: 'cropTomato', name: 'ãƒˆãƒãƒˆ', cost: 100, type: 'crop' },
    { id: 'recipeSalad', name: 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€', cost: 200, type: 'recipe' },
    { id: 'cropCarrot', name: 'ãƒ‹ãƒ³ã‚¸ãƒ³', cost: 150, type: 'crop' },
    { id: 'recipeCarrot', name: 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³', cost: 200, type: 'recipe' },
    { id: 'cropPotato', name: 'ãƒãƒ†ãƒˆ', cost: 300, type: 'crop' }
  ];

  items.forEach(item => {
    const button = document.getElementById(item.id);
    if (button) {
      if (item.type === 'tool' && item.name.startsWith('ç¨®ã¾ãæ©Ÿ')) {
        button.style.display = tools[item.name] >= landSize ? 'none' : 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `${item.name}è³¼å…¥ï¼ˆ${item.cost}Gï¼‰`
          : `${item.name}è³¼å…¥ï¼ˆ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
      } else if (item.type === 'power') {
        button.style.display = 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `é›»åŠ›è³¼å…¥ï¼ˆ100EP / ${item.cost}Gï¼‰`
          : `é›»åŠ›è³¼å…¥ï¼ˆ100EP / ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
      } else {
        button.style.display = purchasedItems.has(item.name) ? 'none' : 'block';
        button.disabled = xp < unlockThresholds[item.name];
        button.textContent = xp >= unlockThresholds[item.name]
          ? `${item.name}${item.type === 'tool' ? 'è³¼å…¥' : item.type === 'crop' ? 'ã®ç¨®' : 'ãƒ¬ã‚·ãƒ”æœ¬ã€' + item.name + 'ã€'}ï¼ˆ${item.cost}Gï¼‰`
          : `${item.name}${item.type === 'tool' ? 'è³¼å…¥' : item.type === 'crop' ? 'ã®ç¨®' : 'ãƒ¬ã‚·ãƒ”æœ¬ã€' + item.name + 'ã€'}ï¼ˆ${item.cost}Gï¼‰- ${unlockThresholds[item.name]}XPå¿…è¦`;
      }
    }
  });
}

function checkGameOver() {
  const hasNoItems =
    Object.keys(harvestBox).length === 0 &&
    Object.keys(dishInventory).length === 0 &&
    shelf.length === 0 &&
    crops.length === 0;
  if (money < 10 && hasNoItems) {
    money += 10;
    showSaveStatus('æ‰€æŒé‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æ•‘æ¸ˆã¨ã—ã¦10Gã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚', true);
    updateUI();
  }
}

function checkQuestDeadlines() {
  if (isPaused) {
    console.log('Quest deadlines paused');
    return;
  }
  const now = Date.now();
  quests.forEach(q => {
    const elapsed = (now - q.id) / 1000;
    if (elapsed > 10 && elapsed <= 30) {
      updateRP(0.05);
      if (elapsed >= 30) {
        showSaveStatus(`ã‚¯ã‚¨ã‚¹ãƒˆã€Œ${q.recipeName} ${q.dishNeed}å€‹ã€ãŒæœŸé™åˆ‡ã‚Œã§è©•åˆ¤ãŒä¸‹ãŒã‚Šã¾ã—ãŸã€‚`, false);
      }
    }
  });
  updateQuests();
}

function consumePower() {
  const now = Date.now();
  if (now - lastPowerConsumption >= 10000) {
    const totalActive = Object.values(activePlanters).reduce((sum, count) => sum + count, 0) + (autoSellers * 0.1); // è‡ªå‹•è²©å£²æ©Ÿã¯10ç§’ã§0.1EPæ¶ˆè²»
    if (totalActive > 0) {
      if (ep >= totalActive) {
        ep -= totalActive;
        totalPowerConsumed += totalActive;
        lastPowerConsumption = now;
        autoSellerActive = true;
        checkAchievements();
      } else {
        Object.keys(activePlanters).forEach(name => activePlanters[name] = 0);
        autoSellerActive = false;
        powerShortage = true;
        showSaveStatus('é›»åŠ›ä¸è¶³ã§ç¨®ã¾ãæ©Ÿã¨è‡ªå‹•è²©å£²æ©ŸãŒåœæ­¢ã—ã¾ã—ãŸã€‚', false);
        updatePlanterControls();
        updateTabNotifications();
      }
      updateUI();
    }
  }
}

function autoPlant() {
  const planters = [
    { name: 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·', crop: 'ã‚­ãƒ£ãƒ™ãƒ„' },
    { name: 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·', crop: 'ãƒˆãƒãƒˆ' },
    { name: 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·', crop: 'ãƒ‹ãƒ³ã‚¸ãƒ³' },
    { name: 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·', crop: 'ãƒãƒ†ãƒˆ' }
  ];
  let plantCount = 0;
  planters.forEach(planter => {
    const activeCount = activePlanters[planter.name] || 0;
    for (let i = 0; i < activeCount && money >= 10 && crops.length < landSize && plantCount < landSize; i++) {
      if (unlockedCrops.includes(planter.crop)) {
        money -= 10;
        const qualityScore = calculateQualityScore();
        crops.push({ type: planter.crop, growth: 0, maxGrowth: 15, qualityScore });
        planterUses[planter.name] = (planterUses[planter.name] || 0) + 1;
        addXP(1);
        plantCount++;
        checkAchievements();
      }
    }
  });
  updateUI();
}

// 6. ä½œç‰©ã¸ã®å“è³ªè¿½åŠ ï¼ˆplantCrop, autoPlantã®å¤‰æ›´ï¼‰
function plantCrop() {
  const select = document.getElementById('cropSelect');
  const type = select.value;
  if (!unlockedCrops.includes(type)) return;
  if (money >= 10 && crops.length < landSize) {
    money -= 10;
    const qualityScore = calculateQualityScore();
    crops.push({ type, growth: 0, maxGrowth: 15, qualityScore });
    addXP(1);
    updateUI();
  }
}

// 8. åç©«æ™‚ã®å“è³ªæ±ºå®š
function growCrops() {
  crops.forEach(c => {
    let growthRate = 1 + growthBonus;
    switch (currentWeather) {
      case 'æ›‡ã‚Š': growthRate -= 0.2; break;
      case 'è’¸ã—æš‘ã„': growthRate -= 0.1; break;
      case 'é›¨': growthRate += 0.3; break;
      case 'å¤§é›¨': growthRate += 0.5; break;
      case 'å°é¢¨': growthRate -= 0.5; break;
    }
    if (c.growth < c.maxGrowth) {
      c.growth = Math.min(10*(c.growth) + 10*(growthRate), 10*(c.maxGrowth));
      console.log(c.growth);
      c.growth *= 0.1;
      console.log(c.growth);
    }
  });
  const ready = crops.filter(c => c.growth >= c.maxGrowth);
  for (const c of ready) {
    const quality = c.qualityScore < 6.7 ? 'æ™®é€š' : c.qualityScore < 9.1 ? 'é«˜å“è³ª' : 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ';
    harvestBox[c.type] = harvestBox[c.type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
    harvestBox[c.type][quality] = (harvestBox[c.type][quality] || 0) + 1;
    harvestCounts[c.type] = (harvestCounts[c.type] || 0) + 1;
    checkAchievements();
  }
  crops = crops.filter(c => c.growth < c.maxGrowth);
}

// 11. æ–™ç†æ™‚ã®å“è³ªå‡¦ç†
function cook() {
  const type = document.getElementById('recipeSelect').value;
  const recipe = recipeData[type];
  if (!recipe || !unlockedRecipes.includes(type)) return;

  let canCook = Object.entries(recipe.ingredients).every(([crop, count]) =>
    Object.values(harvestBox[crop] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 }).reduce((sum, v) => sum + v, 0) >= count
  );

  if (canCook) {
    let minQualityScore = Infinity;
    for (const [crop, count] of Object.entries(recipe.ingredients)) {
      let remaining = count;
      for (const quality of ['ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ', 'é«˜å“è³ª', 'æ™®é€š']) {
        const available = harvestBox[crop]?.[quality] || 0;
        if (remaining > 0 && available > 0) {
          const used = Math.min(remaining, available);
          harvestBox[crop][quality] -= used;
          const score = quality === 'æ™®é€š' ? 4 : quality === 'é«˜å“è³ª' ? 7 : 9;
          minQualityScore = Math.min(minQualityScore, score);
          remaining -= used;
        }
      }
    }
    const quality = minQualityScore < 5 ? 'æ™®é€š' : minQualityScore < 8 ? 'é«˜å“è³ª' : 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ';
    dishInventory[type] = dishInventory[type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
    dishInventory[type][quality] = (dishInventory[type][quality] || 0) + 1;
    cookCounts[type] = (cookCounts[type] || 0) + 1;
    addXP(1);
    checkAchievements();
    updateUI();
  }
}

function putOnShelf(storeId) {
  const type = document.getElementById(`sellRecipeSelect-${storeId}`).value;
  const quality = document.getElementById(`qualitySelect-${storeId}`).value;
  const qualities = dishInventory[type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
  if (qualities[quality] > 0) {
    qualities[quality]--;
    shelves[storeId].push({ type, quality });
    addXP(1);
    onQualitySelection(type, quality, 'shelf'); // æ‹¡å¼µç”¨é–¢æ•°å‘¼ã³å‡ºã—
    updateUI();
  }
}

// 9. å£²ä¾¡ã¸ã®å½±éŸ¿ï¼ˆsellFromShelf, autoSellã®å¤‰æ›´ï¼‰
// 1. å•†å“æ£šã®ãƒ©ãƒ³ãƒ€ãƒ å–ã‚Šå‡ºã—ï¼ˆsellFromShelfã®å¤‰æ›´ï¼‰
function sellFromShelf() {
  Object.entries(shelves).forEach(([storeId, shelf]) => {
    if (shelf.length > 0 && Math.random() < getSellProbability()) {
      const index = Math.floor(Math.random() * shelf.length); // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      const sold = shelf.splice(index, 1)[0]; // ãƒ©ãƒ³ãƒ€ãƒ ã«å–ã‚Šå‡ºã—
      let price = recipeData[sold.type]?.sellPrice || 20;
      if (sold.quality === 'é«˜å“è³ª') price *= 1.5;
      if (sold.quality === 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ') price *= 2;
      money += price;
      totalRevenue += price;
      saleCounts[sold.type] = (saleCounts[sold.type] || 0) + 1;
      addXP(1);
      updateRP(-0.04);
      checkAchievements();
    }
  });
  updateUI();
}

function autoSell() {
  if (autoSellers > 0 && autoSellerActive && !isPaused) {
    if (ep >= autoSellers) {
      ep -= autoSellers;
      totalPowerConsumed += autoSellers;
      Object.entries(dishInventory).forEach(([type, qualities]) => {
        Object.entries(qualities).forEach(([quality, count]) => {
          if (count > 0 && Math.random() < (1 / (Math.random() * (90 - 60) + 60))) {
            qualities[quality]--;
            let price = recipeData[type]?.sellPrice || 20;
            if (quality === 'é«˜å“è³ª') price *= 1.5;
            if (quality === 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ') price *= 2;
            money += price;
            totalRevenue += price;
            saleCounts[type] = (saleCounts[type] || 0) + 1;
            addXP(1);
            checkAchievements();
          }
        });
      });
    } else {
      autoSellerActive = false;
      powerShortage = true;
      showSaveStatus('é›»åŠ›ä¸è¶³ã§è‡ªå‹•è²©å£²æ©ŸãŒåœæ­¢ã—ã¾ã—ãŸã€‚', false);
      updateTabNotifications();
    }
    updateUI();
  }
}

function updateQuests() {
  const questListElement = document.getElementById('questList');
  if (questListElement) {
    console.log(`Rendering questList, quests: ${JSON.stringify(quests)}`);
    const questList = quests
      .filter(quest => 
        quest.requirements && 
        Object.keys(quest.requirements).length > 0 && 
        Object.keys(quest.requirements).every(type => recipeData[type])
      )
      .map(quest => {
        const requirements = Object.entries(quest.requirements)
          .map(([type, count]) => `${type || 'ä¸æ˜'} x${count || 0}`)
          .join(', ');
        const firstType = Object.keys(quest.requirements)[0];
        const qualities = dishInventory[firstType] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
        const totalAvailable = (qualities.æ™®é€š || 0) + (qualities.é«˜å“è³ª || 0) + (qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  || 0);
        const canComplete = firstType && totalAvailable >= quest.requirements[firstType];
        const remainingSeconds = Math.max(0, Math.floor((quest.deadline - Date.now()) / 1000));
        return `
          <li>
            ${requirements} (${remainingSeconds}ç§’)
            ${canComplete ? '' : '<span>åœ¨åº«ä¸è¶³</span>'}
            <button onclick="completeQuest(${quest.id})" ${canComplete ? '' : 'disabled'}>ç´å“</button>
          </li>
        `;
      }).join('');
    questListElement.innerHTML = questList || '<li>ã‚¯ã‚¨ã‚¹ãƒˆãªã—</li>';
  }
}

// ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
function scheduleQuest() {
  if (!isPaused) {
    if (questTimer) {
      clearTimeout(questTimer);
      questTimer = null;
    }
    // ä¸æ­£ãªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    quests = quests.filter(quest => quest.requirements && Object.keys(quest.requirements).length > 0);
    console.log(`Cleaned quests: ${JSON.stringify(quests)}`);
    if (quests.length < MAX_QUESTS) {
      const quest = generateQuest();
      if (quest) {
        quests.push(quest);
        newQuestAvailable = true;
        console.log(`Quest added, current quests: ${JSON.stringify(quests)}`);
      } else {
        console.warn('Failed to generate quest');
      }
    }
    const interval = getQuestInterval();
    nextQuestTime = Date.now() + interval;
    questTimer = setTimeout(scheduleQuest, interval);
    questTimerStart = Date.now();
    console.log(`Next quest scheduled in ${interval / 1000} seconds`);
  }
  updateUI();
}

function generateQuest() {
  console.log(`generateQuest called, unlockedRecipes: ${JSON.stringify(unlockedRecipes)}, recipeData: ${JSON.stringify(recipeData)}`);
  if (!unlockedRecipes || unlockedRecipes.length === 0 || !recipeData) {
    console.warn('Cannot generate quest: unlockedRecipes or recipeData is empty');
    return null;
  }
  const types = Object.keys(recipeData).filter(type => unlockedRecipes.includes(type) && recipeData[type]);
  if (types.length === 0) {
    console.warn('No valid recipe types available for quest');
    return null;
  }
  const type = types[Math.floor(Math.random() * types.length)];
  const count = Math.floor(Math.random() * 3) + 1;
  const requirements = { [type]: count };
  const quest = {
    id: Date.now(),
    requirements,
    reward: count * (recipeData[type]?.rewardPerDish || 25),
    deadline: Date.now() + 10000
  };
  console.log(`Generated quest: ${JSON.stringify(quest)}`);
  return quest;
}

// 3. ã‚¯ã‚¨ã‚¹ãƒˆç´å“æ™‚ã®å“è³ªé¸æŠï¼ˆcompleteQuestã®è¿½åŠ /å¤‰æ›´ï¼‰
// 1. ã‚¯ã‚¨ã‚¹ãƒˆç´å“ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ ï¼‰
// ã‚¯ã‚¨ã‚¹ãƒˆç´å“ï¼ˆè‡ªå‹•å“è³ªé¸æŠï¼‰
// ã‚¯ã‚¨ã‚¹ãƒˆç´å“ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
// ã‚¯ã‚¨ã‚¹ãƒˆç´å“
function completeQuest(questId) {
  console.log(`completeQuest called with questId: ${questId}`);
  console.log(`Current quests: ${JSON.stringify(quests)}`);
  console.log(`Current dishInventory: ${JSON.stringify(dishInventory)}`);

  const quest = quests.find(q => q.id === questId);
  if (!quest) {
    console.error(`Quest not found for ID: ${questId}`);
    showSaveStatus('ã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', false);
    return;
  }

  // å¤ã„å½¢å¼ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤‰æ›
  let requirements = quest.requirements;
  if (!requirements && quest.recipeName && quest.dishNeed) {
    console.warn(`Converting legacy quest: ${JSON.stringify(quest)}`);
    requirements = { [quest.recipeName]: quest.dishNeed };
    quest.requirements = requirements;
  }

  if (!requirements || Object.keys(requirements).length === 0) {
    console.error(`Invalid quest requirements: ${JSON.stringify(requirements)}`);
    showSaveStatus('ç„¡åŠ¹ãªã‚¯ã‚¨ã‚¹ãƒˆã§ã™', false);
    quests = quests.filter(q => q.id !== questId);
    updateUI();
    return;
  }

  // åœ¨åº«ãƒã‚§ãƒƒã‚¯
  const canComplete = Object.entries(requirements).every(([type, count]) => {
    const qualities = dishInventory[type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
    const totalAvailable = (qualities.æ™®é€š || 0) + (qualities.é«˜å“è³ª || 0) + (qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  || 0);
    console.log(`Checking type: ${type}, required: ${count}, available: ${totalAvailable}`);
    return totalAvailable >= count;
  });

  if (!canComplete) {
    console.warn(`Cannot complete quest due to insufficient inventory`);
    showSaveStatus('ç´å“ã§ãã¾ã›ã‚“ï¼šåœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™', false);
    return;
  }

  // å“è³ªã‚’å„ªå…ˆé †ä½ã§æ¶ˆè²»
  Object.entries(requirements).forEach(([type, count]) => {
    const qualities = dishInventory[type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
    let remaining = count;
    
    console.log(`Consuming ${type}: required ${count}, before: ${JSON.stringify(qualities)}`);
    if (remaining > 0 && qualities.æ™®é€š > 0) {
      const used = Math.min(qualities.æ™®é€š, remaining);
      qualities.æ™®é€š -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, 'æ™®é€š', 'quest');
    }
    if (remaining > 0 && qualities.é«˜å“è³ª > 0) {
      const used = Math.min(qualities.é«˜å“è³ª, remaining);
      qualities.é«˜å“è³ª -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, 'é«˜å“è³ª', 'quest');
    }
    if (remaining > 0 && qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  > 0) {
      const used = Math.min(qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ , remaining);
      qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  -= used;
      remaining -= used;
      if (used > 0) onQualitySelection(type, 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ', 'quest');
    }
    console.log(`After consuming ${type}: ${JSON.stringify(qualities)}`);
  });

  money += quest.reward;
  addXP(10);
  questCompleteCounts[Object.keys(requirements)[0]] = (questCompleteCounts[Object.keys(requirements)[0]] || 0) + 1;
  totalQuestCompletes += 1;
  quests = quests.filter(q => q.id !== questId);
  console.log(`Quest ${questId} completed, new quests: ${JSON.stringify(quests)}`);
  updateUI();
  checkAchievements();
}

function buyLand() {
  const cost = 100 + landSize * 10;
  if (money >= cost) {
    money -= cost;
    totalCost += cost; // ç·æ”¯å‡ºã‚’æ›´æ–°
    landSize += 5;
    landExpansions += 1; // æ‹¡å¼µå›æ•°ã‚’å¢—åŠ 
    checkAchievements();
    updateUI();
    updateManagementDashboard();
  }
}

function buyTool(name) {
  if (xp < unlockThresholds[name]) return;
  const cost = name === 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·' ? 3000 :
               name === 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·' ? 4000 :
               name === 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·' ? 5000 :
               name === 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·' ? 7000 : 150;
  if (name.startsWith('ç¨®ã¾ãæ©Ÿ') && tools[name] >= landSize) return;
  if (money >= cost) {
    money -= cost;
    totalCost += cost; // ç·æ”¯å‡ºã‚’æ›´æ–°
    tools[name] = (tools[name] || 0) + 1;
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    if (!name.startsWith('ç¨®ã¾ãæ©Ÿ')) purchasedItems.add(name);
    if (name === 'ã‚¸ãƒ§ã‚¦ãƒ­') growthBonus = 1;
    checkAchievements();
    updatePlanterControls();
    updateUI();
  }
}

function buyPower() {
  if (xp < unlockThresholds['é›»åŠ›è³¼å…¥']) return;
  if (money >= 200) {
    money -= 200;
    totalCost += 200; // ç·æ”¯å‡ºã‚’æ›´æ–°
    ep += 100;
    shopPurchaseCounts['é›»åŠ›è³¼å…¥'] = (shopPurchaseCounts['é›»åŠ›è³¼å…¥'] || 0) + 1;
    checkAchievements();
    updateUI();
  }
}

function buyCrop(name) {
  if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
  const cost = name === 'ãƒ‹ãƒ³ã‚¸ãƒ³' ? 150 : name === 'ãƒãƒ†ãƒˆ' ? 300 : 100;
  if (money >= cost && !unlockedCrops.includes(name)) {
    money -= cost;
    totalCost += cost; // ç·æ”¯å‡ºã‚’æ›´æ–°
    unlockedCrops.push(name);
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    purchasedItems.add(name);
    checkAchievements();
    updateUI();
  }
}

function buyRecipe(name) {
  if (xp < unlockThresholds[name] || purchasedItems.has(name)) return;
  if (money >= 200 && !unlockedRecipes.includes(name)) {
    money -= 200;
    totalCost += 200; // ç·æ”¯å‡ºã‚’æ›´æ–°
    unlockedRecipes.push(name);
    shopPurchaseCounts[name] = (shopPurchaseCounts[name] || 0) + 1;
    purchasedItems.add(name);
    checkAchievements();
    updateUI();
  }
}

function updatePlanterControls() {
  const controls = document.getElementById('planterControls');
  const planters = [
    'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·',
    'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·',
    'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·',
    'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'
  ];
  controls.innerHTML = planters.map(name => {
    const owned = tools[name] || 0;
    if (owned === 0) return '';
    const options = Array.from({ length: owned + 1 }, (_, i) => i);
    return `
      <div style="margin-bottom: 10px;">
        <label>${name} ç¨¼åƒå°æ•°ï¼ˆæ‰€æŒ: ${owned}å°ï¼‰:</label>
        <select id="planter-${name}" onchange="updateActivePlanter('${name}')">
          ${options.map(i => `<option value="${i}" ${activePlanters[name] === i ? 'selected' : ''}>${i}å°</option>`).join('')}
        </select>
      </div>
    `;
  }).join('');
}

function updateActivePlanter(name) {
  const select = document.getElementById(`planter-${name}`);
  activePlanters[name] = parseInt(select.value);
  updateUI();
}

function updateTabNotifications() {
  const shopTab = document.getElementById('tab-shop');
  const questTab = document.getElementById('tab-quest');

  // å…¨åº—èˆ—ã®æ£šã«å•†å“ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const allShelvesHaveItems = Object.values(shelves).every(shelf => shelf.length > 0);
  shopTab.innerHTML = allShelvesHaveItems ? 'ğŸª è²©å£²' : 'ğŸª è²©å£²<span class="badge">âš ï¸</span>';
  
  if (newQuestAvailable && quests.length > 0) {
    questTab.innerHTML = 'ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ<span class="badge">ğŸ””</span>';
  } else {
    questTab.innerHTML = 'ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ';
  }
  console.log('Shelves status:', Object.fromEntries(Object.entries(shelves).map(([id, shelf]) => [id, shelf.length])), 'Notification:', !allShelvesHaveItems);
}

function updateUI() {
  document.getElementById('land').innerText = `åœŸåœ°æ‹¡å¼µï¼ˆ${100 + landSize * 10}Gï¼‰`;
  document.getElementById('money').textContent = money;
  document.getElementById('xp').textContent = xp;
  document.getElementById('rp').textContent = rp.toFixed(2);
  document.getElementById('ep').textContent = ep;
  document.getElementById('landSize').textContent = landSize;
  document.getElementById('cropCount').textContent = crops.length;

  document.getElementById('crops').innerHTML = crops.map(c => `<li>${c.type} - æˆé•·: ${Number(c.growth).toFixed(1)}/15</li>`).join('');

  const harvestList = Object.entries(harvestBox).map(([crop, qualities]) =>
    `<li>${crop}: æ™®é€š x${qualities.æ™®é€š || 0}, é«˜å“è³ª x${qualities.é«˜å“è³ª || 0}, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  x${qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  || 0}</li>`
  ).join('');
  document.getElementById('harvestBox').innerHTML = harvestList;
  document.getElementById('harvestBoxCook').innerHTML = harvestList;

  const cropSelect = document.getElementById('cropSelect');
  const selectedCrop = cropSelect.value;
  cropSelect.innerHTML = unlockedCrops.map(c => `<option value="${c}">${c}</option>`).join('');
  cropSelect.value = unlockedCrops.includes(selectedCrop) ? selectedCrop : unlockedCrops[0] || '';

  const recipeSelect = document.getElementById('recipeSelect');
  const selectedRecipe = recipeSelect.value;
  recipeSelect.innerHTML = unlockedRecipes.map(r => `<option value="${r}">${r}</option>`).join('');
  recipeSelect.value = selectedRecipe;

  const recipe = recipeData[selectedRecipe] || {ingredients: {}};
  const ingredients = Object.entries(recipe.ingredients).map(([k,v]) => `${k} x${v}`).join(', ');
  document.getElementById('ingredientInfo').innerText = `å¿…è¦ææ–™: ${ingredients}`;

  const dishList = Object.entries(dishInventory).map(([dish, qualities]) =>
    `<li>${dish}: æ™®é€š x${qualities.æ™®é€š || 0}, é«˜å“è³ª x${qualities.é«˜å“è³ª || 0}, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  x${qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  || 0}</li>`
  ).join('');
  document.getElementById('dishInventory').innerHTML = dishList;

  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  const shelfCountElement = document.getElementById(`shelfCount-${currentStoreId}`);
  const shelfListElement = document.getElementById(`shelfList-${currentStoreId}`);
  if (shelfListElement && shelves[currentStoreId]) {
    shelfListElement.innerHTML = shelves[currentStoreId].map(item => 
      `<li>${item.type} (${item.quality}, ${recipeData[item.type]?.sellPrice * (item.quality === 'é«˜å“è³ª' ? 1.5 : item.quality === 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ' ? 2 : 1)}G)</li>`
    ).join('');
  }

  // æ—¢å­˜ã® harvestList, dishList, shelfListElement ã¯å¤‰æ›´ãªã—
  document.getElementById('gameTime').textContent = `æ—¥ä»˜: ${gameTime.days}æ—¥ ${gameTime.hours}æ™‚ ${gameTime.minutes}åˆ†`;
  document.getElementById('currentWeather').textContent = `å¤©å€™: ${currentWeather}`;
  // æ—¢å­˜ã® harvestList, dishList, shelfListElement ã®å‡¦ç†ã¯ãã®ã¾ã¾

  // æ£šã®å“è³ªé¸æŠ
// æ£šã®å“è³ªé¸æŠï¼ˆé¸æŠçŠ¶æ…‹ã‚’ä¿æŒï¼‰
  Object.keys(shelves).forEach(storeId => {
    const qualitySelect = document.getElementById(`qualitySelect-${storeId}`);
    if (qualitySelect) {
      const type = document.getElementById(`sellRecipeSelect-${storeId}`).value;
      const qualities = dishInventory[type] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
      const currentQuality = selectedQualities[storeId] || qualitySelect.value || 'æ™®é€š';
      
      // åœ¨åº«ãŒã‚ã‚‹å“è³ªã®ã¿è¡¨ç¤º
      const qualityOptions = Object.keys(qualities)
        .filter(q => qualities[q] > 0)
        .map(q => `<option value="${q}" ${q === currentQuality ? 'selected' : ''}>${q}</option>`)
        .join('') || '<option value="">é¸æŠä¸å¯</option>';
      
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰
      if (qualitySelect.innerHTML !== qualityOptions) {
        qualitySelect.innerHTML = qualityOptions;
      }
      
      // é¸æŠå€¤ã‚’ä¿æŒ
      if (qualitySelect.value) {
        selectedQualities[storeId] = qualitySelect.value;
      }
      
      // onchange ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆåˆå›ã®ã¿ï¼‰
      if (!qualitySelect.dataset.listenerAdded) {
        qualitySelect.addEventListener('change', () => {
          selectedQualities[storeId] = qualitySelect.value;
          console.log(`Quality selected for store ${storeId}: ${qualitySelect.value}`);
        });
        qualitySelect.dataset.listenerAdded = 'true';
      }
    }
  });
  
  // ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºï¼ˆå“è³ªé¸æŠã‚’å‰Šé™¤ï¼‰
  // ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤º
  const questListElement = document.getElementById('questList');
  if (questListElement) {
    console.log(`Rendering questList, quests:`, JSON.stringify(quests));
    const questList = quests
      .filter(quest => quest.requirements && Object.keys(quest.requirements).length > 0)
      .map(quest => {
        const requirements = Object.entries(quest.requirements)
          .map(([type, count]) => `${type} x${count}`)
          .join(', ');
        const firstType = Object.keys(quest.requirements)[0];
        const qualities = dishInventory[firstType] || { æ™®é€š: 0, é«˜å“è³ª: 0, ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : 0 };
        const totalAvailable = (qualities.æ™®é€š || 0) + (qualities.é«˜å“è³ª || 0) + (qualities.ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  || 0);
        const canComplete = totalAvailable >= quest.requirements[firstType];
        return `
          <li>
            ${requirements} (${Math.max(0, Math.floor((quest.deadline - Date.now()) / 1000))}ç§’)
            ${canComplete ? '' : '<span>åœ¨åº«ä¸è¶³</span>'}
            <button onclick="completeQuest(${quest.id})" ${canComplete ? '' : 'disabled'}>ç´å“</button>
          </li>
        `;
      }).join('');
    questListElement.innerHTML = questList || '<li>ã‚¯ã‚¨ã‚¹ãƒˆãªã—</li>';
  }
  
  // æ£šã®è¡¨ç¤º
  if (shelfListElement && shelves[currentStoreId]) {
    shelfListElement.innerHTML = shelves[currentStoreId].map(item => 
      `<li>${item.type} (${item.quality}, ${recipeData[item.type]?.sellPrice * (item.quality === 'é«˜å“è³ª' ? 1.5 : item.quality === 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ' ? 2 : 1)}G)</li>`
    ).join('');
  }

  checkUnlocks();
  checkGameOver();
  updateTabNotifications();
  updateManagementDashboard();
}


function showSaveStatus(message, isSuccess) {
  const statusDiv = document.getElementById('saveStatus');
  statusDiv.textContent = message;
  statusDiv.className = isSuccess ? 'success' : 'error';
  statusDiv.style.display = 'block';
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 3000);
}

function saveGame() {
  try {
    const data = {
      version: version,
      money,
      xp,
      rp,
      ep,
      landSize,
      crops: crops.filter(c => unlockedCrops.includes(c.type)),
      harvestBox: Object.fromEntries(
        Object.entries(harvestBox || {}).filter(([k]) => unlockedCrops.includes(k))
      ),
      dishInventory,
      shelves,
      quests,
      tools,
      activePlanters,
      unlockedCrops,
      unlockedRecipes,
      seasonings,
      advancedInventory,
      growthBonus,
      currentAdvancedRecipe,
      currentAdvancedSteps,
      autoSaveEnabled,
      autoSaveInterval,
      autoLoadEnabled,
      purchasedItems: Array.from(purchasedItems),
      lastPowerConsumption,
      pauseDuration, // è¿½åŠ 
      nextQuestTime, // è¿½åŠ 
      achievements,
      isPaused,
      currentSubTab,
      currentStoreId,
      storeCount,
      autoSellers,
      autoSellerActive,
      harvestCounts,
      cookCounts,
      saleCounts,
      questCompleteCounts,
      totalQuestCompletes,
      planterUses,
      shopPurchaseCounts,
      totalPowerConsumed,
      totalRevenue,
      totalCost,
      landExpansions,
      sellIntervalReduction,
      campaignEndTime,
      powerShortage,
      gameTime,
      currentWeather,
      previousWeather,
      weatherHistory,
      currentSeason,
      lastWeatherUpdate,
      selectedQualities // æ–°ã—ãè¿½åŠ 
    };
    localStorage.setItem('farmingGameSave', JSON.stringify(data));
    showSaveStatus('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
  } catch (error) {
    showSaveStatus('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
  }
}

function loadGame() {
  try {
    const save = localStorage.getItem('farmingGameSave');
    if (save) {
      const data = JSON.parse(save);
      if (data.version !== version) {
        console.warn(`Version mismatch: saved ${data.version}, current ${version}`);
      }
      money = data.money || 100;
      xp = data.xp || 0;
      rp = data.rp !== undefined ? data.rp : 5.0;
      ep = data.ep || 0;
      landSize = data.landSize || 5;
      crops = (data.crops || []).filter(c => ['ã‚­ãƒ£ãƒ™ãƒ„', 'ãƒˆãƒãƒˆ', 'ãƒ‹ãƒ³ã‚¸ãƒ³', 'ãƒãƒ†ãƒˆ'].includes(c.type));
      harvestBox = Object.fromEntries(
        Object.entries(data.harvestBox || {}).filter(([k]) => ['ã‚­ãƒ£ãƒ™ãƒ„', 'ãƒˆãƒãƒˆ', 'ãƒ‹ãƒ³ã‚¸ãƒ³', 'ãƒãƒ†ãƒˆ'].includes(k))
      );
      unlockedCrops = (data.unlockedCrops || ['ã‚­ãƒ£ãƒ™ãƒ„']).filter(c => ['ã‚­ãƒ£ãƒ™ãƒ„', 'ãƒˆãƒãƒˆ', 'ãƒ‹ãƒ³ã‚¸ãƒ³', 'ãƒãƒ†ãƒˆ'].includes(c));
      dishInventory = Object.fromEntries(
        Object.entries(data.dishInventory || {}).map(([k, v]) => [
          k === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : k === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : k === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : k,
          v
        ])
      );
      shelves = data.shelves || { '0': [] };
      storeCount = data.storeCount || 1;
      currentStoreId = (data.currentStoreId && shelves[data.currentStoreId]) ? data.currentStoreId : '0';
      autoSellers = data.autoSellers || 0;
      autoSellerActive = data.autoSellerActive !== undefined ? data.autoSellerActive : true;
      // ã‚¯ã‚¨ã‚¹ãƒˆã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›
      quests = (data.quests || []).map(q => {
        const requirements = q.requirements || (q.recipeName && q.dishNeed ? { 
          [q.recipeName === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : 
           q.recipeName === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : 
           q.recipeName === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : q.recipeName]: q.dishNeed 
        } : null);
        if (!requirements || Object.keys(requirements).length === 0) {
          console.warn(`Invalid quest in save data: ${JSON.stringify(q)}`);
          return null;
        }
        return {
          id: q.id,
          requirements,
          reward: q.reward || Object.values(requirements)[0] * (recipeData[Object.keys(requirements)[0]]?.rewardPerDish || 25),
          deadline: q.deadline + (data.pauseDuration || 0)
        };
      }).filter(q => q !== null);
      tools = {
        'ã‚¸ãƒ§ã‚¦ãƒ­': data.tools?.['ã‚¸ãƒ§ã‚¦ãƒ­'] || 0,
        'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': data.tools?.['ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·'] || data.tools?.['è‡ªå‹•æ’­ç¨®æ©Ÿ'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': data.tools?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || 0
      };
      activePlanters = {
        'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·'] || data.activePlanters?.['è‡ªå‹•æ’­ç¨®æ©Ÿ'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·'] || 0,
        'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': data.activePlanters?.['ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·'] || 0
      };
      unlockedRecipes = (data.unlockedRecipes || ['ç„¼ãã‚­ãƒ£ãƒ™ãƒ„']).map(r =>
        r === 'ç„¼ãé‡èœ' ? 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„' : r === 'ã‚µãƒ©ãƒ€' ? 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€' : r === 'ã‚¹ãƒ¼ãƒ—' ? 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³' : r
      );
      seasonings = data.seasonings || {};
      advancedInventory = data.advancedInventory || [];
      growthBonus = data.growthBonus || 0;
      currentAdvancedRecipe = data.currentAdvancedRecipe || null;
      currentAdvancedSteps = data.currentAdvancedSteps || [];
      autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
      autoSaveInterval = data.autoSaveInterval || 10000;
      autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : true;
      purchasedItems = new Set(
        (data.purchasedItems || []).map(item =>
          item === 'è‡ªå‹•æ’­ç¨®æ©Ÿ' ? 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·' : item
        )
      );
      lastPowerConsumption = data.lastPowerConsumption || Date.now();
      pauseDuration = data.pauseDuration || 0;
      nextQuestTime = data.nextQuestTime || null;
      currentSubTab = data.currentSubTab || 'farming';
      harvestCounts = data.harvestCounts || { 'ã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
      cookCounts = data.cookCounts || { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
      saleCounts = data.saleCounts || { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
      questCompleteCounts = data.questCompleteCounts || { 'ç„¼ãã‚­ãƒ£ãƒ™ãƒ„': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0 };
      totalQuestCompletes = data.totalQuestCompletes || 0;
      planterUses = data.planterUses || { 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0 };
      shopPurchaseCounts = data.shopPurchaseCounts || { 'ã‚¸ãƒ§ã‚¦ãƒ­': 0, 'ç¨®ã¾ãæ©Ÿã‚­ãƒ£ãƒ™ãƒ„å·': 0, 'ç¨®ã¾ãæ©Ÿãƒˆãƒãƒˆå·': 0, 'ç¨®ã¾ãæ©Ÿãƒ‹ãƒ³ã‚¸ãƒ³å·': 0, 'ç¨®ã¾ãæ©Ÿãƒãƒ†ãƒˆå·': 0, 'é›»åŠ›è³¼å…¥': 0, 'ãƒˆãƒãƒˆ': 0, 'ãƒˆãƒãƒˆã‚µãƒ©ãƒ€': 0, 'ãƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ç„¼ããƒ‹ãƒ³ã‚¸ãƒ³': 0, 'ãƒãƒ†ãƒˆ': 0 };
      totalPowerConsumed = data.totalPowerConsumed || 0;
      totalRevenue = data.totalRevenue || 0;
      totalCost = data.totalCost || 0;
      landExpansions = data.landExpansions || 0;
      sellIntervalReduction = data.sellIntervalReduction || 1;
      campaignEndTime = data.campaignEndTime || 0;
      powerShortage = data.powerShortage || false;
      achievements = data.achievements || achievements.map(a => ({ ...a, achieved: false, claimed: false }));
      newAchievementAvailable = achievements.some(a => a.achieved && !a.claimed);
      isPaused = data.isPaused || false;
      document.getElementById('pauseModal').style.display = isPaused ? 'flex' : 'none';
      document.getElementById('pauseButton').textContent = isPaused ? 'â–¶' : 'â¸';
      gameTime = data.gameTime || { days: 0, hours: 0, minutes: 0 };
      currentWeather = data.currentWeather || 'æ™´ã‚Œ';
      previousWeather = data.previousWeather || null;
      weatherHistory = data.weatherHistory || [];
      currentSeason = data.currentSeason || 'æ˜¥';
      lastWeatherUpdate = data.lastWeatherUpdate || Date.now();
      if (questTimer) {
        clearTimeout(questTimer);
        questTimer = null;
      }
      if (!isPaused && nextQuestTime) {
        const remainingTime = Math.max(0, nextQuestTime - Date.now());
        console.log(`Next quest in ${remainingTime / 1000} seconds`);
        questTimer = setTimeout(scheduleQuest, remainingTime);
        questTimerStart = Date.now();
      } else if (!isPaused) {
        scheduleQuest();
      }
      updateSettingsUI();
      updateAchievementList();
      updateUI();
      updateQuests();
      updatePlanterControls();
      updateShopSubTabs();
      showSaveStatus('ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', true);
    } else {
      showSaveStatus('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', false);
      if (!isPaused) {
        scheduleQuest();
      }
    }
  } catch (error) {
    console.error(`loadGame error: ${error}`);
    showSaveStatus('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, false);
  }
}

function updateSettingsUI() {
  document.getElementById('autoSaveEnabled').checked = autoSaveEnabled;
  document.getElementById('autoSaveInterval').value = autoSaveInterval / 1000;
  document.getElementById('autoLoadEnabled').checked = autoLoadEnabled;
}

function toggleAutoSave() {
  autoSaveEnabled = document.getElementById('autoSaveEnabled').checked;
  startAutoSave();
  saveSettings();
}

function updateAutoSaveInterval() {
  const input = document.getElementById('autoSaveInterval');
  let value = parseInt(input.value) * 1000;
  if (value < 5000) {
    value = 5000;
    input.value = 5;
  }
  autoSaveInterval = value;
  startAutoSave();
  saveSettings();
}

function saveSettings() {
  try {
    const data = {
      autoSaveEnabled,
      autoSaveInterval,
      autoLoadEnabled
    };
    localStorage.setItem('farmingGameSettings', JSON.stringify(data));
    showSaveStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
  } catch (error) {
    showSaveStatus('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
  }
}

function loadSettings() {
  try {
    const settings = localStorage.getItem('farmingGameSettings');
    if (settings) {
      const data = JSON.parse(settings);
      autoSaveEnabled = data.autoSaveEnabled !== undefined ? data.autoSaveEnabled : true;
      autoSaveInterval = data.autoSaveInterval || 10000;
      autoLoadEnabled = data.autoLoadEnabled !== undefined ? data.autoLoadEnabled : true;
    }
  } catch (error) {
    console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
  }
}

function startAutoSave() {
  if (autoSaveTimer) {
    clearInterval(autoSaveTimer);
    autoSaveTimer = null;
  }
  if (autoSaveEnabled) {
    autoSaveTimer = setInterval(saveGame, autoSaveInterval);
  }
}

loadSettings();
updateSettingsUI();
startAutoSave();
if (autoLoadEnabled) {
  loadGame();
}

updateUI();

setInterval(() => {
  if (!isPaused) {
    growCrops();
    checkQuestDeadlines();
    checkGameOver();
    consumePower();
Object.entries(shelves).forEach(([storeId, shelf]) => {
  if (shelf.length === 0) {
    updateRP(0.1);
  }
});
    autoPlant();
    if (campaignEndTime <= Date.now() && sellIntervalReduction < 1) {
      sellIntervalReduction = 1;
      showSaveStatus('åºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', true);
    }
  }
}, 1000);

setInterval(() => {
  updateGameTime();
  updateUI();
}, 250);

setInterval(() => {
    if (!isPaused) {
      sellFromShelf();
      autoSell();
    }
}, 1000 * sellIntervalReduction); // åºƒå‘Šã«ã‚ˆã‚‹é–“éš”çŸ­ç¸®ã‚’åæ˜ 
</script>
</body>
</html>
